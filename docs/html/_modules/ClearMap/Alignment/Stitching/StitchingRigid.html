
<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>ClearMap.Alignment.Stitching.StitchingRigid &#8212; ClearMap 2.0.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/clearmap.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/clearmap_utils.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/clearmap_sidebar.css" />
    
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <script src="https://platform.twitter.com/widgets.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/clearmap.js"></script>
    <script src="../../../../_static/clearmap_sidebar.js"></script>
    <script src="../../../../_static/clearmap_togglebutton.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <!--[if lt IE 9]>
  <script src="_static/css3-mediaqueries.js"></script>
  <![endif]-->

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'/>
   

  </head><body>
<div class="document">
 <div class="imagecontainer">
  <a href="../../../../home.html"><img src="../../../../_static/ClearMap_banner.jpg" height=150px width=150% border="0" alt="ClearMap"/></a>
  <div class="top-left">
    <p style="font-size: 30px"> 
       <a href="../../../../home.html" style="color: #ffffff; font-weight: bold"> ClearMap Documentation </a>
    </p>
  </div>
  <div class="top-right">
    <ul class="link-list">
     <li class="link-list"><a href="../../../../home.html">Home</a></li>
     <li class="link-list"><a href="../../../../overview.html">Overview</a></li>    
     <li class="link-list"><a href="../../../../installation.html">Installation</a></li>
     <li class="link-list"><a href="https://github.com/ChristophKirst/ClearMap2"> <img src="../../../../_static/GitHub-Mark.png" height=16px alt="Github"/> Source</a>
    </ul>
  </div>
  <div class="bottom-right">
    <a href="https://twitter.com/clearmap_idisco?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @clearmap_idisco</a>
      <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>  </a>
  </div>
 </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
       <li><a href="../../../../home.html">Home</a>|&nbsp;</li>
       <li><a href="../../../../overview.html">Overview</a>|&nbsp;</li>      
       <li><a href="../../../../search.html">Search</a>|&nbsp;</li>
       <li><a href="../../../../index.html">Documentation </a> |&nbsp;</li>
       <li><a href="../../../../index.html#clearmap-api">API </a> &raquo;</li>     

          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
<div class="document">
    
    <div class="documentwrapper">
    
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="../../../../index.html">ClearMap</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../functionality.html">Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../wobblystitcher.html">WobblyStitcher</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cellmap.html">CellMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../CellMap.html">CellMap Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tubemap.html">TubeMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../TubeMap.html">TubeMap Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../media.html">News and Media</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">ClearMap</a></li>
</ul>
 

<h3>Questions? Suggestions?</h3>
<p>Open an issue at the
  <a href="https://github.com/ChristophKirst/ClearMap2/issues">tracker</a>.</p>
  

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
    <div class="sphinxsidebar_right" role="navigation" aria-label="right navigation">
      <div class="sphinxsidebarwrapper_right">
        <h3> <a href="../../../../cellmap.html">CellMap Pipeline</a></h3>
          <a href="../../../../cellmap.html">
            <img src="../../../../_static/CellMap_small_fast.gif" width=250px height=140px alt="CellMap"/></a>
        <h3> <a href="../../../../tubemap.html">Tubemap Pipeline</a></h3>
          <a href="../../../../tubemap.html">
            <img src="../../../../_static/TubeMap_raw_movie_small.gif" width=250px height=140px alt="TubeMap"/></a>
        <h3> <a href="../../../../media.html#gallery"> Gallery</a></h3>
          <a href="../../../../media.html#gallery">
            <img src="../../../../_static/TubeMap_graph_movie_small.gif" width=250px height=140px alt="Gallery"/></a> 
        <h3> <a href="../../../../media.html#videos">Social Media and Videos</a></h3>
          <a href="../../../../media.html#videos">   
            <img src="../../../../_static/TEDx.png" width=250px height=70px alt="Videos"/></a>  
      </div>
    </div>
      <!-- sidebar2 --> 
    
    
    <div class="bodywrapper">       
    <div class="body" role="main">
          
  <h1>Source code for ClearMap.Alignment.Stitching.StitchingRigid</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">StitchingRigid</span>
<span class="sd">==============</span>

<span class="sd">Stitching module for aligning and stitching data sets ridgidly.</span>

<span class="sd">The module provides base classes and routines for stitching images. The</span>
<span class="sd">:mod:`~ClearMap.Alignment.Stitching.StichingWobbly` module builds on this </span>
<span class="sd">module.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__author__</span>    <span class="o">=</span> <span class="s1">&#39;Christoph Kirst &lt;christoph.kirst.ck@gmail.com&gt;&#39;</span>
<span class="n">__license__</span>   <span class="o">=</span> <span class="s1">&#39;GPLv3 - GNU General Pulic License v3 (see LICENSE)&#39;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s1">&#39;Copyright Â© 2020 by Christoph Kirst&#39;</span>
<span class="n">__webpage__</span>   <span class="o">=</span> <span class="s1">&#39;http://idisco.info&#39;</span>
<span class="n">__download__</span>  <span class="o">=</span> <span class="s1">&#39;http://www.github.com/ChristophKirst/ClearMap2&#39;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">itt</span>
<span class="kn">import</span> <span class="nn">functools</span> <span class="k">as</span> <span class="nn">ft</span>
<span class="kn">import</span> <span class="nn">inspect</span> <span class="k">as</span> <span class="nn">insp</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>
 
<span class="kn">import</span> <span class="nn">graph_tool</span> <span class="k">as</span> <span class="nn">gt</span>
<span class="kn">import</span> <span class="nn">graph_tool.topology</span> <span class="k">as</span> <span class="nn">gtt</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>


<span class="kn">import</span> <span class="nn">ClearMap.IO.IO</span> <span class="k">as</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">ClearMap.IO.Source</span> <span class="k">as</span> <span class="nn">src</span>
<span class="kn">import</span> <span class="nn">ClearMap.IO.Slice</span> <span class="k">as</span> <span class="nn">slc</span>
<span class="kn">import</span> <span class="nn">ClearMap.IO.FileList</span> <span class="k">as</span> <span class="nn">fl</span>

<span class="kn">import</span> <span class="nn">ClearMap.ParallelProcessing.ParallelTraceback</span> <span class="k">as</span> <span class="nn">ptb</span>

<span class="kn">import</span> <span class="nn">ClearMap.Visualization.Plot3d</span> <span class="k">as</span> <span class="nn">p3d</span>
<span class="kn">import</span> <span class="nn">ClearMap.Visualization.Color</span> <span class="k">as</span> <span class="nn">col</span>

<span class="kn">import</span> <span class="nn">ClearMap.Utils.TagExpression</span> <span class="k">as</span> <span class="nn">te</span>
<span class="kn">import</span> <span class="nn">ClearMap.Utils.Timer</span> <span class="k">as</span> <span class="nn">tmr</span>

<span class="kn">from</span> <span class="nn">ClearMap.Utils.Formatting</span> <span class="kn">import</span> <span class="n">ensure</span>


<span class="c1">###############################################################################</span>
<span class="c1">### Geometry</span>
<span class="c1">###############################################################################</span>


<div class="viewcode-block" id="Region"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Region">[docs]</a><span class="k">class</span> <span class="nc">Region</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class to handle rectangular regions storing positional information.&quot;&quot;&quot;</span>
  
  <span class="c1">#__slots__ = (&#39;_position&#39;, &#39;_shape&#39;);  </span>
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lower</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Region construtor.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    lower, upper: tuples of int</span>
<span class="sd">      The corners of the rectangular region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lower</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">position</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span> 
    <span class="k">if</span> <span class="n">upper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">l</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span><span class="n">position</span><span class="p">));</span>
   
    <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span>    <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The position of the region.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    position : tuple of ints</span>
<span class="sd">      The position of the region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">;</span>
    
  <span class="nd">@position</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The shape of the region.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    shape : tuple of int</span>
<span class="sd">      The shape of the layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">;</span>
    
  <span class="nd">@shape</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
  
  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The lower corner of the source&#39;s placement.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lower : array of int</span>
<span class="sd">      The coordinates of the lower corner of the source&#39;s placment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
    
  <span class="nd">@lower</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
  
  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">upper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The upper corner of the source&#39;s placement.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    upper : array of int</span>
<span class="sd">      The coordinates of the upper corner of the source&#39;s placment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">s</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">));</span>
    
  <span class="nd">@upper</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">upper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">upper</span><span class="p">):</span>
    <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">p</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span> <span class="n">position</span><span class="p">));</span>

  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">extent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The difference between upper and lower corner.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    extent : tuple of int</span>
<span class="sd">      The difference between upper and lower corner.</span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The extent can differ from the shape in case the source is bended or wobbly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">u</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">));</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The origin of this region, i.e. its positively rectified position.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    origin : tuple of ints</span>
<span class="sd">      The rectified position, i.e. coordiantes below zero are set to zero.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">);</span>
    
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The dimension of the source.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndim : int</span>
<span class="sd">      The dimension of the source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">);</span>
  
  
<div class="viewcode-block" id="Region.position_to_local"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Region.position_to_local">[docs]</a>  <span class="k">def</span> <span class="nf">position_to_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a position to the a local position wrt to the sources origin.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    position : tuple of ints</span>
<span class="sd">      The non-local position.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    loacl_position : tuple of ints</span>
<span class="sd">      The local position within this region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">q</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">));</span></div>
    
  
<div class="viewcode-block" id="Region.position_from_local"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Region.position_from_local">[docs]</a>  <span class="k">def</span> <span class="nf">position_from_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_position</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a position given in local coordiantes to the non-local position.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    local_position : tuple of ints</span>
<span class="sd">      The local position within the region.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    position : tuple of ints</span>
<span class="sd">      The non-local position.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">q</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">local_position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">));</span></div>

  
<div class="viewcode-block" id="Region.coordinate_to_local"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Region.coordinate_to_local">[docs]</a>  <span class="k">def</span> <span class="nf">coordinate_to_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a coordinate along an axis to the a local coordinate.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    coordinate : int</span>
<span class="sd">      The non-local coordinate along the axis.</span>
<span class="sd">    axis : int</span>
<span class="sd">      The axis of the coordiante.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    loacl_coordinate : tuple of ints, or int</span>
<span class="sd">      The local coordinate within this region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">coordinate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="p">];</span></div>
    
  
<div class="viewcode-block" id="Region.coordinate_from_local"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Region.coordinate_from_local">[docs]</a>  <span class="k">def</span> <span class="nf">coordinate_from_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loacl_coordinate</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a local coordainte along an axis to the non-local coordinate.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    local_coordinate : int</span>
<span class="sd">      The local coordinate along the axis.</span>
<span class="sd">    axis : int</span>
<span class="sd">      The axis of the coordiante.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coordinate : int</span>
<span class="sd">      The non-local coordainte.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">loacl_coordinate</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="p">];</span></div>
  
  
<div class="viewcode-block" id="Region.local_slicing"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Region.local_slicing">[docs]</a>  <span class="k">def</span> <span class="nf">local_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the slice of this region in a source or from a position.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    source : Source class</span>
<span class="sd">      Source at which this region should be sliced.</span>
<span class="sd">    position : tuple of ints</span>
<span class="sd">      Position of the lower corner of the sink.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slice : list of slice objects</span>
<span class="sd">      The slice specifications for this region in a source.</span>
<span class="sd">      </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This routine assumes that the region is within the source. </span>
<span class="sd">    No boundary checks are performed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">position</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">;</span> 
    <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
      <span class="c1">#raise ValueError(&#39;Either the source or position argument must be given!&#39;)</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">l</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span> <span class="n">u</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">u</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">position</span><span class="p">));</span></div>
  
  
<div class="viewcode-block" id="Region.copy"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Region.copy">[docs]</a>  <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">);</span></div>
  
  
  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">;</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="n">lower</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">;</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="n">upper</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
    
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Region[</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
  
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">();</span> </div>



<div class="viewcode-block" id="Overlap"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Overlap">[docs]</a><span class="k">class</span> <span class="nc">Overlap</span><span class="p">(</span><span class="n">Region</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class to handle overlapping regions of aligned sources.&quot;&quot;&quot;</span>
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lower</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Overlap construtor.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    lower, upper: tuples of int</span>
<span class="sd">      The corners of the rectangular region.</span>
<span class="sd">    sources : list of Source classes</span>
<span class="sd">      The sources that contribute to this region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">Overlap</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">upper</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">sources</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">sources</span> <span class="o">=</span> <span class="p">();</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
  
  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The sources that contribute to this overlap region.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sources : list of Source classes</span>
<span class="sd">      The sources that contribute to this region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">;</span>
    
  <span class="nd">@sources</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
  
    
<div class="viewcode-block" id="Overlap.source_slicings"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Overlap.source_slicings">[docs]</a>  <span class="k">def</span> <span class="nf">source_slicings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the slices of this overlap region of the contributing sources.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slices : list of list of slice objects</span>
<span class="sd">      The slice specifications for the sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_slicing</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">];</span></div>
  
  
<div class="viewcode-block" id="Overlap.source_arrays"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Overlap.source_arrays">[docs]</a>  <span class="k">def</span> <span class="nf">source_arrays</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the data arrays of the sources in this region </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    arrays : list of arrays</span>
<span class="sd">      The arrays of all the sources that overlap in this region.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">sl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_slicings</span><span class="p">())];</span></div>
  
  
<div class="viewcode-block" id="Overlap.plot"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Overlap.plot">[docs]</a>  <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots the overlap region.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plot : DataViewer</span>
<span class="sd">      The plot of the overlap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_arrays</span><span class="p">());</span></div>
  
  <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">new</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)();</span>
    <span class="n">new</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">);</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">new</span><span class="p">;</span>
  
  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">;</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="n">lower</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
    
    <span class="k">try</span><span class="p">:</span>
      <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">;</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="n">upper</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
      
    <span class="k">try</span><span class="p">:</span>
      <span class="n">n_sources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">);</span>
    <span class="k">except</span><span class="p">:</span>
      <span class="n">n_sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
    
    <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Overlap[</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">]&lt;</span><span class="si">%r</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">n_sources</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">;</span></div>



<span class="c1">########################################################################################</span>
<span class="c1">### Sources</span>
<span class="c1">########################################################################################</span>

<div class="viewcode-block" id="SourceRegion"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.SourceRegion">[docs]</a><span class="k">class</span> <span class="nc">SourceRegion</span><span class="p">(</span><span class="n">Region</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class to signal a Source with a region.</span>
<span class="sd">  </span>
<span class="sd">  Note</span>
<span class="sd">  ----</span>
<span class="sd">  This class serves as a base class to identify all sources with positional </span>
<span class="sd">  information.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">pass</span></div>


<div class="viewcode-block" id="Source"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Source">[docs]</a><span class="k">class</span> <span class="nc">Source</span><span class="p">(</span><span class="n">SourceRegion</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">AbstractSource</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class to handle basic data sources in a layout for stitching.&quot;&quot;&quot;</span>
  
  <span class="c1">#__slots__ = (&#39;_position&#39;, &#39;_shape&#39;, &#39;_dtype&#39;, &#39;_order&#39;, &#39;_location&#39;)</span>
  
  <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="sd">&quot;&quot;&quot;Counter for the sources used to create unique ids.&quot;&quot;&quot;</span> 
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Source class construtor.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    source: string, array or Source class</span>
<span class="sd">      The data source.</span>
<span class="sd">    position : tuple of int or None</span>
<span class="sd">      The position of the source&#39;s &#39;lower&#39; corner in the layout.</span>
<span class="sd">    tile_position : array or None</span>
<span class="sd">      Optional position of this source in a tiling grid. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">source</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">as_source</span><span class="p">(</span><span class="n">source</span><span class="p">);</span>
      <span class="n">sid</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>                           
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
      <span class="n">position</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">position</span> <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">position</span><span class="p">;</span>
      <span class="n">tile_position</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">tile_position</span> <span class="k">if</span> <span class="n">tile_position</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">tile_position</span><span class="p">;</span>
      <span class="n">sid</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">id</span><span class="p">;</span>
      <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">source</span><span class="p">;</span>

    <span class="n">shape</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span> 
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot initilaize source without a shape!&#39;</span><span class="p">);</span>    
    
    <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">);</span>
    
    <span class="n">SourceRegion</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">);</span>

    <span class="n">src</span><span class="o">.</span><span class="n">AbstractSource</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">);</span>   
    <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">_tile_position</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">tile_position</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="n">sid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>                              
      <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">Source</span><span class="o">.</span><span class="n">counter</span><span class="p">;</span>
      <span class="n">Source</span><span class="o">.</span><span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">sid</span><span class="p">;</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
    <span class="k">return</span> <span class="s1">&#39;Stitchable-&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="p">;</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The source id.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    id : int</span>
<span class="sd">      The id of the source.</span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Parallel processing changes pointers, this id can be used to identify the same source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">;</span>
    
  <span class="nd">@id</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="nb">id</span><span class="p">;</span>
  
    
  <span class="c1">#def __eq__(self, other):</span>
  <span class="c1">#  if isinstance(other, Source):</span>
  <span class="c1">#    return self.id == other.id;</span>
  <span class="c1">#  else:</span>
  <span class="c1">#    return False;</span>
  <span class="c1">#</span>
  <span class="c1">#def __hash__(self):</span>
  <span class="c1">#  return id(self);</span>
  
    
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The underlying IO source.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="p">;</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">tile_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Optional position on a grid.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tile_position : tuple of int</span>
<span class="sd">      The tile position of this source on a grid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tile_position</span><span class="p">;</span>
 
  <span class="nd">@tile_position</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">tile_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_position</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tile_position</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">tile_position</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_position</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">identifier</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">identifier</span><span class="p">;</span>
  
  
<div class="viewcode-block" id="Source.slice_along_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Source.slice_along_axis">[docs]</a>  <span class="k">def</span> <span class="nf">slice_along_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">local_coordinate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Slice this source at a coordinate along an axis.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    coordinate : int</span>
<span class="sd">      The coordinate at which to take the slice.</span>
<span class="sd">    local_coordinate : int</span>
<span class="sd">      The local coordinate in the underlying source along the slice axis.</span>
<span class="sd">    axis : int</span>
<span class="sd">      The axis to take the slice in.</span>
<span class="sd">      </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    source : SlicedSource class</span>
<span class="sd">      The sliced source.</span>

<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Either coordiante or local_coordinate must be given.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">local_coordinate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">coordinate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Either a coordiante or a base_coordainte needs to be given!&#39;</span><span class="p">);</span>
      <span class="n">local_coordinate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_to_local</span><span class="p">(</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">local_coordinate</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The source cannot be sliced at the base coordinate </span><span class="si">%d</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">local_coordinate</span><span class="p">);</span>

    <span class="n">slicing</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
    <span class="n">slicing</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_coordinate</span><span class="p">;</span>
    <span class="n">slicing</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">slicing</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="n">Slice</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">slicing</span><span class="o">=</span><span class="n">slicing</span><span class="p">)</span></div>
  
  
<div class="viewcode-block" id="Source.as_virtual"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Source.as_virtual">[docs]</a>  <span class="k">def</span> <span class="nf">as_virtual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">as_virtual</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">new</span><span class="p">;</span></div>
    
<div class="viewcode-block" id="Source.as_real"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Source.as_real">[docs]</a>  <span class="k">def</span> <span class="nf">as_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>               
    <span class="n">new</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">as_real</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">new</span><span class="p">;</span>    </div>
  
  <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">);</span>
    
  <span class="c1">#def __setitem__(self, *args):</span>
  <span class="c1">#  self._source.__setitem__(*args);</span>
  
  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_source_string</span><span class="p">(</span><span class="bp">self</span><span class="p">);</span>
  
  <span class="c1"># other source attributes</span>
  <span class="c1">#def __getattr__(self, name):</span>
  <span class="c1">#  print &#39;getattr&#39;, self.__class__, name</span>
  <span class="c1">#  print self._source.__class__</span>
  <span class="c1">#  if not hasattr(self._source, name):</span>
  <span class="c1">#    raise AttributeError(&#39;The source does not have the atrribute %s!&#39; % name);</span>
  <span class="c1">#  return getattr(self._source, name);</span>


  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">location</span><span class="p">;</span>
  
  <span class="nd">@location</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
  

<div class="viewcode-block" id="Source.plot"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Source.plot">[docs]</a>  <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">);</span></div></div>


<div class="viewcode-block" id="Slice"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Slice">[docs]</a><span class="k">class</span> <span class="nc">Slice</span><span class="p">(</span><span class="n">slc</span><span class="o">.</span><span class="n">Slice</span><span class="p">,</span> <span class="n">SourceRegion</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class to handle a slice of a stitchable source.&quot;&quot;&quot;</span> 
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">slicing</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Slice class construtor.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    source: string, array or Source class</span>
<span class="sd">      The image source.</span>
<span class="sd">    position : tuple of int or None</span>
<span class="sd">      The position of the source&#39;s &#39;lower&#39; corner in the layout.</span>
<span class="sd">    tile_position : array or None</span>
<span class="sd">      Optional position of this source in a tiling grid. </span>
<span class="sd">    slicing : slice specification</span>
<span class="sd">      The slice specification to obtain this slice.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">SourceRegion</span><span class="p">):</span>
      <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">,</span> <span class="n">tile_position</span> <span class="o">=</span> <span class="n">tile_position</span><span class="p">);</span>
    
    <span class="n">SourceRegion</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">);</span>
    <span class="n">slc</span><span class="o">.</span><span class="n">Slice</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">,</span> <span class="n">slicing</span> <span class="o">=</span> <span class="n">slicing</span><span class="p">);</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">identifier</span><span class="p">;</span>
  
  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">start</span> <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">sliced_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slicing</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span>
      <span class="n">reduction</span> <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">sliced_reduction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slicing</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">ndim</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">+</span> <span class="n">start</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">reduction</span><span class="p">);</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">;</span>
  
  <span class="nd">@position</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
    <span class="c1">#raise RuntimeError(&#39;Cannot set position of this sliced source!&#39;)</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">position_unsliced</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the position of this slice in the underlying space taking into account the source position.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    position : tuple of ints or int</span>
<span class="sd">      The position of the slice in the higher dimensional space of the source.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">start</span>  <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">sliced_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slicing</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span>
      <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">s</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">start</span><span class="p">));</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
      <span class="n">start</span>  <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">sliced_start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slicing</span><span class="p">,</span> <span class="n">shape</span><span class="p">);</span>
      <span class="n">reduction</span> <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">sliced_reduction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slicing</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">));</span>
      <span class="n">source_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">position</span>
      <span class="n">position</span> <span class="o">=</span> <span class="p">();</span>
      <span class="n">rd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">reduction</span><span class="p">:</span>
          <span class="n">position</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">[</span><span class="n">rd</span><span class="p">],);</span>
          <span class="n">rd</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">position</span> <span class="o">+=</span> <span class="p">(</span><span class="n">source_position</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">start</span><span class="p">[</span><span class="n">d</span><span class="p">],);</span>
      <span class="k">return</span> <span class="n">position</span><span class="p">;</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">id</span><span class="p">;</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">tile_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">tile_position</span><span class="p">;</span>
  
  
  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_source_string</span><span class="p">(</span><span class="bp">self</span><span class="p">);</span>
  
  <span class="c1"># source attributes</span>
  <span class="c1">#def __getattr__(self, name):</span>
  <span class="c1">#  if not hasattr(self.source, name):</span>
  <span class="c1">#    raise AttributeError(&#39;The source does not have the atrribute %s!&#39; % name);</span>
  <span class="c1">#  return getattr(self.source, name);</span>
  
    
<div class="viewcode-block" id="Slice.as_virtual"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Slice.as_virtual">[docs]</a>  <span class="k">def</span> <span class="nf">as_virtual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">as_virtual</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">new</span><span class="p">;</span></div>
    
<div class="viewcode-block" id="Slice.as_real"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Slice.as_real">[docs]</a>  <span class="k">def</span> <span class="nf">as_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">as_real</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">new</span><span class="p">;</span>    </div></div>


<span class="k">def</span> <span class="nf">_source_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper to generate a string describing a source with positional infomration.&quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">;</span>
  
  <span class="k">try</span><span class="p">:</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">shape</span> <span class="o">=</span><span class="s1">&#39;</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">shape</span><span class="p">,))</span> <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

  <span class="k">try</span><span class="p">:</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">;</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">dtype</span> <span class="k">if</span> <span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
          
  <span class="k">try</span><span class="p">:</span>
    <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">;</span>
    <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;|</span><span class="si">%s</span><span class="s1">|&#39;</span> <span class="o">%</span> <span class="n">order</span> <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">order</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  
  <span class="k">try</span><span class="p">:</span>
    <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">location</span><span class="p">;</span>
    <span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">location</span> <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">:</span>
      <span class="c1">#location = location[:25] + &#39;...&#39; + location[-25:]</span>
      <span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span> <span class="o">+</span> <span class="n">location</span><span class="p">[</span><span class="o">-</span><span class="mi">25</span><span class="p">:];</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">location</span><span class="p">;</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">location</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>    
  
  <span class="k">try</span><span class="p">:</span>
    <span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;P</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">),);</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">position</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  
  <span class="k">try</span><span class="p">:</span> 
    <span class="n">tile_position</span> <span class="o">=</span> <span class="s2">&quot;T</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_position</span><span class="p">),);</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">tile_position</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  
  <span class="k">try</span><span class="p">:</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="s1">&#39;(#</span><span class="si">%d</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">;</span>
  <span class="k">except</span><span class="p">:</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="n">ids</span> <span class="o">+</span> <span class="n">tile_position</span> <span class="o">+</span> <span class="n">position</span> <span class="o">+</span> <span class="n">shape</span> <span class="o">+</span> <span class="n">dtype</span> <span class="o">+</span> <span class="n">order</span> <span class="o">+</span> <span class="n">location</span>


<span class="c1">########################################################################################</span>
<span class="c1">### Layouts</span>
<span class="c1">########################################################################################</span>

<span class="c1">#TODO: really need this base class ?</span>
<div class="viewcode-block" id="AlignmentBase"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.AlignmentBase">[docs]</a><span class="k">class</span> <span class="nc">AlignmentBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Base class to handle alignments between two adjacent sources.&quot;&quot;&quot;</span>
  <span class="c1">#note: could make this a source like object with data and plot routines</span>
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alignment construtor.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    pre, post: Source classes</span>
<span class="sd">      The pointers to the source classes of the adjacent images.</span>
<span class="sd">    shift : tuple of int</span>
<span class="sd">      Additional shift between the pre source and post source positions to better align them.</span>
<span class="sd">    displacement : tuple of int </span>
<span class="sd">      The optimal displacement between the positions of the pre and post source.</span>
<span class="sd">    quality : number or None</span>
<span class="sd">      The quality of the alignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">SourceRegion</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">post</span><span class="p">,</span> <span class="n">SourceRegion</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Pre and post specifications need to be Source classes!&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pre</span> <span class="o">=</span> <span class="n">pre</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_post</span> <span class="o">=</span> <span class="n">post</span><span class="p">;</span>
  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The sources that contribute to this alignment.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sources : list of Source classes</span>
<span class="sd">      The sources that contribute to this alignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span><span class="p">];</span>
  
  <span class="nd">@sources</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span> <span class="o">=</span> <span class="n">sources</span><span class="p">;</span>
  
  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">pre</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The first source that contributes to this alignment.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    source : Source classes</span>
<span class="sd">      The first source that contribute to this alignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pre</span><span class="p">;</span>
  
  <span class="nd">@pre</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">pre</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_pre</span> <span class="o">=</span> <span class="n">pre</span><span class="p">;</span>
  
  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The second source that contributes to this alignment.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    source : Source classes</span>
<span class="sd">      The second source that contribute to this alignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post</span><span class="p">;</span>
  
  <span class="nd">@post</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_post</span> <span class="o">=</span> <span class="n">post</span><span class="p">;</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dimension of the alignment sources.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndim : int</span>
<span class="sd">      The dimension of the sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  
  
<div class="viewcode-block" id="AlignmentBase.plot"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.AlignmentBase.plot">[docs]</a>  <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots this alignment&quot;&quot;&quot;</span>               
    <span class="n">plot_sources</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span></div>
  
<div class="viewcode-block" id="AlignmentBase.overlay"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.AlignmentBase.overlay">[docs]</a>  <span class="k">def</span> <span class="nf">overlay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">overlay_sources</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span></div>
  
<div class="viewcode-block" id="AlignmentBase.plot_overlay"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.AlignmentBase.plot_overlay">[docs]</a>  <span class="k">def</span> <span class="nf">plot_overlay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ovl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay</span><span class="p">(</span><span class="n">colors</span> <span class="o">=</span> <span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ovl</span><span class="p">]);</span></div>
  
<div class="viewcode-block" id="AlignmentBase.overlay_overlap"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.AlignmentBase.overlay_overlap">[docs]</a>  <span class="k">def</span> <span class="nf">overlay_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
    <span class="n">o1</span><span class="p">,</span><span class="n">o2</span> <span class="o">=</span> <span class="n">_overlap_with_shifts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">);</span>         
    <span class="n">i1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">[</span><span class="n">o1</span><span class="o">.</span><span class="n">local_slicing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">)];</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">[</span><span class="n">o2</span><span class="o">.</span><span class="n">local_slicing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">)];</span>  
    <span class="k">return</span> <span class="p">[</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">];</span>                   </div>
  
<div class="viewcode-block" id="AlignmentBase.plot_overlap"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.AlignmentBase.plot_overlap">[docs]</a>  <span class="k">def</span> <span class="nf">plot_overlap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1">#cut overlap region</span>
    <span class="k">return</span> <span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_overlap</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)]);</span></div>
  
<div class="viewcode-block" id="AlignmentBase.overlay_mip"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.AlignmentBase.overlay_mip">[docs]</a>  <span class="k">def</span> <span class="nf">overlay_mip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Overlays this alignment using max intensity projection.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">overlay_along_axis_mip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>    </div>
  
<div class="viewcode-block" id="AlignmentBase.plot_mip"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.AlignmentBase.plot_mip">[docs]</a>  <span class="k">def</span> <span class="nf">plot_mip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots this alignment using max intensity projection.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">plot_along_axis_mip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>                    </div>
  
<div class="viewcode-block" id="AlignmentBase.copy"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.AlignmentBase.copy">[docs]</a>  <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">);</span></div>
  
  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  
    <span class="k">return</span> <span class="s2">&quot;Alignment(</span><span class="si">%r</span><span class="s2">-&gt;</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">identifier</span><span class="p">);</span>
  
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">();</span></div>



<div class="viewcode-block" id="Alignment"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Alignment">[docs]</a><span class="k">class</span> <span class="nc">Alignment</span><span class="p">(</span><span class="n">AlignmentBase</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class to handle rigid alignments between two adjacent sources.&quot;&quot;&quot;</span>
  <span class="c1">#note: could make this a source like object with data and plot routines</span>
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">displacement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Alignment construtor.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    pre, post: Source classes</span>
<span class="sd">      The pointers to the source classes of the adjacent images.</span>
<span class="sd">    shift : tuple of int</span>
<span class="sd">      Additional shift between the pre source and post source positions to better align them.</span>
<span class="sd">    displacement : tuple of int </span>
<span class="sd">      The optimal displacement between the positions of the pre and post source.</span>
<span class="sd">    quality : number or None</span>
<span class="sd">      The quality of the alignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">AlignmentBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="n">displacement</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">shift</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">displacement</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">q</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">pre</span><span class="o">.</span><span class="n">position</span><span class="p">));</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">displacement</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">q</span> <span class="o">+</span> <span class="n">s</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">pre</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">shift</span><span class="p">));</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_displacement</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="n">quality</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_quality</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_quality</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">quality</span><span class="p">);</span>
  
  
  <span class="nd">@property</span>  
  <span class="k">def</span> <span class="nf">displacement</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The displacement between the two sources given their positions and the alignment shift.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    displacmeent : array of int</span>
<span class="sd">      The displacement between the sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#return tuple(p - q + s for p,q,s in zip(self.post.position, self.pre.position, self.shift));</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacement</span><span class="p">;</span>
  
  <span class="nd">@displacement</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">displacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">displacement</span><span class="p">):</span>
    <span class="c1">#self.shift = tuple(d - (p - q) for d,p,q in zip(displacement, self.post.position, self.pre.position))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_displacement</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">displacement</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
  
  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The additional shift between the source positions that better aligns them.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    shift : array of int</span>
<span class="sd">      The additional shift between the source positions that better aligns them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#return self._shift;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">d</span> <span class="o">-</span> <span class="n">q</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span><span class="p">));</span>
  
  <span class="nd">@shift</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
    <span class="c1">#self._shift = ensure(shift, tuple);</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_displacement</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="n">s</span> <span class="o">-</span> <span class="n">p</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">shift</span><span class="p">))</span>
  
  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">quality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The quality of this alignment.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    quality : float</span>
<span class="sd">      The quality of this alignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_quality</span><span class="p">;</span>
  
  <span class="nd">@quality</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quality</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_quality</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">quality</span><span class="p">);</span>
  

<div class="viewcode-block" id="Alignment.mip_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Alignment.mip_axis">[docs]</a>  <span class="k">def</span> <span class="nf">mip_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A axis for maximum projections.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_mip_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Alignment.plot"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Alignment.plot">[docs]</a>  <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots this alignment&quot;&quot;&quot;</span>
    <span class="n">post</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
    <span class="n">post</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">d</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span><span class="p">));</span>                         
    <span class="k">return</span> <span class="n">plot_sources</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span></div>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">;</span>
  
  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">quality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">quality</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">quality</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">quality</span><span class="p">;</span> 
   
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">-&gt;</span><span class="si">%r</span><span class="s2">)D</span><span class="si">%r</span><span class="s2">S</span><span class="si">%r</span><span class="s2">[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacement</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span> <span class="n">quality</span><span class="p">);</span></div>





<div class="viewcode-block" id="Layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout">[docs]</a><span class="k">class</span> <span class="nc">Layout</span><span class="p">(</span><span class="n">SourceRegion</span><span class="p">,</span> <span class="n">src</span><span class="o">.</span><span class="n">AbstractSource</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Base class to handle the layout of multiple sources.&quot;&quot;&quot;</span>
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">alignments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Layout constructor.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    sources : list of filenames or Source classes</span>
<span class="sd">      List of the sources of the individual sources contributing to the full image.</span>
<span class="sd">    alignments : list of Alignment classes</span>
<span class="sd">      The alignment structure of the sources.</span>
<span class="sd">    shape : tuple of int or None</span>
<span class="sd">      The fixed shape of this Layout, if None the minimal size to fit all sources will be used.</span>
<span class="sd">    dtype: dtype or None</span>
<span class="sd">      The data type to use for this layout, if None use the dtype of the first source.</span>
<span class="sd">    order : &#39;C&quot;, &#39;F&#39; or None</span>
<span class="sd">      Contiguous order of the layout array.</span>
<span class="sd">    position : tuple of int or None</span>
<span class="sd">      The fixed position of this layout, if None the lower corner to fit all sources will be used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">SourceRegion</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">);</span>
    <span class="n">src</span><span class="o">.</span><span class="n">AbstractSource</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">location</span><span class="p">);</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SourceRegion</span><span class="p">)</span> <span class="k">else</span> <span class="n">Source</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_alignments</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">alignments</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">alignments</span><span class="p">;</span>
    
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The sources in the layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sources : list </span>
<span class="sd">      List of the sources in this layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">;</span>
   
  <span class="nd">@sources</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">;</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">n_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Number of sources in the layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    n_sources : int</span>
<span class="sd">      Number of sources in this layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">);</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">alignments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The alignments in the layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    alignments : list </span>
<span class="sd">      List of the alignments in this layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alignments</span><span class="p">;</span>
   
  <span class="nd">@alignments</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">alignments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alignments</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_alignments</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">;</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">n_alignments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Number of alignments in this layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    n_alignments : int</span>
<span class="sd">      Number of alignments in this layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">);</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">ndim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dimension of the alignment sources.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndim : int</span>
<span class="sd">      The dimension of the sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  
  
  
  <span class="c1">### Geometry</span>
   
  <span class="nd">@property</span>    
  <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the lower position of the layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    position : tuple of ints</span>
<span class="sd">      The position of the lower corner of this layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">;</span> 
    
  <span class="nd">@position</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">position</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
  
  
  <span class="nd">@property</span>    
  <span class="k">def</span> <span class="nf">lower</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the lower position of the entire layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lower : tuple of ints</span>
<span class="sd">      The lower position of the full layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">));</span>
  
  
  <span class="nd">@property</span>   
  <span class="k">def</span> <span class="nf">upper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the upper position of the entire layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    upper : tuple of ints</span>
<span class="sd">      The upper position of the full layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">));</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Shape of the layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    shape : tuple of int</span>
<span class="sd">      The shape of the layout when stitching together all the sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">o</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">));</span>
  
  <span class="nd">@shape</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">);</span>
  
  
<div class="viewcode-block" id="Layout.lower_to_origin"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.lower_to_origin">[docs]</a>  <span class="k">def</span> <span class="nf">lower_to_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Moves the sources so that the lower corner is at the origin.&quot;&quot;&quot;</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">;</span>
    <span class="n">source_positions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">l</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">lower</span><span class="p">))</span> <span class="k">for</span> <span class="n">positions</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_positions</span><span class="p">()];</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_source_positions</span><span class="p">(</span><span class="n">source_positions</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.source_positions"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.source_positions">[docs]</a>  <span class="k">def</span> <span class="nf">source_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the positions of the sources.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    positions : list of tuples of ints</span>
<span class="sd">      The source positions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">];</span></div>

  
<div class="viewcode-block" id="Layout.set_source_positions"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.set_source_positions">[docs]</a>  <span class="k">def</span> <span class="nf">set_source_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">update_alignments</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets the positions of the sources.</span>
<span class="sd">  </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    positions : list of tuple of ints or None</span>
<span class="sd">      The new positions of the sources, if None infer a consistent solution from the alignments.</span>
<span class="sd">    sources : list of Source classes</span>
<span class="sd">      If only a subset of positions is given, this list represents the sources of those positions.</span>
<span class="sd">    update_alignments : bool</span>
<span class="sd">      If True, also update the alignments shifts to match the new positions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">;</span>

    <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">positions</span> <span class="o">=</span> <span class="n">positions_from_tree</span><span class="p">(</span><span class="n">alignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">);</span>
    
    <span class="n">old_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_positions</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
      <span class="n">s</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="n">update_alignments</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">sources</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">:</span>
          <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">new_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_positions</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">);</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">o</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">npos</span><span class="p">,</span> <span class="n">opos</span><span class="p">))</span> <span class="k">for</span> <span class="n">npos</span><span class="p">,</span><span class="n">opos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_positions</span><span class="p">,</span> <span class="n">old_positions</span><span class="p">)];</span>
        <span class="n">sources_to_index</span> <span class="o">=</span> <span class="p">{</span> <span class="n">s</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">)};</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">:</span>
          <span class="n">pre</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">;</span>
          <span class="n">post</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">;</span>
          
          <span class="k">if</span> <span class="n">pre</span> <span class="ow">and</span> <span class="n">post</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
          <span class="k">elif</span> <span class="n">pre</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">sources_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">];</span>
            <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">d</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span> <span class="n">delta</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
          <span class="k">elif</span> <span class="n">post</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">sources_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">];</span>
            <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">d</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shift</span><span class="p">,</span> <span class="n">delta</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span></div>
  
  
<div class="viewcode-block" id="Layout.sink_slicing"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.sink_slicing">[docs]</a>  <span class="k">def</span> <span class="nf">sink_slicing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the slice of this layout&#39;s data in an underlying sink.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slice : list of slice objects</span>
<span class="sd">      The slice to use if this layout is placed in an underling sink.</span>
<span class="sd">      </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    Positions below zero are cut off as well as above the shape.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">o</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">));</span></div>
  
  
  <span class="c1">### IO</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Data type of the sources in the layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dtype : dtype</span>
<span class="sd">      Data type of the sources in this layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">;</span>
  
  <span class="nd">@dtype</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtype</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">;</span>
  
  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The contiguous order of the source.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    order : order</span>
<span class="sd">      The contiguous order of the source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">order</span><span class="p">;</span>
  
  
  <span class="nd">@order</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_order</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">str</span><span class="p">);</span>
  
  
  <span class="nd">@property</span> 
  <span class="k">def</span> <span class="nf">location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The location of the layout when written.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    location : str</span>
<span class="sd">      The location of the layout when written.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_location</span><span class="p">;</span>
  
  <span class="nd">@location</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_location</span> <span class="o">=</span> <span class="n">ensure</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="nb">str</span><span class="p">);</span>
  
  
  <span class="c1">### Functionality</span>
  
<div class="viewcode-block" id="Layout.source_index"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.source_index">[docs]</a>  <span class="k">def</span> <span class="nf">source_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The id of a source in the list of sources.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    source : Source class</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    id : int or None</span>
<span class="sd">      Position of the source in the sources list, None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">source</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">i</span><span class="p">;</span>  
    <span class="k">return</span> <span class="kc">None</span><span class="p">;</span></div>
  
  
<div class="viewcode-block" id="Layout.update_alignments_from_sources"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.update_alignments_from_sources">[docs]</a>  <span class="k">def</span> <span class="nf">update_alignments_from_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates the alignments from the source positions.&quot;&quot;&quot;</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">:</span>
      <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">zero</span><span class="p">;</span></div>
  
  
<div class="viewcode-block" id="Layout.update_sources_from_alignments"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.update_sources_from_alignments">[docs]</a>  <span class="k">def</span> <span class="nf">update_sources_from_alignments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates the source positions from the alignments.&quot;&quot;&quot;</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">positions_from_tree</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">alignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">,</span> <span class="n">fixed_source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">set_source_positions</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">update_alignments</span> <span class="o">=</span> <span class="kc">True</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.remove_source"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.remove_source">[docs]</a>  <span class="k">def</span> <span class="nf">remove_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Removes a source from this Layout.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    source : int, Source class or list of ints or Source classes</span>
<span class="sd">      The list of source classes to remove from this layout.</span>
<span class="sd">      </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The alignments are cleaned in a consistent way when this routine is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
      <span class="n">source</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span><span class="p">];</span>
    
    <span class="n">dels</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">si</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">si</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">si</span><span class="p">];</span>
        <span class="n">source</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">si</span><span class="p">;</span>
      <span class="n">sid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_index</span><span class="p">(</span><span class="n">si</span><span class="p">);</span>
      <span class="k">if</span> <span class="n">sid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sid</span><span class="p">);</span>
    
    <span class="n">dela</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="ow">in</span> <span class="n">source</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="ow">in</span> <span class="n">source</span><span class="p">:</span>
        <span class="n">dela</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dels</span><span class="p">];</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dela</span><span class="p">];</span></div>
  
  
<div class="viewcode-block" id="Layout.change_sources"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.change_sources">[docs]</a>  <span class="k">def</span> <span class="nf">change_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;changes the sources of this layout.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    sources : list of sources</span>
<span class="sd">      The new sources.</span>
<span class="sd">      </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This allows to stitch other color channels with the same alignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The number of sources </span><span class="si">%d</span><span class="s1"> and layout sources </span><span class="si">%d</span><span class="s1"> do not match!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">)));</span>
    
    <span class="n">old_sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">;</span>
    <span class="n">old_to_new</span> <span class="o">=</span> <span class="p">{</span><span class="n">o</span> <span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">old_sources</span><span class="p">,</span> <span class="n">sources</span><span class="p">)};</span>
    
    <span class="n">alignments</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alignments</span><span class="p">];</span>    
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
      <span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">old_to_new</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">];</span>
      <span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">old_to_new</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">];</span>
    
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">old_sources</span><span class="p">):</span>
      <span class="n">s</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
      <span class="n">s</span><span class="o">.</span><span class="n">tile_position</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">tile_position</span><span class="p">;</span>
     
    <span class="bp">self</span><span class="o">.</span><span class="n">_alignments</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">;</span></div>
  
  
<div class="viewcode-block" id="Layout.change_source_location"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.change_source_location">[docs]</a>  <span class="k">def</span> <span class="nf">change_source_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">substitutions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change the sources to point to a new location.</span>
<span class="sd">      </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    expression : str</span>
<span class="sd">       Tag expression of source names with additional substitution tags.</span>
<span class="sd">    substitutions : dict</span>
<span class="sd">      A substitution dictionary of the form {tag_name : value}, </span>
<span class="sd">      specifying how to replace the substitution tags.</span>
<span class="sd">      </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This function is useful to stitch other color channels of imagining data</span>
<span class="sd">    using the same alignments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">te</span><span class="o">.</span><span class="n">Expression</span><span class="p">):</span>
      <span class="n">expression</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">expression</span><span class="p">);</span>
    
    <span class="c1">#get locations</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">location</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">];</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The layout contains sources without locations!&#39;</span><span class="p">);</span>
    
    <span class="c1">#change location expressions</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">expression</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">substitutions</span><span class="p">))</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">];</span>

    <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">];</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">locations</span><span class="p">):</span>
      <span class="n">s</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">change_sources</span><span class="p">(</span><span class="n">sources</span><span class="p">);</span></div>

  
<div class="viewcode-block" id="Layout.replace_source_location"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.replace_source_location">[docs]</a>  <span class="k">def</span> <span class="nf">replace_source_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">replace</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;expression&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change the sources to point to a new location.</span>
<span class="sd">      </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    match : str or Expression</span>
<span class="sd">      Expression of source names to match and substitute.</span>
<span class="sd">    replace : str or Expression</span>
<span class="sd">      Expression to replace source names with.</span>
<span class="sd">      </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    This function is useful to stitch other color channels of imagining data</span>
<span class="sd">    using the same alignments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;expression&#39;</span><span class="p">:</span>
      <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">location</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">];</span>
      <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
          <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The layout contains sources without locations!&#39;</span><span class="p">);</span>
      
      <span class="c1">##change location expressions</span>
      <span class="c1">#locations = [l.replace(match, replace) for l in locations];</span>
      
      <span class="n">e_match</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">match</span><span class="p">);</span>
      <span class="n">e_replace</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">replace</span><span class="p">);</span>
      <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">locations</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">e_match</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">l</span><span class="p">);</span>
        <span class="n">s</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">e_match</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">values</span><span class="p">),</span> <span class="n">e_replace</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">values</span><span class="p">));</span>
      
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;replace&#39;</span><span class="p">:</span>
      <span class="c1">#get locations</span>
      <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">location</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">];</span>
      <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
          <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The layout contains sources without locations!&#39;</span><span class="p">);</span>
      
      <span class="c1">#change location expressions</span>
      <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">match</span><span class="p">,</span> <span class="n">replace</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">locations</span><span class="p">];</span>
  
      <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">locations</span><span class="p">):</span>
        <span class="n">s</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Method </span><span class="si">%r</span><span class="s1"> not valid!&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.sort_sources_by_position"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.sort_sources_by_position">[docs]</a>  <span class="k">def</span> <span class="nf">sort_sources_by_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sorts the sources of this layout by their current position.&quot;&quot;&quot;</span>
    <span class="n">pl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_positions</span><span class="p">();</span>
    <span class="n">p</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pl</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">object</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
      <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pl</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">sort_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>      
    <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sort_id</span><span class="p">];</span></div>
  
  
<div class="viewcode-block" id="Layout.connected_components"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.connected_components">[docs]</a>  <span class="k">def</span> <span class="nf">connected_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">with_sources</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Determines the connected components of the layout.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    min_quality : float, tuple of floats or None</span>
<span class="sd">      The minimal quality needed to include an alignment in the calculation.</span>
<span class="sd">    with_sources : bool</span>
<span class="sd">       If True, also return the sources in each component.     </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    components : list of list of Alignment classes</span>
<span class="sd">      The connected components of the alignments.</span>
<span class="sd">    component_sources : list of list of Source classes</span>
<span class="sd">      The sources in each compoenent.      </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">connected_components</span><span class="p">(</span><span class="n">alignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="n">min_quality</span><span class="p">,</span> <span class="n">with_sources</span> <span class="o">=</span> <span class="n">with_sources</span><span class="p">);</span></div>
  
    
<div class="viewcode-block" id="Layout.connected"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.connected">[docs]</a>  <span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns True if the alignments form a single connected component.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    connected : bool</span>
<span class="sd">      True if the alignments form a single connected component.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">connected</span><span class="p">(</span><span class="n">alignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.embedding"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.embedding">[docs]</a>  <span class="k">def</span> <span class="nf">embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Splits the set of co-axial sources into a minimal set of non-overlaping regions.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    shape : tuple of int</span>
<span class="sd">      The shape that encapsulates all the regions.</span>
<span class="sd">    position : tuple of int</span>
<span class="sd">      The lowest corner of all the regions.</span>
<span class="sd">    regions : list of Region classes.</span>
<span class="sd">      The regions of different overlaps of the individual sources.       </span>
<span class="sd">    </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The result can be used to stitch the images.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">embedding</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.layout_from_region"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.layout_from_region">[docs]</a>  <span class="k">def</span> <span class="nf">layout_from_region</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lower</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a layout with only the sources needed to construct the specified region</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    layout : Layout class</span>
<span class="sd">      The reduced layout needed to cover the region.    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">Region</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">lower</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">upper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Either a region or position and shape or lower and upper coordinates have to be given!&#39;</span><span class="p">);</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">);</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">region</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">upper</span><span class="p">);</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">lower</span><span class="p">;</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">region</span><span class="o">.</span><span class="n">upper</span><span class="p">;</span>
    
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">u</span> <span class="o">&lt;</span> <span class="n">l</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">)])</span> \
                                      <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">l</span> <span class="o">&gt;=</span> <span class="n">u</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">u</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)])];</span>
    <span class="n">new</span><span class="o">.</span><span class="n">remove_sources</span><span class="p">(</span><span class="n">rem</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">new</span><span class="p">;</span></div>
  
  
<div class="viewcode-block" id="Layout.slice_along_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.slice_along_axis">[docs]</a>  <span class="k">def</span> <span class="nf">slice_along_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a layout corresponding to a slice along a single axis in this layout.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    coordinate : int</span>
<span class="sd">      The coordinate at which to take the slice.</span>
<span class="sd">    axis : int</span>
<span class="sd">      The axis to take the slice in.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    layout : SlicedLayout class</span>
<span class="sd">      The sliced layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">slice_layout_along_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span> <span class="o">=</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">);</span></div>
  
  
  <span class="c1">### Alignment, placement ans stitching</span>
  
<div class="viewcode-block" id="Layout.align"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.align">[docs]</a>  <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Align the sources.&quot;&quot;&quot;</span>
    <span class="n">align_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="n">processes</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.place"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.place">[docs]</a>  <span class="k">def</span> <span class="nf">place</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;optimization&#39;</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Optimizes positions of the sources in this layout.&quot;&quot;&quot;</span>
    <span class="n">place_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="n">lower_to_origin</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.stitch"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.stitch">[docs]</a>  <span class="k">def</span> <span class="nf">stitch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;interpolation&#39;</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Stitches the sources according to this layout.</span>
<span class="sd">   </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    sink : sink specification or None</span>
<span class="sd">      The sink to write the result to.</span>
<span class="sd">    method : str</span>
<span class="sd">      The method to use for the stitching: &#39;interpolation&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mean&#39;</span>
<span class="sd">  </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    stitched : array or sink</span>
<span class="sd">      The stitched array or sink.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">stitch_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.align_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.align_axis">[docs]</a>  <span class="k">def</span> <span class="nf">align_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Aligns sources in a layout along a single axis only.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    layout: Layout class</span>
<span class="sd">      The layout in which to align the 3d sources in z-direction.</span>
<span class="sd">    depth : int or list of ints</span>
<span class="sd">      The approximate overlaps of the sources in the tiling dimensions to use </span>
<span class="sd">      for mip projection when aligning the axis.</span>
<span class="sd">    max_shifts : tuple of ints</span>
<span class="sd">      The minmal and maximal shifts along all axes consider.</span>
<span class="sd">    axis : int</span>
<span class="sd">      The axis to aling the sources along.</span>
<span class="sd">    axis_range : tuple of int or None</span>
<span class="sd">      If not None, use only a sub set of the axis range to speed up processing.</span>
<span class="sd">    clip : number or None</span>
<span class="sd">      If not None, clip the soruces at this value when calculating the alignment.</span>
<span class="sd">    background : number or None</span>
<span class="sd">      If not None, if the values in the overlap region are less than this number make alignment return -inf quality as there is no signal to use for alignment. </span>
<span class="sd">    processes : int or &#39;serial&#39; </span>
<span class="sd">      Number of processor to use for parallel processing, if &#39;serial&#39; process in serial.</span>
<span class="sd">    verbose : bool</span>
<span class="sd">      Print progress information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
    <span class="n">align_layout_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">,</span> <span class="n">axis_range</span> <span class="o">=</span> <span class="n">axis_range</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="n">processes</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">);</span></div>


<div class="viewcode-block" id="Layout.place_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.place_axis">[docs]</a>  <span class="k">def</span> <span class="nf">place_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;optimization&#39;</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Places the sources in a layout along a single axis only.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    axis: int</span>
<span class="sd">      The axis which to place the sources along.</span>
<span class="sd">    method : &#39;optimization&#39; or &#39;tree&#39;</span>
<span class="sd">      The method to use to place the sources.</span>
<span class="sd">    min_quality : float</span>
<span class="sd">      The minimal quality of the alignment.</span>
<span class="sd">    lower_to_origin : bool</span>
<span class="sd">      If True the lower corner of the aligned images is set to zero.  </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
    <span class="n">place_layout_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="n">min_quality</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="n">lower_to_origin</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">);</span></div>

  
  
  <span class="c1">### Data access </span>
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">array</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the stitched data</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    sink : sink specification or None</span>
<span class="sd">      The sink to write the result to. If None return as array.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data :  array or sink</span>
<span class="sd">      The stitched array or sink.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">);</span>
  
  
  <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slicing</span><span class="p">):</span>
    <span class="c1">#TODO: speed up stitching for subslices etc -&gt; for fast previews </span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">(</span><span class="n">slicing</span><span class="p">);</span>
  
  <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">slicing</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot set data in a Layout.&#39;</span><span class="p">);</span>

  
<div class="viewcode-block" id="Layout.array_along_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.array_along_axis">[docs]</a>  <span class="k">def</span> <span class="nf">array_along_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">coordinate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the stitched data</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    sink : sink specification or None</span>
<span class="sd">      The sink to write the result to. If None return as array.</span>
<span class="sd">    coordinate : int</span>
<span class="sd">      The coordinate at which to take the slice.</span>
<span class="sd">    axis : int</span>
<span class="sd">      The axis to take the slice in.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data :  array or sink</span>
<span class="sd">      The stitched array or sink.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_along_axis</span><span class="p">(</span><span class="n">coordinate</span> <span class="o">=</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.overlay"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.overlay">[docs]</a>  <span class="k">def</span> <span class="nf">overlay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="mi">98</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">coordinate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Overlays the sources to check their placement.</span>
<span class="sd">      </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    colors : list of tuple of floats or color names</span>
<span class="sd">      The optional RGB colors to use.</span>
<span class="sd">    percentile : int</span>
<span class="sd">      Use this percentile as upper cutoff in the resulting image to enhance contrast.</span>
<span class="sd">    normalize : bool</span>
<span class="sd">      If True normalize image to floats between 0 and 1.</span>
<span class="sd">    coordinate : int or None</span>
<span class="sd">      Optional coordinate at which to take a slice.</span>
<span class="sd">    axis : int</span>
<span class="sd">      Optional axis to take the slice in.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    image : array</span>
<span class="sd">      A color image. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">coordinate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_along_axis</span><span class="p">(</span><span class="n">coordinate</span> <span class="o">=</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">overlay_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.plot"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.plot">[docs]</a>  <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="mi">98</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color_ids</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">coordinate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plots overlayed sources to check their placement.</span>
<span class="sd">      </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    colors : list of tuple of floats or color names</span>
<span class="sd">      The optional RGB colors to use.</span>
<span class="sd">    percentile : int</span>
<span class="sd">      Use this percentile as upper cutoff in the resulting image to enhance contrast.</span>
<span class="sd">    normalize : bool</span>
<span class="sd">      If True normalize image to floats between 0 and 1.</span>
<span class="sd">    color_ids : list of ints</span>
<span class="sd">      Use specific color ids for the sources contributing to the layout.</span>
<span class="sd">    coordinate : int or None</span>
<span class="sd">      Optional coordinate at which to take a slice.</span>
<span class="sd">    axis : int</span>
<span class="sd">      Optional axis to take the slice in.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    image : array</span>
<span class="sd">      A color image. </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">coordinate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">layout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_along_axis</span><span class="p">(</span><span class="n">coordinate</span> <span class="o">=</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">plot_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">)</span></div>
  
  
<div class="viewcode-block" id="Layout.plot_regions"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.plot_regions">[docs]</a>  <span class="k">def</span> <span class="nf">plot_regions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">,</span> <span class="n">annotate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Overlays and plots regions to check the alignment of this layout.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    cmap : colormap</span>
<span class="sd">      The color map to use to color the regions.</span>
<span class="sd">    annotate : bool</span>
<span class="sd">      Use annotaton or not.</span>
<span class="sd">    axes : tuple of ints</span>
<span class="sd">      Axes to use if sources are larger than 2d.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">position</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">();</span>
    <span class="n">plot_regions</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">annotate</span> <span class="o">=</span> <span class="n">annotate</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.plot_alignments"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.plot_alignments">[docs]</a>  <span class="k">def</span> <span class="nf">plot_alignments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">,</span> <span class="n">annotate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Overlays and plots regions to check the alignment of this layout.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    cmap : colormap</span>
<span class="sd">      The color map to use to color the regions.</span>
<span class="sd">    annotate : bool</span>
<span class="sd">      Use annotaton or not.</span>
<span class="sd">    axes : tuple of ints</span>
<span class="sd">      Axes to use if sources are larger than 2d.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plot_alignments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">annotate</span> <span class="o">=</span> <span class="n">annotate</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.load"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.load">[docs]</a>  <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Loads the layout specifications from a file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="n">load_layout</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="p">);</span>
    <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">layout</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="Layout.save"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.save">[docs]</a>  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Saves the layout to a file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">save_layout</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="p">);</span></div>
  
  <span class="c1">### Internals</span>
  
  <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="n">new</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">);</span>
    
    <span class="c1">#copy sorces and alignments</span>
    <span class="n">sources</span><span class="p">,</span> <span class="n">alignments</span> <span class="o">=</span> <span class="n">copy_sources_and_alignments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_alignments</span><span class="p">);</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">;</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_alignments</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="n">new</span><span class="p">;</span>
  
  
<div class="viewcode-block" id="Layout.sources_as_virtual"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.sources_as_virtual">[docs]</a>  <span class="k">def</span> <span class="nf">sources_as_virtual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">;</span>
    <span class="n">alignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">;</span>
    <span class="n">new_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">as_virtual</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">];</span>
    <span class="n">new_alignments</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">];</span>
    <span class="n">source_to_new</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">new_sources</span><span class="p">)};</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">an</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">new_alignments</span><span class="p">):</span>
      <span class="n">an</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">source_to_new</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">];</span>
      <span class="n">an</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">source_to_new</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">];</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="n">new_sources</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_alignments</span> <span class="o">=</span> <span class="n">new_alignments</span><span class="p">;</span></div>
  
<div class="viewcode-block" id="Layout.sources_as_real"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.sources_as_real">[docs]</a>  <span class="k">def</span> <span class="nf">sources_as_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">;</span>
    <span class="n">alignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">;</span>
    <span class="n">new_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">as_real</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">];</span>
    <span class="n">new_alignments</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">];</span>
    <span class="n">source_to_new</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">new_sources</span><span class="p">)};</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">an</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">new_alignments</span><span class="p">):</span>
      <span class="n">an</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">source_to_new</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">];</span>
      <span class="n">an</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">source_to_new</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">];</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="n">new_sources</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_alignments</span> <span class="o">=</span> <span class="n">new_alignments</span><span class="p">;</span></div>
  
<div class="viewcode-block" id="Layout.as_virtual"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.as_virtual">[docs]</a>  <span class="k">def</span> <span class="nf">as_virtual</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
    <span class="n">new</span><span class="o">.</span><span class="n">sources_as_virtual</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">new</span><span class="p">;</span>      </div>
  
<div class="viewcode-block" id="Layout.as_real"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.Layout.as_real">[docs]</a>  <span class="k">def</span> <span class="nf">as_real</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
    <span class="n">new</span><span class="o">.</span><span class="n">sources_as_real</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">new</span><span class="p">;</span></div>
  
  
  <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">_source_string</span><span class="p">(</span><span class="bp">self</span><span class="p">);</span>
    <span class="n">layout</span> <span class="o">=</span> <span class="s2">&quot;&lt;&lt;</span><span class="si">%d</span><span class="s2">s, </span><span class="si">%d</span><span class="s2">a&gt;&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_alignments</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">name</span> <span class="o">+</span> <span class="n">layout</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">):];</span>
  
  
  <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">();</span> </div>



<div class="viewcode-block" id="TiledLayout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.TiledLayout">[docs]</a><span class="k">class</span> <span class="nc">TiledLayout</span><span class="p">(</span><span class="n">Layout</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;TiledLayout handles stacks aligned on a tiling grid.&quot;&quot;&quot;</span>
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">expression</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_axes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_positions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">positions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">alignments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;TiledLayout constructor.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    sources : list of file names or Source classes</span>
<span class="sd">      List of the sources of the individual tiles / images.</span>
<span class="sd">    expression : str or None</span>
<span class="sd">      If sources is None, use this expression to a list of files to generate the sources.</span>
<span class="sd">    tile_axes : str or None</span>
<span class="sd">      If expression is given, use this ordering of the tag names in expression to consturct the tiling grid.</span>
<span class="sd">    tile_shape : tuple of ints or None</span>
<span class="sd">      Optional shape of the grid.</span>
<span class="sd">    tile_positions : list of tuple of ints or None</span>
<span class="sd">      Optional list of grid positions of the sources.</span>
<span class="sd">    positions : list of tuple of ints or None</span>
<span class="sd">      Optional list of positions of the individual sources.</span>
<span class="sd">    overlaps : tuple of ints or None</span>
<span class="sd">      Optional overlaps of the sources in each grid dimension.</span>
<span class="sd">    alignments : list of Alignment classes</span>
<span class="sd">      Optional alignment structure of the sources.</span>
<span class="sd">    shape : tuple of int or None</span>
<span class="sd">      The fixed shape of this Layout, if None the minimal size to fit all sources will be used.</span>
<span class="sd">    position : tuple of int or None</span>
<span class="sd">      The fixed position of this layout, if None the lower corner to fit all sources will be used.</span>
<span class="sd">    dtype: dtype or None</span>
<span class="sd">      The data type to use for this layout, if None use the dtype of the first source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">expression</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Either exprssion or sources must be given!&#39;</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="n">expression</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">sources</span><span class="p">,</span> <span class="n">alignments</span><span class="p">,</span> <span class="n">tile_positions</span> <span class="o">=</span> <span class="n">_initialize_tiles_from_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">tile_axes</span><span class="o">=</span><span class="n">tile_axes</span><span class="p">,</span> <span class="n">tile_shape</span><span class="o">=</span><span class="n">tile_shape</span><span class="p">,</span> <span class="n">tile_positions</span><span class="o">=</span><span class="n">tile_positions</span><span class="p">,</span> <span class="n">overlaps</span><span class="o">=</span><span class="n">overlaps</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span> <span class="n">alignments</span><span class="o">=</span><span class="n">alignments</span><span class="p">);</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">sources</span><span class="p">,</span> <span class="n">alignments</span><span class="p">,</span> <span class="n">tile_positions</span> <span class="o">=</span> <span class="n">_initialize_tiles_from_sources</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">tile_shape</span><span class="o">=</span><span class="n">tile_shape</span><span class="p">,</span> <span class="n">tile_positions</span><span class="o">=</span><span class="n">tile_positions</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span> <span class="n">overlaps</span><span class="o">=</span><span class="n">overlaps</span><span class="p">,</span> <span class="n">alignments</span><span class="o">=</span><span class="n">alignments</span><span class="p">)</span>
    
    <span class="c1">#init the underlying Layout</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">TiledLayout</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">,</span> <span class="n">alignments</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">,</span> 
                                      <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">location</span><span class="p">);</span>
    
    <span class="c1">#set tile_positions</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">tile_positions</span><span class="p">):</span>
      <span class="n">s</span><span class="o">.</span><span class="n">tile_position</span> <span class="o">=</span> <span class="n">g</span><span class="p">;</span>
    
    <span class="c1">#udate sources</span>
    <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">update_sources_from_alignments</span><span class="p">();</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">tile_dim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the dimension of the grid.</span>
<span class="sd">      </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    g_dim : int</span>
<span class="sd">      The grid dimension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">tile_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the list of the grid positions of the sources.</span>
<span class="sd">      </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tile_positions : list of tuple of ints</span>
<span class="sd">      The grid positions of the sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">tile_position</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">];</span>
  
  
<div class="viewcode-block" id="TiledLayout.source_to_tile_position"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.TiledLayout.source_to_tile_position">[docs]</a>  <span class="k">def</span> <span class="nf">source_to_tile_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps the source to a position on the grid in this layout.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    source : Source class or int</span>
<span class="sd">      The souce or id of the source to map to a grid position.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    positions : tuple of ints or None</span>
<span class="sd">      The grid position of the source, None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="o">.</span><span class="n">tile_position</span><span class="p">;</span>
    <span class="k">elif</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">source</span><span class="o">.</span><span class="n">tile_position</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">None</span><span class="p">;</span></div>
  
  
<div class="viewcode-block" id="TiledLayout.source_from_tile_position"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.TiledLayout.source_from_tile_position">[docs]</a>  <span class="k">def</span> <span class="nf">source_from_tile_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_position</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Maps the grid position to a source in this layout.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    tile_position : tuple of ints</span>
<span class="sd">      The position of the source in the grid.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    source : Source class or None</span>
<span class="sd">      The source at the required grid position, None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">tile_position</span> <span class="o">==</span> <span class="n">tile_position</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">;</span></div>
  
  
<div class="viewcode-block" id="TiledLayout.center_tile_position"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.TiledLayout.center_tile_position">[docs]</a>  <span class="k">def</span> <span class="nf">center_tile_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the most center tile position in this layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tile_center : tuple of ints </span>
<span class="sd">      The tile position of the most central tile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_center_tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tile_positions</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="TiledLayout.center_tile_source"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.TiledLayout.center_tile_source">[docs]</a>  <span class="k">def</span> <span class="nf">center_tile_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the most central source in this tile layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    center : tuple of ints </span>
<span class="sd">      The most central tile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tile_center</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center_tile_position</span><span class="p">();</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_from_tile_position</span><span class="p">(</span><span class="n">tile_center</span><span class="p">);</span></div>
    
  
<div class="viewcode-block" id="TiledLayout.sort_sources_by_tile_position"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.TiledLayout.sort_sources_by_tile_position">[docs]</a>  <span class="k">def</span> <span class="nf">sort_sources_by_tile_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sorts the sources of this layout by grid position.&quot;&quot;&quot;</span>
    <span class="n">gpl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_positions</span><span class="p">;</span>
    <span class="n">gp</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gpl</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">object</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gp</span><span class="p">)):</span>
      <span class="n">gp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">gpl</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">sort_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">gp</span><span class="p">);</span>      
    <span class="bp">self</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_sources</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sort_id</span><span class="p">];</span></div>
    
  
<div class="viewcode-block" id="TiledLayout.adjust_overlaps"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.TiledLayout.adjust_overlaps">[docs]</a>  <span class="k">def</span> <span class="nf">adjust_overlaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adjusts the positions of the sources given a new estimate of the overlaps.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    overlaps : tuple of ints or None</span>
<span class="sd">      Overlaps of the sources in each grid dimension.</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">tile_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tile_dim</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="n">overlaps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">overlaps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">overlaps</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
      <span class="n">overlaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">overlaps</span><span class="p">];</span>
    <span class="n">overlaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">overlaps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
    <span class="n">overlaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">overlaps</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tile_dim</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">overlaps</span><span class="p">))),</span> <span class="s1">&#39;wrap&#39;</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">:</span>
      <span class="n">pre</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">tile_position</span><span class="p">;</span>
      <span class="n">post</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">tile_position</span><span class="p">;</span>
      <span class="n">shift</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shift</span><span class="p">);</span>
      <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile_dim</span><span class="p">):</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">pre</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">post</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
        <span class="k">if</span> <span class="n">delta</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
          <span class="n">shift</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">overlaps</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
        <span class="k">elif</span> <span class="n">delta</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
          <span class="n">shift</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">post</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">overlaps</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
      <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shift</span><span class="p">);</span>
      
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
      <span class="n">s</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">update_sources_from_alignments</span><span class="p">();</span></div>
  
  

<div class="viewcode-block" id="TiledLayout.alignment_from_tile_positions"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.TiledLayout.alignment_from_tile_positions">[docs]</a>  <span class="k">def</span> <span class="nf">alignment_from_tile_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_position1</span><span class="p">,</span> <span class="n">tile_position2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the alignemtn between two tiles if exists..</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    tile_position1,2 : tuple of ints</span>
<span class="sd">      The position of the sources in the grid.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    alignment : Alignment class or None</span>
<span class="sd">      The alignment between the tile positions, None if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">tile_position</span> <span class="o">==</span> <span class="n">tile_position1</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">tile_position</span> <span class="o">==</span> <span class="n">tile_position2</span> <span class="ow">or</span> \
         <span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">tile_position</span> <span class="o">==</span> <span class="n">tile_position2</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">tile_position</span> <span class="o">==</span> <span class="n">tile_position1</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="kc">None</span><span class="p">;</span></div>


<div class="viewcode-block" id="TiledLayout.alignments_from_tile_position"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.TiledLayout.alignments_from_tile_position">[docs]</a>  <span class="k">def</span> <span class="nf">alignments_from_tile_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_position</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a list of all alignments that involve a specified tile.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    tile_position : tuple of ints</span>
<span class="sd">      The position of the source.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    alignments : list of Alignment class</span>
<span class="sd">      The alignments involved in the specified tile position,</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">alignments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">tile_position</span> <span class="o">==</span> <span class="n">tile_position</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">tile_position</span> <span class="o">==</span> <span class="n">tile_position</span><span class="p">:</span> 
        <span class="n">alignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
         
    <span class="k">return</span> <span class="n">alignments</span><span class="p">;</span></div>


  
<div class="viewcode-block" id="TiledLayout.align_on_tiling"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.TiledLayout.align_on_tiling">[docs]</a>  <span class="k">def</span> <span class="nf">align_on_tiling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Align pairwise images using overlaps along and grid information.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    layout : TiledLayout </span>
<span class="sd">      The grid layout of the sources.</span>
<span class="sd">    overlaps : int, tuple of ints or list of tuple of ints</span>
<span class="sd">      The overlaps along the grid axes.</span>
<span class="sd">    max_shifts : tuple or list of tuple of ints</span>
<span class="sd">      The maximal shifts along the axes directions.</span>
<span class="sd">    clip : number or None</span>
<span class="sd">      If not None, clip the soruces at this value when calculating the alignment.</span>
<span class="sd">    background : number or None</span>
<span class="sd">      If not None, if the values in the overlap region are less than this number make alignment return -inf quality as there is no signal to use for alignment.</span>
<span class="sd">    processes : int or &#39;serial&#39; </span>
<span class="sd">      Number of processor to use for parallel processing, if &#39;serial&#39; process in serial.</span>
<span class="sd">    verbose : bool </span>
<span class="sd">      If True, print progress information.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    layout : Layout class</span>
<span class="sd">      The updated layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">align_layout_on_tiling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="n">overlaps</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="n">processes</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">);</span></div></div>
  
  



<span class="k">def</span> <span class="nf">_center_tile</span><span class="p">(</span><span class="n">tile_positions</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;helper to calucalte the most central tile in a list of tile positions.&quot;&quot;&quot;</span>
  <span class="n">tdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">tpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tile_positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tdim</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tpos</span><span class="p">[:,</span><span class="n">d</span><span class="p">])[(</span><span class="nb">len</span><span class="p">(</span><span class="n">tpos</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">];</span>
    <span class="n">tpos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tpos</span> <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">==</span> <span class="n">m</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  <span class="n">center</span> <span class="o">=</span> <span class="n">tpos</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">center</span><span class="p">);</span>


<span class="k">def</span> <span class="nf">_initialize_tiles_from_sources</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">tile_shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_positions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="n">positions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">alignments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper to set up the TiledLayout info.&quot;&quot;&quot;</span>
  
  <span class="c1">#tiling</span>
  <span class="k">if</span> <span class="n">tile_positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># infer tiling from sources or tile_shape</span>
    <span class="k">if</span> <span class="n">tile_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># infer tiling from structure of sources</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span> <span class="c1"># nested list structure</span>
        <span class="c1">#grid shape</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">sources</span><span class="p">;</span>
        <span class="n">tile_shape</span> <span class="o">=</span> <span class="p">();</span>
        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
          <span class="n">tile_shape</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">),);</span>
          <span class="n">src</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      
        <span class="c1">#convert to flat list</span>
        <span class="n">src</span> <span class="o">=</span> <span class="n">sources</span><span class="p">;</span>
        <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
          <span class="n">sl</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
            <span class="n">sl</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
          <span class="n">src</span> <span class="o">=</span> <span class="n">sl</span><span class="p">;</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
      
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> <span class="c1"># numpy array</span>
        <span class="n">tile_shape</span> <span class="o">=</span> <span class="n">sources</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sources</span><span class="o">.</span><span class="n">flat</span><span class="p">);</span>
    <span class="c1">#create grid positions</span>
    <span class="n">tile_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itt</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">tile_shape</span><span class="p">]));</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">tile_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tile_positions</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  
  <span class="c1">#sources</span>
  <span class="n">sources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sources</span><span class="p">);</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile_positions</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">):</span>
    <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of sources = </span><span class="si">%d</span><span class="s1"> does not match grid positions = </span><span class="si">%d</span><span class="s1"> !&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile_positions</span><span class="p">)));</span>
  
  <span class="c1">#remove None type sources and ensure source classes</span>
  <span class="n">src</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">pos</span> <span class="o">=</span> <span class="p">[];</span>      
  <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">tile_positions</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Source</span><span class="p">):</span>
        <span class="n">src</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">src</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Source</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">s</span><span class="p">));</span>
      <span class="n">pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
  <span class="n">sources</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
  <span class="n">tile_positions</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
  
  <span class="c1">#tile data</span>
  <span class="n">tile_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tile_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>   
  <span class="n">source_dim</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  <span class="n">tile_position_to_source</span> <span class="o">=</span> <span class="p">{</span> <span class="n">p</span> <span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">tile_positions</span><span class="p">,</span> <span class="n">sources</span><span class="p">)};</span>
  
  <span class="c1"># alignments</span>
  <span class="k">if</span> <span class="n">alignments</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">alignments</span> <span class="o">=</span> <span class="p">[];</span>
    
    <span class="k">if</span> <span class="n">positions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>     
      <span class="k">if</span> <span class="n">overlaps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">overlaps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">overlaps</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">overlaps</span> <span class="o">=</span> <span class="p">[</span><span class="n">overlaps</span><span class="p">];</span>
      <span class="n">overlaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">overlaps</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
      <span class="n">overlaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">overlaps</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tile_dim</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">overlaps</span><span class="p">))),</span> <span class="s1">&#39;wrap&#39;</span><span class="p">);</span>

      <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile_dim</span><span class="p">):</span>      
        <span class="k">for</span> <span class="n">pre</span><span class="p">,</span><span class="n">pre_tpos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">tile_positions</span><span class="p">):</span>     
          <span class="k">if</span> <span class="n">pre_tpos</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tile_shape</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">d</span> <span class="k">else</span> <span class="n">pre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">overlaps</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">source_dim</span><span class="p">));</span>
            <span class="n">post_tpos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">d</span> <span class="k">else</span> <span class="n">p</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pre_tpos</span><span class="p">));</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">tile_position_to_source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">post_tpos</span><span class="p">,</span> <span class="kc">None</span><span class="p">);</span>
            <span class="k">if</span> <span class="n">post</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
              <span class="n">alignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Alignment</span><span class="p">(</span><span class="n">pre</span> <span class="o">=</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">post</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span><span class="p">))</span>
              
      <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span> <span class="c1"># ensure source positions are properly updated</span>
         <span class="n">s</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">s</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>    
  
    <span class="k">else</span><span class="p">:</span> <span class="c1">#positions are given</span>
      <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tile_dim</span><span class="p">):</span>      
        <span class="k">for</span> <span class="n">pre</span><span class="p">,</span><span class="n">pre_tpos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">tile_positions</span><span class="p">):</span>     
          <span class="k">if</span> <span class="n">pre_tpos</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">tile_shape</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">post_tpos</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">d</span> <span class="k">else</span> <span class="n">p</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pre_tpos</span><span class="p">));</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">tile_position_to_source</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">post_tpos</span><span class="p">,</span> <span class="kc">None</span><span class="p">);</span>
            <span class="k">if</span> <span class="n">post</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
              <span class="n">alignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Alignment</span><span class="p">(</span><span class="n">pre</span> <span class="o">=</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">post</span><span class="p">,</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">pre</span><span class="o">.</span><span class="n">ndim</span><span class="p">));</span>
              
      <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span> 
         <span class="n">s</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
         
    <span class="k">return</span> <span class="n">sources</span><span class="p">,</span> <span class="n">alignments</span><span class="p">,</span> <span class="n">tile_positions</span>
  

<span class="k">def</span> <span class="nf">_initialize_tiles_from_expression</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">tile_axes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_positions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">positions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">alignments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper to nitialize TiledLayout from an expression of file names.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">te</span><span class="o">.</span><span class="n">Expression</span><span class="p">):</span>
    <span class="n">expression</span> <span class="o">=</span> <span class="n">te</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="n">expression</span><span class="p">);</span>
  
  <span class="n">tag_names</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">tag_names</span><span class="p">();</span>
  <span class="k">if</span> <span class="n">tile_axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tile_axes</span> <span class="o">=</span> <span class="n">tag_names</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tile_axes</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tag_names</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The expression does not have the named pattern </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">);</span>
  <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tag_names</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tile_axes</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The expression has the named pattern </span><span class="si">%s</span><span class="s1"> that is not in tile_axes=</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">tile_axes</span><span class="p">));</span>
  <span class="c1">#print tile_axes, tag_names</span>
  
  
  <span class="c1">#construct tiling</span>
  <span class="n">files</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">_file_list</span><span class="p">(</span><span class="n">expression</span><span class="p">);</span>
  <span class="n">tile_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">expression</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">];</span>
  <span class="n">tile_values</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">tv</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">tile_axes</span><span class="p">)</span> <span class="k">for</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">tile_values</span><span class="p">];</span>
    
  <span class="k">if</span> <span class="n">tile_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">tile_positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tile_positions</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tile_values</span><span class="p">];</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tile_positions</span><span class="p">:</span>                    
      <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">tile_values</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
          <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
  <span class="k">else</span><span class="p">:</span>                      
    <span class="n">tile_positions</span> <span class="o">=</span> <span class="n">tile_values</span><span class="p">;</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">files</span><span class="p">;</span>
  
  <span class="n">tile_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tile_positions</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1"># assume that numbering starts with 0!</span>
    
  <span class="k">return</span> <span class="n">_initialize_tiles_from_sources</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">tile_positions</span><span class="o">=</span><span class="n">tile_positions</span><span class="p">,</span> <span class="n">tile_shape</span><span class="o">=</span><span class="n">tile_shape</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span> <span class="n">overlaps</span><span class="o">=</span><span class="n">overlaps</span><span class="p">,</span> <span class="n">alignments</span><span class="o">=</span><span class="n">alignments</span><span class="p">)</span>


<span class="c1">########################################################################################</span>
<span class="c1">### Basic functions</span>
<span class="c1">########################################################################################</span>

<div class="viewcode-block" id="check_alignments_and_sources"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.check_alignments_and_sources">[docs]</a><span class="k">def</span> <span class="nf">check_alignments_and_sources</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Checks consistency of alignments and sources.&quot;&quot;&quot;</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alignments</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Alignment </span><span class="si">%d</span><span class="s2">, pre source </span><span class="si">%d</span><span class="s2"> not in sources </span><span class="si">%r</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]));</span>                                         
        <span class="c1">#print a.pre, sources </span>
      <span class="k">return</span> <span class="kc">False</span><span class="p">;</span> 
        
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Alignment </span><span class="si">%d</span><span class="s2">, post source </span><span class="si">%d</span><span class="s2"> not in sources </span><span class="si">%r</span><span class="s2">!&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]));</span>
        <span class="c1">#print a.post, sources  </span>
      <span class="k">return</span> <span class="kc">False</span><span class="p">;</span>
  <span class="k">return</span> <span class="kc">True</span><span class="p">;</span></div>


<div class="viewcode-block" id="copy_sources_and_alignments"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.copy_sources_and_alignments">[docs]</a><span class="k">def</span> <span class="nf">copy_sources_and_alignments</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">alignments</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Copys the sources and alignments but not the underlying array data.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  sources : list of Source classes or None</span>
<span class="sd">    List of sources.</span>
<span class="sd">  alignments : list of Alignment classes</span>
<span class="sd">    The pairwise alignments.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  sources : list of Source classes or None</span>
<span class="sd">    Copied list of sources.</span>
<span class="sd">  alignments : list of Alignment classes</span>
<span class="sd">    Copied list of pairwise alignments.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">new_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">];</span>
  <span class="n">new_alignments</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">];</span>
  <span class="n">source_to_new</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">new_sources</span><span class="p">)};</span>
  <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">an</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">new_alignments</span><span class="p">):</span>
    <span class="n">an</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">source_to_new</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">];</span>
    <span class="n">an</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">source_to_new</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">new_sources</span><span class="p">,</span> <span class="n">new_alignments</span><span class="p">;</span></div>


<div class="viewcode-block" id="sources_from_alignments"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.sources_from_alignments">[docs]</a><span class="k">def</span> <span class="nf">sources_from_alignments</span><span class="p">(</span><span class="n">alignments</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns a unique list of sources from the given alignments.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  alignments : list of Alignment classes</span>
<span class="sd">    The pairwise alignments.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  sources : list of Source classes</span>
<span class="sd">    A unique list of the sources.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">sources</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
      <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
      <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">sources</span><span class="p">;</span></div>


<div class="viewcode-block" id="source_index"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.source_index">[docs]</a><span class="k">def</span> <span class="nf">source_index</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The index of a source in the list of sources.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  sources : list of source classes</span>
<span class="sd">    The list of sources to search in.</span>
<span class="sd">  source : Source class</span>
<span class="sd">    The source to search for.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  index : int or None</span>
<span class="sd">    Position of the source in the sources list, None if not found.</span>
<span class="sd">  &quot;&quot;&quot;</span>  
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">source</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">i</span><span class="p">;</span>  
  <span class="k">return</span> <span class="kc">None</span><span class="p">;</span></div>


<div class="viewcode-block" id="connected_components"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.connected_components">[docs]</a><span class="k">def</span> <span class="nf">connected_components</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">with_sources</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns the connected components of the alignments</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  alignments : list of Alignment classes</span>
<span class="sd">    The pairwise alignments.</span>
<span class="sd">  sources : list of Source classes or None</span>
<span class="sd">    Optional list of all sources.</span>
<span class="sd">  min_quality : float, tuple of floats or None</span>
<span class="sd">    The mininal quality for alignments to be included in the calculation.</span>
<span class="sd">  with_sources : bool</span>
<span class="sd">    If True, also return the sources in each component, as single sources might not appear in the alignment components.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  components : list of list of Alignment classes</span>
<span class="sd">    The connected components of the alignments.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">alignments</span> <span class="o">=</span> <span class="n">filter_alignments</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="n">min_quality</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">sources_from_alignments</span><span class="p">(</span><span class="n">alignments</span><span class="p">);</span>
  <span class="n">n_sources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">);</span>
  <span class="n">source_to_index</span> <span class="o">=</span> <span class="p">{</span> <span class="n">s</span> <span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">)};</span>
  <span class="c1">#print sources, alignments</span>
    
  <span class="c1">#determine connected compoenents</span>
  <span class="n">g</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">directed</span> <span class="o">=</span> <span class="kc">False</span><span class="p">);</span>    
  <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="n">n_sources</span><span class="p">);</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
    <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">source_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">],</span> <span class="n">source_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">]);</span>
  <span class="n">connected_components</span><span class="p">,</span> <span class="n">hist</span> <span class="o">=</span> <span class="n">gtt</span><span class="o">.</span><span class="n">label_components</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
  <span class="n">connected_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">connected_components</span><span class="o">.</span><span class="n">a</span><span class="p">);</span>                            
  <span class="n">n_components</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">);</span>
  <span class="c1">#print connected_components, hist, len(hist), np.max(hist)   </span>
  
  <span class="c1"># create components</span>
  <span class="n">components</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_components</span><span class="p">):</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">connected_components</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">comp</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">source_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">comp</span><span class="p">);</span>
                     
  <span class="k">if</span> <span class="n">with_sources</span><span class="p">:</span>
    <span class="n">component_sources</span> <span class="o">=</span> <span class="p">[[</span><span class="n">sources</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">connected_components</span> <span class="o">==</span> <span class="n">c</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_components</span><span class="p">)];</span>
    <span class="k">return</span> <span class="n">components</span><span class="p">,</span> <span class="n">component_sources</span>                              
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">components</span><span class="p">;</span></div>


<div class="viewcode-block" id="connected"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.connected">[docs]</a><span class="k">def</span> <span class="nf">connected</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns True if the alignments form a single connected component.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  alignments : list of Alignment classes</span>
<span class="sd">    The pairwise alignments.</span>
<span class="sd">  sources : list of Source classes or None</span>
<span class="sd">    Optional list of all sources.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  connected : bool</span>
<span class="sd">    True if the alignments form a single connected component.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">connected_components</span><span class="p">(</span><span class="n">alignments</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span></div>


<div class="viewcode-block" id="save_layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.save_layout">[docs]</a><span class="k">def</span> <span class="nf">save_layout</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">layout</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Saves a layout class to a file.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  filename : str</span>
<span class="sd">    The file to save the layout too.</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout to save.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  file_name : str</span>
<span class="sd">    The file name in which the layout was saved.</span>
<span class="sd">  &quot;&quot;&quot;</span>  
  <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">layout</span><span class="o">.</span><span class="n">as_virtual</span><span class="p">()],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">);</span>
  <span class="c1">#prevent np to add .npy to a .layout file</span>
  <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">);</span>
  <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span> 
  <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
  
  <span class="k">return</span> <span class="n">filename</span><span class="p">;</span></div>


<div class="viewcode-block" id="load_layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.load_layout">[docs]</a><span class="k">def</span> <span class="nf">load_layout</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Loads a layout class from a file</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  filename : str</span>
<span class="sd">    The file to load the layout from.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The loaded layout.</span>
<span class="sd">  &quot;&quot;&quot;</span>  
  <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
  <span class="n">layout</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">layout</span><span class="p">;</span></div>


<div class="viewcode-block" id="slice_layout_along_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.slice_layout_along_axis">[docs]</a><span class="k">def</span> <span class="nf">slice_layout_along_axis</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Slice a layout at a coordinate along an axis.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout to take the slice through.</span>
<span class="sd">  coordinate : int </span>
<span class="sd">    The coordinate of the slice along the slice axis in the original layout.</span>
<span class="sd">  axis : int</span>
<span class="sd">    The axis used to slice the layout.</span>
<span class="sd">    </span>
<span class="sd">  Note</span>
<span class="sd">  ----</span>
<span class="sd">  The sources of the layout will be sliced accordingly.</span>
<span class="sd">  The sources position along the axis is taken into account and sources not in </span>
<span class="sd">  the slice are droped. Thus, ensure the position along the slice axis is </span>
<span class="sd">  aligned, e.g. by using :func:`aling_layout_along_axis`.</span>
<span class="sd">  &quot;&quot;&quot;</span> 
  <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">layout</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">coordinate</span> <span class="o">-</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]];</span>
  
  <span class="n">new_layout</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
  <span class="n">new_layout</span><span class="o">.</span><span class="n">_sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">slice_along_axis</span><span class="p">(</span><span class="n">coordinate</span> <span class="o">=</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]</span>
  
  <span class="n">source_to_sliced</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="p">:</span> <span class="n">sl</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">sl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">new_layout</span><span class="o">.</span><span class="n">_sources</span><span class="p">)};</span>

  <span class="n">alignments</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">layout</span><span class="o">.</span><span class="n">alignments</span> <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="ow">in</span> <span class="n">sources</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">];</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span>  <span class="n">alignments</span><span class="p">:</span>
    <span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="o">=</span> <span class="n">source_to_sliced</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">];</span> 
    <span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="o">=</span> <span class="n">source_to_sliced</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">];</span>
    <span class="n">displacement</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">displacement</span><span class="p">;</span>
    <span class="n">a</span><span class="o">.</span><span class="n">displacement</span> <span class="o">=</span> <span class="n">displacement</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">displacement</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
  <span class="n">new_layout</span><span class="o">.</span><span class="n">_alignments</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">layout</span><span class="o">.</span><span class="n">_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">new_layout</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">_shape</span><span class="p">;</span>
    <span class="n">new_layout</span><span class="o">.</span><span class="n">_shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
  
  <span class="k">if</span> <span class="n">layout</span><span class="o">.</span><span class="n">_position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">new_layout</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">position</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
    <span class="n">new_layout</span><span class="o">.</span><span class="n">_position</span> <span class="o">=</span> <span class="n">position</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
  
  <span class="c1">#new_layout.coordinate = coordinate;</span>
  <span class="c1">#new_layout.axis = axis;</span>
  <span class="c1">#new_layout.slicing = tuple(slice(None) if d != axis else coordinate for d in range(layout.ndim))</span>
  
  <span class="k">return</span> <span class="n">new_layout</span><span class="p">;</span></div>



<span class="c1">########################################################################################</span>
<span class="c1">### Alignment</span>
<span class="c1">########################################################################################</span>

<div class="viewcode-block" id="align_2_sources"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.align_2_sources">[docs]</a><span class="k">def</span> <span class="nf">align_2_sources</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Align 2 sources using root mean square difference measure.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  src1, src2 : array like sources</span>
<span class="sd">    Sources to align.</span>
<span class="sd">  max_shifts : int, tuple or list of tuples of ints</span>
<span class="sd">    The minimum and maximum shifts along the different axes to consider for alignment.</span>
<span class="sd">  clip : number or None</span>
<span class="sd">    If not None, clip the sources at this value when calculating the alignment.</span>
<span class="sd">  background : number or None</span>
<span class="sd">    If not None, if the values in the overlap region are less than this number make alignment return -inf quality as there is no signal to use for alignment.</span>
<span class="sd">  normalize : bool</span>
<span class="sd">    Use normalized cross correlation, instead of co-variance, i.e. subtract mean and divide by std.</span>
<span class="sd">  verbose : bool </span>
<span class="sd">    If True print progress information.</span>
<span class="sd">        </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  shift : array </span>
<span class="sd">    The additional shift between the first and second source for optimal pairwise alignment.</span>
<span class="sd">  quality : float</span>
<span class="sd">    Quality measure.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">#if not isinstance(src1, SourceRegion):</span>
  <span class="c1">#  src1 = Source(source=src1);</span>
  <span class="c1">#if not isinstance(src2, SourceRegion):</span>
  <span class="c1">#  src2 = Source(source=src2);</span>
  
  <span class="k">if</span> <span class="n">src1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="n">src2</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Sources expected to have same dimension, found </span><span class="si">%d</span><span class="s1"> and </span><span class="si">%d</span><span class="s1"> dimensional images!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">src2</span><span class="o">.</span><span class="n">ndim</span><span class="p">));</span>
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>  
  
  <span class="n">slice1</span><span class="p">,</span> <span class="n">slice2</span><span class="p">,</span> <span class="n">pad1</span><span class="p">,</span> <span class="n">pad2</span><span class="p">,</span> <span class="n">slice_no_pad1</span><span class="p">,</span> <span class="n">slice_no_pad2</span><span class="p">,</span> <span class="n">shift_min</span><span class="p">,</span> <span class="n">shift_max</span><span class="p">,</span> <span class="n">fft_roi</span> <span class="o">=</span> <span class="n">_slicing_and_padding_for_fft</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">);</span>                                                                                                                        
   
  <span class="c1"># format max shifts</span>
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_format_max_shifts</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">ndim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  <span class="n">shift_min</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">shift_max</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">];</span>
  
  <span class="k">if</span> <span class="n">debug</span> <span class="ow">or</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: positions = </span><span class="si">%r</span><span class="s1">,</span><span class="si">%r</span><span class="s1">, shapes= </span><span class="si">%r</span><span class="s1">,</span><span class="si">%r</span><span class="s1"> shifts=</span><span class="si">%r</span><span class="s1">,</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">src1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">src2</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">shift_min</span><span class="p">,</span> <span class="n">shift_max</span><span class="p">));</span>
  
                                                                                                                           
  <span class="c1"># extract relevant data    </span>
  <span class="n">i1</span> <span class="o">=</span> <span class="n">src1</span><span class="p">[</span><span class="n">slice1</span><span class="p">];</span>
  <span class="n">i2</span> <span class="o">=</span> <span class="n">src2</span><span class="p">[</span><span class="n">slice2</span><span class="p">];</span>
  
  <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: data shapes = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">i2</span><span class="o">.</span><span class="n">shape</span><span class="p">));</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: overlaping slices = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slice1</span><span class="p">,</span> <span class="n">slice2</span><span class="p">));</span>                                         
                                                      
  <span class="c1"># clip images for better alignment performance  </span>
  <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1">#if sources are memmaps copy to array</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i1</span><span class="p">);</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i2</span><span class="p">);</span>
                 
    <span class="c1">#clip</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
      <span class="k">if</span> <span class="n">clip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i1</span><span class="p">[</span><span class="n">i1</span> <span class="o">&lt;</span> <span class="n">clip</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clip</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">i2</span><span class="p">[</span><span class="n">i2</span> <span class="o">&lt;</span> <span class="n">clip</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clip</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">if</span> <span class="n">clip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i1</span><span class="p">[</span><span class="n">i1</span> <span class="o">&gt;</span> <span class="n">clip</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clip</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">i2</span><span class="p">[</span><span class="n">i2</span> <span class="o">&gt;</span> <span class="n">clip</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clip</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">i1</span><span class="p">[</span><span class="n">i1</span> <span class="o">&gt;</span> <span class="n">clip</span><span class="p">]</span> <span class="o">=</span> <span class="n">clip</span><span class="p">;</span>
      <span class="n">i2</span><span class="p">[</span><span class="n">i2</span> <span class="o">&gt;</span> <span class="n">clip</span><span class="p">]</span> <span class="o">=</span> <span class="n">clip</span><span class="p">;</span>
  
  <span class="c1">#check if one of the images is background</span>
  <span class="k">if</span> <span class="n">background</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">background</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">aa1</span> <span class="o">=</span> <span class="n">aa2</span> <span class="o">=</span> <span class="n">background</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">aa1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">i1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">background</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">aa2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">i2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="n">background</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>         
      <span class="n">bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">i1</span> <span class="o">&gt;=</span> <span class="n">background</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>              
      <span class="n">bad</span> <span class="o">=</span> <span class="n">bb</span> <span class="o">&lt;</span> <span class="n">aa1</span><span class="p">;</span>
      <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">bad</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: Not enough pixels </span><span class="si">%d</span><span class="s1">&lt;</span><span class="si">%d</span><span class="s1"> above background </span><span class="si">%d</span><span class="s1"> in source </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">aa1</span><span class="p">,</span> <span class="n">background</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src1</span><span class="o">.</span><span class="n">tile_position</span><span class="p">));</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">bad</span><span class="p">:</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">i2</span> <span class="o">&gt;=</span> <span class="n">background</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>            
        <span class="n">bad</span> <span class="o">=</span> <span class="n">bb</span> <span class="o">&lt;</span> <span class="n">aa2</span><span class="p">;</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">bad</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: Not enough pixels </span><span class="si">%d</span><span class="s1">&lt;</span><span class="si">%d</span><span class="s1"> above background </span><span class="si">%d</span><span class="s1"> in source </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">bb</span><span class="p">,</span> <span class="n">aa2</span><span class="p">,</span> <span class="n">background</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">src2</span><span class="o">.</span><span class="n">tile_position</span><span class="p">));</span>    
    <span class="k">else</span><span class="p">:</span> <span class="c1">#background is int                                                       </span>
      <span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">i1</span> <span class="o">&lt;</span> <span class="n">background</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">i2</span> <span class="o">&lt;</span> <span class="n">background</span><span class="p">)</span>        
      <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">bad</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: No good signal between </span><span class="si">%r</span><span class="s1"> and </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">tile_position</span><span class="p">,</span> <span class="n">src2</span><span class="o">.</span><span class="n">tile_position</span><span class="p">));</span>
    <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>                                                              
      <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">i1</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>      
      <span class="n">quality</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">shift</span><span class="p">,</span> <span class="n">quality</span><span class="p">;</span>
  
  <span class="c1"># ensure doulbe images for fft</span>
  <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">);</span>
  <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">);</span>
  
  <span class="c1">#normalize the image</span>
  <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
    <span class="n">i1</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">i1</span><span class="p">);</span>
    <span class="n">i2</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">i2</span><span class="p">);</span>
    <span class="n">i1</span> <span class="o">*=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">i1</span><span class="o">*</span><span class="n">i1</span><span class="p">));</span>
    <span class="n">i2</span> <span class="o">*=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">i2</span><span class="o">*</span><span class="n">i2</span><span class="p">));</span>
  
  <span class="c1">#pad to same size + zeros for overlap in fft</span>
  <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="n">pad1</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">);</span>
  <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="n">pad2</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">);</span>
  
  <span class="c1">#weights</span>
  <span class="n">w1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">i1</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span>
  <span class="n">w1</span><span class="p">[</span><span class="n">slice_no_pad1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>               
  <span class="n">w1fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">w1</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">([</span><span class="n">s1</span><span class="o">.</span><span class="n">start</span> <span class="o">!=</span> <span class="n">s2</span><span class="o">.</span><span class="n">start</span> <span class="ow">or</span> <span class="n">s1</span><span class="o">.</span><span class="n">stop</span> <span class="o">!=</span> <span class="n">s2</span><span class="o">.</span><span class="n">stop</span> <span class="k">for</span> <span class="n">s1</span><span class="p">,</span><span class="n">s2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">slice_no_pad1</span><span class="p">,</span> <span class="n">slice_no_pad2</span><span class="p">)]):</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">i2</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span>
    <span class="n">w2</span><span class="p">[</span><span class="n">slice_no_pad2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">w2fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">w2</span><span class="p">);</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="n">w1</span><span class="p">;</span>
    <span class="n">w2fft</span> <span class="o">=</span> <span class="n">w1fft</span><span class="p">;</span>
  
  <span class="c1">#debug</span>
  <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">debug</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
      <span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">95</span><span class="o">+</span><span class="n">debug</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">i1</span><span class="o">.</span><span class="n">T</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;i1&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">w1</span><span class="o">.</span><span class="n">T</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;w1&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">i2</span><span class="o">.</span><span class="n">T</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;i2&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">w2</span><span class="o">.</span><span class="n">T</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;w2&#39;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">99</span><span class="o">+</span><span class="n">debug</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">i1</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">256</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">i2</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span> <span class="o">=</span> <span class="mi">256</span><span class="p">);</span>
 
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: shapes = </span><span class="si">%r</span><span class="s1">, </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">i2</span><span class="o">.</span><span class="n">shape</span><span class="p">));</span>
  
  <span class="c1"># fft</span>
  <span class="n">i1fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">i1</span><span class="p">);</span> 
  <span class="n">i2fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">i2</span><span class="p">);</span>
  <span class="n">s1fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">i1</span> <span class="o">*</span> <span class="n">i1</span><span class="p">);</span>  
  <span class="n">s2fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">i2</span> <span class="o">*</span> <span class="n">i2</span><span class="p">);</span>
  <span class="n">wssd</span> <span class="o">=</span> <span class="n">w1fft</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">s2fft</span><span class="p">)</span> <span class="o">+</span> <span class="n">s1fft</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">w2fft</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i1fft</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">i2fft</span><span class="p">);</span>

  <span class="c1">#if verbose:</span>
  <span class="c1">#  print &#39;FFT done!&#39;;</span>

  <span class="n">wssd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">wssd</span><span class="p">);</span>
  <span class="n">nrm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">w1fft</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">w2fft</span><span class="p">));</span>
  
  <span class="c1">#if verbose:</span>
  <span class="c1">#  print &#39;iFFT done!&#39;;  </span>
  
  <span class="c1"># debug</span>
  <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">96</span><span class="o">+</span><span class="n">debug</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wssd</span><span class="o">.</span><span class="n">T</span><span class="p">));</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;wssd&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nrm</span><span class="o">.</span><span class="n">T</span><span class="p">));</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;nrm&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wssd</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nrm</span><span class="o">.</span><span class="n">T</span><span class="p">));</span>
  
  <span class="c1"># range of interest</span>
  <span class="n">wssd</span> <span class="o">=</span> <span class="n">wssd</span><span class="p">[</span><span class="n">fft_roi</span><span class="p">];</span>
  <span class="n">nrm</span>  <span class="o">=</span> <span class="n">nrm</span><span class="p">[</span><span class="n">fft_roi</span><span class="p">];</span>
  
  <span class="c1"># normalize</span>
  <span class="n">eps</span> <span class="o">=</span>  <span class="mf">2.2204e-16</span><span class="p">;</span>
  <span class="n">nrm</span><span class="p">[</span><span class="n">nrm</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">]</span> <span class="o">=</span> <span class="n">eps</span><span class="p">;</span>
  <span class="n">cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wssd</span> <span class="o">/</span> <span class="n">nrm</span><span class="p">);</span>
  
  <span class="c1"># debug</span>
  <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">97</span><span class="o">+</span><span class="n">debug</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wssd</span><span class="o">.</span><span class="n">T</span><span class="p">));</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;wssd&#39;</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nrm</span><span class="o">.</span><span class="n">T</span><span class="p">));</span> <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;nrm&#39;</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wssd</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nrm</span><span class="o">.</span><span class="n">T</span><span class="p">));</span>
  
  <span class="c1"># find optimal shift</span>
  <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">cc</span><span class="p">);</span>
  <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span>
  <span class="n">quality</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">cc</span><span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">shift</span><span class="p">)]);</span>
  <span class="c1">#print shift, quality</span>
  
  <span class="c1">#debug</span>
  <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
  
  <span class="c1"># correct for cutting</span>
  <span class="n">shift</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">m</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">shift_min</span><span class="p">));</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: done! shift = </span><span class="si">%r</span><span class="s1">, quality = </span><span class="si">%.2e</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">quality</span><span class="p">));</span>
  
  <span class="k">return</span> <span class="n">shift</span><span class="p">,</span> <span class="n">quality</span><span class="p">;</span></div>



<div class="viewcode-block" id="overlap"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.overlap">[docs]</a><span class="k">def</span> <span class="nf">overlap</span><span class="p">(</span><span class="n">region1</span><span class="p">,</span> <span class="n">region2</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Overlap between two regions.&quot;&quot;&quot;</span>
  <span class="n">ovl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">region1</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">region2</span><span class="o">.</span><span class="n">lower</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">ovu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">region1</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">region2</span><span class="o">.</span><span class="n">upper</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ovu</span> <span class="o">-</span> <span class="n">ovl</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Overlap</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="n">ovl</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">ovu</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">region1</span><span class="p">,</span> <span class="n">region2</span><span class="p">]);</span></div>


<span class="k">def</span> <span class="nf">_overlap_with_shifts</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Calculates the maximal overlap between two sources given maximal shifts.</span>

<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  overlap1 : Overlap</span>
<span class="sd">    The overlap between source 1 and source 2 if the latter is shifted the</span>
<span class="sd">    minimal shift and its shape is enalarged by the shift differences.</span>
<span class="sd">  overlap2 : Overlap</span>
<span class="sd">    The overlap between source 1 and source 2 if the former is negatively </span>
<span class="sd">    shifted the maximal shift  and its shape enlarged by the shift </span>
<span class="sd">    differences.</span>
<span class="sd">    </span>
<span class="sd">  Note</span>
<span class="sd">  ----</span>
<span class="sd">  Overlap1 can be used to extract the maximal region in source 1 that will</span>
<span class="sd">  be covered by source 2 including the shifts.</span>
<span class="sd">  Overlap2 can be used to extract the maximal region in source 2 that will </span>
<span class="sd">  be covered by source 1 including the shifts.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># format max shifts</span>
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_format_max_shifts</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">src1</span><span class="o">.</span><span class="n">ndim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  <span class="n">shift_min</span>  <span class="o">=</span> <span class="n">max_shifts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">shift_max</span>  <span class="o">=</span> <span class="n">max_shifts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">];</span>
  
  <span class="c1"># calculate overlap regions from positions, shapes and max_shifts</span>
  <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">);</span>
  <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">);</span>
  <span class="n">s1</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span> 
  <span class="n">s2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
  <span class="c1">#print p1, p2, s1, s2, sh_min, sh_max</span>
    
  <span class="n">s1a</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p1</span><span class="p">),</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">s1</span><span class="p">);</span>
  <span class="n">s2a</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p2</span> <span class="o">+</span> <span class="n">shift_min</span><span class="p">),</span> <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s2</span> <span class="o">+</span> <span class="n">shift_max</span> <span class="o">-</span> <span class="n">shift_min</span><span class="p">));</span>  
  <span class="n">overlap_a</span> <span class="o">=</span> <span class="n">overlap</span><span class="p">(</span><span class="n">s1a</span><span class="p">,</span> <span class="n">s2a</span><span class="p">);</span>
  <span class="k">if</span> <span class="n">overlap_a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The two sources will never overlap, increase max_shifts or change source positions!&#39;</span><span class="p">);</span>
  
  <span class="n">s1b</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">shift_max</span><span class="p">),</span> <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s1</span> <span class="o">+</span> <span class="n">shift_max</span> <span class="o">-</span> <span class="n">shift_min</span><span class="p">));</span>
  <span class="n">s2b</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p2</span><span class="p">),</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">s2</span><span class="p">);</span>
  <span class="n">overlap_b</span> <span class="o">=</span> <span class="n">overlap</span><span class="p">(</span><span class="n">s1b</span><span class="p">,</span> <span class="n">s2b</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="n">overlap_a</span><span class="p">,</span> <span class="n">overlap_b</span>


<span class="k">def</span> <span class="nf">_slicing_and_padding_for_fft</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">):</span>
  
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">);</span>
  <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">);</span>
  
  <span class="c1">#max overlap regions          </span>
  <span class="n">overlap1</span><span class="p">,</span> <span class="n">overlap2</span> <span class="o">=</span> <span class="n">_overlap_with_shifts</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">);</span>  
  
  <span class="c1">#shifts                                         </span>
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_format_max_shifts</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">src1</span><span class="o">.</span><span class="n">ndim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  <span class="n">shift_min</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">shift_max</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">];</span>
  
  <span class="c1">#correct for shift vs range</span>
  <span class="n">shift_max</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  
  <span class="c1">#source slicing</span>
  <span class="n">slice1</span> <span class="o">=</span> <span class="n">overlap1</span><span class="o">.</span><span class="n">local_slicing</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">src1</span><span class="p">);</span>
  <span class="n">slice2</span> <span class="o">=</span> <span class="n">overlap2</span><span class="o">.</span><span class="n">local_slicing</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">src2</span><span class="p">);</span>                              
  
  <span class="c1">#correct max shifts to maximal useful if overlap is smaller</span>
  <span class="n">p1l</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">start</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slice1</span><span class="p">];</span>
  <span class="n">p1u</span> <span class="o">=</span> <span class="n">p1</span> <span class="o">+</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">stop</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slice1</span><span class="p">];</span>
  <span class="n">p2l</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">start</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slice2</span><span class="p">];</span>
  <span class="n">p2u</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">+</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">stop</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">slice2</span><span class="p">];</span>            
  <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
    <span class="n">shift_min</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">shift_min</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">p1l</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2u</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
    <span class="n">shift_max</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">shift_max</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">p1u</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2l</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
    
  <span class="c1">#padding to make equal size and account for shifts / correlations due to &#39;wrap around&#39; of fft</span>
  <span class="n">pad1</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">pad2</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
    <span class="n">l_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p1l</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">p2l</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift_min</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
    <span class="n">l_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p1l</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">p2l</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift_max</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
    <span class="n">u_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1u</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">p2u</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift_min</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
    <span class="n">u_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1u</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">p2u</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift_max</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
    <span class="n">s_min</span> <span class="o">=</span> <span class="n">u_min</span> <span class="o">-</span> <span class="n">l_min</span><span class="p">;</span>
    <span class="n">s_max</span> <span class="o">=</span> <span class="n">u_max</span> <span class="o">-</span> <span class="n">l_max</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">s_min</span> <span class="o">&gt;=</span> <span class="n">s_max</span><span class="p">:</span>
      <span class="n">pad1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p1l</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">l_min</span><span class="p">,</span> <span class="n">u_min</span> <span class="o">-</span> <span class="n">p1u</span><span class="p">[</span><span class="n">d</span><span class="p">]));</span>
      <span class="n">pad2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p2l</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift_min</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">l_min</span><span class="p">,</span> <span class="n">u_min</span> <span class="o">-</span> <span class="p">(</span><span class="n">p2u</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">+</span><span class="n">shift_min</span><span class="p">[</span><span class="n">d</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">pad1</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p1l</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">l_max</span><span class="p">,</span> <span class="n">u_max</span> <span class="o">-</span> <span class="n">p1u</span><span class="p">[</span><span class="n">d</span><span class="p">]));</span>
      <span class="n">pad2</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">p2l</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">shift_max</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">l_max</span><span class="p">,</span> <span class="n">u_max</span> <span class="o">-</span> <span class="p">(</span><span class="n">p2u</span><span class="p">[</span><span class="n">d</span><span class="p">]</span><span class="o">+</span><span class="n">shift_max</span><span class="p">[</span><span class="n">d</span><span class="p">])))</span>
  
  <span class="c1">#non padded slices</span>
  <span class="n">s12</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">l</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">p1u</span><span class="p">,</span> <span class="n">p1l</span><span class="p">,</span> <span class="n">pad1</span><span class="p">));</span>
  <span class="n">slice_no_pad1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pad1</span><span class="p">,</span> <span class="n">s12</span><span class="p">));</span>
  <span class="n">slice_no_pad2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pad2</span><span class="p">,</span> <span class="n">s12</span><span class="p">));</span>
  
  <span class="c1"># range of interest</span>
  <span class="n">fft_roi</span> <span class="o">=</span> <span class="p">();</span>
  <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">pad2</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># right pad</span>
      <span class="n">fft_roi</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="n">shift_max</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_min</span><span class="p">[</span><span class="n">d</span><span class="p">])),)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># left pad</span>
      <span class="n">fft_roi</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">shift_max</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">shift_min</span><span class="p">[</span><span class="n">d</span><span class="p">]),</span> <span class="kc">None</span><span class="p">),);</span> 
                     
  <span class="k">return</span> <span class="n">slice1</span><span class="p">,</span> <span class="n">slice2</span><span class="p">,</span> <span class="n">pad1</span><span class="p">,</span> <span class="n">pad2</span><span class="p">,</span> <span class="n">slice_no_pad1</span><span class="p">,</span> <span class="n">slice_no_pad2</span><span class="p">,</span> <span class="n">shift_min</span><span class="p">,</span> <span class="n">shift_max</span><span class="p">,</span> <span class="n">fft_roi</span>



<div class="viewcode-block" id="align_2_sources_along_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.align_2_sources_along_axis">[docs]</a><span class="k">def</span> <span class="nf">align_2_sources_along_axis</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Align 2 images along a specified axis.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  src1, src2 : 2d arrays</span>
<span class="sd">    The images to align.</span>
<span class="sd">  axis : int</span>
<span class="sd">    The alignment axis.</span>
<span class="sd">  overlap : tuple of int</span>
<span class="sd">    The minimum and maximum overlap along the alignment axis</span>
<span class="sd">  max_shifts : int, tuple of int or list of tuple of ints</span>
<span class="sd">    The minimum and maximum shifts along the different axes. Only the values for the axes orthogonal to the alignment axis are used.</span>
<span class="sd">  clip : number or None</span>
<span class="sd">    If not None, clip the sources at this value when calculating the alignment.</span>
<span class="sd">  background : number or None</span>
<span class="sd">    If not None, if the values in the overlap region are less than this number make alignment return -inf quality as there is no signal to use for alignment.</span>
<span class="sd">  verbose : bool </span>
<span class="sd">    If True, print progress information.</span>
<span class="sd">        </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  shift : array </span>
<span class="sd">    The shift of the second image wrt to the first for optimal pairwise alignment.</span>
<span class="sd">  quality : float</span>
<span class="sd">    A quality measure of the alignment.</span>
<span class="sd">    </span>
<span class="sd">  Note</span>
<span class="sd">  ----</span>
<span class="sd">  This routine simply translates overlap specifications in one axis direction into max_shifts for use with align_2_sources.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">SourceRegion</span><span class="p">):</span>
    <span class="n">src1</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">src1</span><span class="p">);</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src2</span><span class="p">,</span> <span class="n">SourceRegion</span><span class="p">):</span>
    <span class="n">src2</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">src2</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">src1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="n">src2</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Images expected to have the same dimensions, found </span><span class="si">%d</span><span class="s1"> and </span><span class="si">%d</span><span class="s1"> dimensional images!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">src2</span><span class="o">.</span><span class="n">ndim</span><span class="p">));</span>
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  <span class="n">s1</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
  <span class="n">s2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
  
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">_format_max_shifts</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>
  
  <span class="c1"># overlaps</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">overlap</span><span class="p">,</span><span class="nb">int</span><span class="p">):</span>
    <span class="n">overlap</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">overlap</span><span class="p">);</span>
  <span class="n">p1</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">;</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
  <span class="n">shifts</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="n">axis</span><span class="p">:</span>
      <span class="n">max_ovl</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">s1</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">s2</span><span class="p">[</span><span class="n">axis</span><span class="p">]);</span>
      <span class="n">max_ovl</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_ovl</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">overlap</span><span class="p">));</span>
      <span class="n">min_ovl</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_ovl</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">overlap</span><span class="p">));</span>
      <span class="n">min_ovl</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">min_ovl</span><span class="p">);</span>
      <span class="n">shifts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">s1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">-</span><span class="n">max_ovl</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">-</span><span class="n">p2</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">s1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">-</span><span class="n">min_ovl</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">-</span><span class="n">p2</span><span class="p">[</span><span class="n">axis</span><span class="p">]));</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">[</span><span class="n">d</span><span class="p">]);</span>
  
  <span class="k">return</span> <span class="n">align_2_sources</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">)</span></div>


<div class="viewcode-block" id="max_intensity_projection"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.max_intensity_projection">[docs]</a><span class="k">def</span> <span class="nf">max_intensity_projection</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns the max intensity projection along a specified axis.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  data : array</span>
<span class="sd">    The data array.</span>
<span class="sd">  axis : int</span>
<span class="sd">    The axis along which to perform the maximum projection.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  mip : array</span>
<span class="sd">    The maximum intensity projection of the data along axis.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">);</span></div>


<div class="viewcode-block" id="align_2_sources_along_axis_mip"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.align_2_sources_along_axis_mip">[docs]</a><span class="k">def</span> <span class="nf">align_2_sources_along_axis_mip</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">with_mip</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Align 2 images orthogonal to a spcified axis using max projection</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  src1, src2: 2d arrays</span>
<span class="sd">    The sources to align.</span>
<span class="sd">  axis: int</span>
<span class="sd">    Axis for max intensity projection (mip).</span>
<span class="sd">  depth : int</span>
<span class="sd">    The depth to use for the maximum intensity projection along the mip axis.</span>
<span class="sd">  max_shifts: tuple of int</span>
<span class="sd">    The minimum and maximum shifts along the axes.</span>
<span class="sd">  clip : number or None</span>
<span class="sd">    If not None, clip the soruces at this value when calculating the alignment.</span>
<span class="sd">  background : number or None</span>
<span class="sd">    If not None, if the values in the overlap region are less than this number make alignment return -inf quality as there is no signal to use for alignment.</span>
<span class="sd">  verbose : bool </span>
<span class="sd">    If True, print progress information.</span>
<span class="sd">  with_mip: bool</span>
<span class="sd">    If True, also return the maximum projections used to aling the two sources.</span>
<span class="sd">        </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  shift : array </span>
<span class="sd">    The shift of the second image wrt to the first for optimal pairwise alignment orthogonal to mip axis</span>
<span class="sd">  quality : float</span>
<span class="sd">    The quality measure of the alignment.</span>
<span class="sd">  mips : tuple of arrays</span>
<span class="sd">    Optional maximum intensity projections.</span>
<span class="sd">  &quot;&quot;&quot;</span>  
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">SourceRegion</span><span class="p">):</span>
    <span class="n">src1</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">src1</span><span class="p">);</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">src2</span><span class="p">,</span> <span class="n">SourceRegion</span><span class="p">):</span>
    <span class="n">src2</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">src2</span><span class="p">);</span>               
  
  <span class="k">if</span> <span class="n">src1</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="n">src2</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Images expected to have the same dimensions, found </span><span class="si">%d</span><span class="s1"> and </span><span class="si">%d</span><span class="s1"> dimensional images!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">ndim</span><span class="p">,</span> <span class="n">src2</span><span class="o">.</span><span class="n">ndim</span><span class="p">));</span>
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">_format_max_shifts</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_shifts</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
  
  <span class="n">s1</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
  <span class="n">s2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
  
  <span class="c1"># max intensity projections </span>
  <span class="n">sub1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">ndim</span><span class="p">;</span>
  <span class="n">sub1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">-</span> <span class="n">depth</span><span class="p">),</span> <span class="kc">None</span><span class="p">);</span>
  <span class="n">sub1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sub1</span><span class="p">);</span>
  
  <span class="n">sub2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">ndim</span><span class="p">;</span>
  <span class="n">sub2</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">s2</span><span class="p">[</span><span class="n">axis</span><span class="p">]));</span>
  <span class="n">sub2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sub2</span><span class="p">);</span>          
              
  <span class="c1"># calculate max projection along axis  </span>
  <span class="n">mip1</span> <span class="o">=</span> <span class="n">max_intensity_projection</span><span class="p">(</span><span class="n">src1</span><span class="p">[</span><span class="n">sub1</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">);</span>
  <span class="n">mip2</span> <span class="o">=</span> <span class="n">max_intensity_projection</span><span class="p">(</span><span class="n">src2</span><span class="p">[</span><span class="n">sub2</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">);</span>                               
  
  <span class="c1">#add position information</span>
  <span class="n">p1</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
  <span class="n">p2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
  <span class="c1">#print axis, p1, p2</span>
  
  <span class="n">mip1</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">mip1</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="n">p1</span><span class="p">,</span> <span class="n">tile_position</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">tile_position</span><span class="p">);</span>
  <span class="n">mip2</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">mip2</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="n">p2</span><span class="p">,</span> <span class="n">tile_position</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">tile_position</span><span class="p">);</span>
  <span class="c1">#print mip1, mip2              </span>
  
  <span class="n">mip_shift</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">align_2_sources</span><span class="p">(</span><span class="n">mip1</span><span class="p">,</span> <span class="n">mip2</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">);</span>
  
  <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span> 
  <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">axis</span><span class="p">:</span>
      <span class="n">shift</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">mip_shift</span><span class="p">[</span><span class="n">k</span><span class="p">];</span>
      <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">shift</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shift</span><span class="p">);</span>
  
  <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">quality</span><span class="p">);</span>
  <span class="k">if</span> <span class="n">with_mip</span><span class="p">:</span>
    <span class="n">res</span> <span class="o">+=</span> <span class="p">((</span><span class="n">mip1</span><span class="p">,</span> <span class="n">mip2</span><span class="p">),);</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span></div>


<div class="viewcode-block" id="align_layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.align_layout">[docs]</a><span class="k">def</span> <span class="nf">align_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Aligns the sources in a layout.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout of the sources.</span>
<span class="sd">  max_shifts : int, tuple of ints or list of list of tuple of ints</span>
<span class="sd">    The maximal shifts of the images with respect to each other along each dimension.</span>
<span class="sd">  clip : number or None</span>
<span class="sd">    If not None, clip the soruces at this value when calculating the alignment.</span>
<span class="sd">  background : number or None</span>
<span class="sd">    If not None, if the values in the overlap region are less than this number make alignment return -inf quality as there is no signal to use for alignment.</span>
<span class="sd">  processes : int or &#39;serial&#39;</span>
<span class="sd">    Number of processor to use for parallel processing, if &#39;serial&#39; process in serial.</span>
<span class="sd">  verbose : bool </span>
<span class="sd">    If True, print progress information.</span>
<span class="sd">    </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout with the new alignments.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">Layout</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A Layout class is expected as input!&quot;</span><span class="p">);</span>
  <span class="c1">#source_to_index = {s : i for i,s in enumerate(layout.sources)};</span>
  
  <span class="n">n_alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">n_alignments</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: Aligning </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">layout</span><span class="p">);</span>
    
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">processes</span> <span class="o">!=</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">();</span>
  
  <span class="n">_align</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_align_layout</span><span class="p">,</span> <span class="n">n_alignments</span><span class="o">=</span><span class="n">n_alignments</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span> 
                      <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
  
  <span class="k">if</span> <span class="n">processes</span> <span class="o">==</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">_align</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">)];</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">layout</span><span class="o">.</span><span class="n">sources_as_virtual</span><span class="p">();</span>
    <span class="n">alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">;</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
      <span class="n">results</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_align</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_alignments</span><span class="p">));</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>
    <span class="c1">#layout.sources_as_real()</span>
  
  <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
    <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span><span class="p">;</span>
    <span class="n">a</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">quality</span><span class="p">;</span>
    
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Alignment: Aligning </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">layout</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="n">layout</span><span class="p">;</span></div>


<span class="nd">@ptb</span><span class="o">.</span><span class="n">parallel_traceback</span>
<span class="k">def</span> <span class="nf">_align_layout</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">,</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="c1">#id1 = source_to_index[pre]; id2 = source_to_index[post];</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: aligning source </span><span class="si">%d</span><span class="s1"> with </span><span class="si">%d</span><span class="s1">, alignment pair </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">));</span>  
  
  <span class="k">return</span> <span class="n">align_2_sources</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span> 
                         <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">);</span>



<div class="viewcode-block" id="align_layout_on_tiling"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.align_layout_on_tiling">[docs]</a><span class="k">def</span> <span class="nf">align_layout_on_tiling</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Calculates shifts of the sources on a gird layout that aligns them.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : TiledLayout </span>
<span class="sd">    The grid layout of the sources.</span>
<span class="sd">  overlaps : tuple of ints</span>
<span class="sd">    The overlaps along the grid axes.</span>
<span class="sd">  max_shifts : tuple or list of tuple of ints</span>
<span class="sd">    The maximal shifts along the axes directions.</span>
<span class="sd">  clip : number or None</span>
<span class="sd">    If not None, clip the soruces at this value when calculating the alignment.</span>
<span class="sd">  background : number or None</span>
<span class="sd">    If not None, if the values in the overlap region are less than this number make alignment return -inf quality as there is no signal to use for alignment.</span>
<span class="sd">  processes : int or &#39;serial&#39; </span>
<span class="sd">    Number of processor to use for parallel processing, if &#39;serial&#39; process in serial.</span>
<span class="sd">  verbose : bool </span>
<span class="sd">    If True, print progress information.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  layout : TiledLayout class</span>
<span class="sd">    The updated layout after alignment.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">Layout</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A TiledLayout class is expected as input!&quot;</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: Aligning </span><span class="si">%r</span><span class="s1"> on gird!&#39;</span> <span class="o">%</span> <span class="n">layout</span><span class="p">);</span>
 

  <span class="n">alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">;</span>
  <span class="n">n_alignments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alignments</span><span class="p">);</span>
  
  <span class="c1">#source_to_index = {s : i for i,s in enumerate(layout.sources)};</span>
  
  <span class="n">axes</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">):</span>
    <span class="c1">#alignment axis</span>
    <span class="n">pos_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">tile_position</span><span class="p">);</span>
    <span class="n">pos_post</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">tile_position</span><span class="p">);</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pos_pre</span> <span class="o">-</span> <span class="n">pos_post</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
  
  
  <span class="n">_align</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_align_layout_on_tiling</span><span class="p">,</span> <span class="n">n_alignments</span><span class="o">=</span><span class="n">n_alignments</span><span class="p">,</span> 
                      <span class="n">overlaps</span><span class="o">=</span><span class="n">overlaps</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span> 
                      <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
  
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">processes</span> <span class="o">!=</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">();</span>
  
  <span class="k">if</span> <span class="n">processes</span> <span class="o">==</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">_align</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">ax</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_alignments</span><span class="p">))];</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">layout</span><span class="o">.</span><span class="n">sources_as_virtual</span><span class="p">();</span>
    <span class="n">alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">;</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
      <span class="n">results</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_align</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">],</span> <span class="n">axes</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_alignments</span><span class="p">));</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> 
    <span class="c1">#layout.sources_as_real()</span>
  
  <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>    
    <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span><span class="p">;</span>
    <span class="n">a</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">quality</span><span class="p">;</span>
    
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Alignment: Aligning </span><span class="si">%r</span><span class="s1"> on grid&#39;</span> <span class="o">%</span> <span class="n">layout</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="n">layout</span><span class="p">;</span></div>

<span class="nd">@ptb</span><span class="o">.</span><span class="n">parallel_traceback</span>
<span class="k">def</span> <span class="nf">_align_layout_on_tiling</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">,</span> <span class="n">overlaps</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">,</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="c1">#id1 = source_to_index[a.pre]; id2 = source_to_index[a.post];</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: aligning source </span><span class="si">%d</span><span class="s1"> with </span><span class="si">%d</span><span class="s1"> along axis </span><span class="si">%d</span><span class="s1">, alignment pair </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">pre</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">));</span>  
  <span class="k">return</span> <span class="n">align_2_sources_along_axis</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="n">overlaps</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span> 
                                    <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">);</span>




<div class="viewcode-block" id="align_layout_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.align_layout_axis">[docs]</a><span class="k">def</span> <span class="nf">align_layout_axis</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">axis_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Aligns sources in a layout in a single axis direction only.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout: Layout class</span>
<span class="sd">    The layout in which to align the 3d sources in z-direction.</span>
<span class="sd">  axis : int</span>
<span class="sd">    The axis along to aling the layout.  </span>
<span class="sd">  depth : int or list of ints</span>
<span class="sd">    The approximate overlaps of the images in the different dimensions to use for mip projection.</span>
<span class="sd">    Only the depth parameter along the relevant axis is used.</span>
<span class="sd">  max_shifts : tuple of ints</span>
<span class="sd">    The minmal and maximal shift in to consider.</span>
<span class="sd">  axis_range : tuple of int or None</span>
<span class="sd">    Use only a sub set of the axis range to speed up processing.</span>
<span class="sd">  clip : number or None</span>
<span class="sd">    If not None, clip the soruces at this value when calculating the alignment.</span>
<span class="sd">  background : number or None</span>
<span class="sd">    If not None, if the values in the overlap region are less than this number make alignment return -inf quality as there is no signal to use for alignment. </span>
<span class="sd">  processes : int or &#39;serial&#39; </span>
<span class="sd">    Number of processor to use for parallel processing, if &#39;serial&#39; process in serial.</span>
<span class="sd">  verbose : bool</span>
<span class="sd">    Print progress information.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  layout : Layout </span>
<span class="sd">    The layout with updated axis-alignments.</span>
<span class="sd">    </span>
<span class="sd">  Note</span>
<span class="sd">  ----</span>
<span class="sd">  To speed up the calculation, a mip projection is used in the direction of the</span>
<span class="sd">  tiling</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">Layout</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The layout is expected to be a GridLayout&#39;</span><span class="p">);</span>
    
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: aligning sources in layout along axis=</span><span class="si">%d</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">axis</span><span class="p">)</span>
  
  <span class="c1">#format the shifts</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth</span><span class="p">,)</span> <span class="o">*</span> <span class="n">layout</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">_format_max_shifts</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">layout</span><span class="o">.</span><span class="n">ndim</span><span class="p">);</span>
  <span class="n">n_alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">n_alignments</span><span class="p">;</span>
  
  
  <span class="n">_align</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_align_layout_axis</span><span class="p">,</span> 
                      <span class="n">n_alignments</span><span class="o">=</span><span class="n">n_alignments</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis_range</span><span class="o">=</span><span class="n">axis_range</span><span class="p">,</span> 
                      <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span> 
                      <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">processes</span> <span class="o">!=</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">();</span>
  
  <span class="k">if</span> <span class="n">processes</span> <span class="o">==</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">_align</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">)];</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">layout</span><span class="o">.</span><span class="n">sources_as_virtual</span><span class="p">();</span>                        
    <span class="n">alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">;</span>
    <span class="c1">#print(&#39;align_axis&#39;)</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
      <span class="n">results</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_align</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_alignments</span><span class="p">));</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>                       
  
    <span class="c1">#layout.sources_as_real();</span>
  
  <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
    <span class="n">a_shift</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shift</span><span class="p">);</span>
    <span class="n">a_shift</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[</span><span class="n">axis</span><span class="p">];</span>
    <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">a_shift</span><span class="p">);</span>
    <span class="n">a</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">quality</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Alignment: aligning sources in layout along axis=</span><span class="si">%d</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">axis</span><span class="p">)</span>
  
  <span class="k">return</span> <span class="n">layout</span><span class="p">;</span></div>

<span class="nd">@ptb</span><span class="o">.</span><span class="n">parallel_traceback</span>
<span class="k">def</span> <span class="nf">_align_layout_axis</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">axis_range</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">,</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: aligning </span><span class="si">%r</span><span class="s1"> with </span><span class="si">%r</span><span class="s1"> along axis </span><span class="si">%d</span><span class="s1"> and range </span><span class="si">%r</span><span class="s1">, alignment pair </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> !&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">tile_position</span><span class="p">,</span> <span class="n">src2</span><span class="o">.</span><span class="n">tile_position</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">axis_range</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">));</span>
  
  <span class="c1">#reduce source size</span>
  <span class="n">sl</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="n">src1</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">axis_range</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="nb">all</span><span class="p">]:</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">);</span>
    <span class="n">sl1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
    <span class="n">sl1</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">axis_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">axis_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span>
    <span class="n">sl1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sl1</span><span class="p">);</span>          
    <span class="n">src1</span> <span class="o">=</span> <span class="n">Slice</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">src1</span><span class="p">,</span> <span class="n">slicing</span> <span class="o">=</span> <span class="n">sl1</span><span class="p">);</span>                 
    
    <span class="n">p2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">);</span>
    <span class="n">sl2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
    <span class="n">sl2</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="n">axis_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">axis_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="n">axis</span><span class="p">])</span>
    <span class="n">sl2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sl2</span><span class="p">);</span>
    <span class="n">src2</span> <span class="o">=</span> <span class="n">Slice</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">src2</span><span class="p">,</span> <span class="n">slicing</span> <span class="o">=</span> <span class="n">sl2</span><span class="p">);</span>               
      
  <span class="c1">#mip axis</span>
<span class="c1">#  t1 = src1.tile_position;</span>
<span class="c1">#  t2 = src2.tile_position;</span>
<span class="c1">#  if not t1 is None and not t2 is None:</span>
<span class="c1">#    mip_axis = np.where(np.array(t1) - t2 != 0)[0][0];</span>
<span class="c1">#  else:</span>
<span class="c1">#    mip_axis = axis;</span>
<span class="c1">#  </span>
<span class="c1">#  if mip_axis == axis:</span>
<span class="c1">#    #take the smallest overlapping dim</span>
<span class="c1">#    r1 = Region(position = src1.position, shape = src1.shape);</span>
<span class="c1">#    r2 = Region(position = src2.position, shape = src2.shape);</span>
<span class="c1">#    overlap1, _ = _overlap_with_shifts(r1, r2, max_shifts = max_shifts);</span>
<span class="c1">#    mip_shape = None; </span>
<span class="c1">#    mip_axis = None; </span>
<span class="c1">#    for d,s in enumerate(overlap1.shape):</span>
<span class="c1">#      if d != axis:</span>
<span class="c1">#        if mip_shape is None:</span>
<span class="c1">#          mip_shape = s;</span>
<span class="c1">#          mip_axis = d;</span>
<span class="c1">#        elif mip_shape &lt; s:</span>
<span class="c1">#          mip_shape = s;</span>
<span class="c1">#          mip_axis = d;</span>
  <span class="n">mip_axis</span> <span class="o">=</span> <span class="n">_mip_axis</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">);</span>
  <span class="n">mip_depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">mip_axis</span><span class="p">];</span>
  
  <span class="n">result</span> <span class="o">=</span> <span class="n">align_2_sources_along_axis_mip</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">mip_axis</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">mip_depth</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: aligning </span><span class="si">%r</span><span class="s1"> with </span><span class="si">%r</span><span class="s1"> along axis </span><span class="si">%d</span><span class="s1">, alignment pair </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> done, shift = </span><span class="si">%r</span><span class="s1">, quality = </span><span class="si">%.2e</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">tile_position</span><span class="p">,</span> <span class="n">src2</span><span class="o">.</span><span class="n">tile_position</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">quality</span><span class="p">));</span>
         
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>



<div class="viewcode-block" id="align_layout_rigid_mip"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.align_layout_rigid_mip">[docs]</a><span class="k">def</span> <span class="nf">align_layout_rigid_mip</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ranges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Aligns sources in a layout in a single axis direction only.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout: Layout class</span>
<span class="sd">    The layout in which to align the 3d sources in z-direction.</span>
<span class="sd">  depth : int or list of ints</span>
<span class="sd">    The approximate overlaps of the images in the different dimensions to use for mip projection.</span>
<span class="sd">    Only the depth parameter along the relevant axis is used.</span>
<span class="sd">  max_shifts : tuple of ints</span>
<span class="sd">    The minmal and maximal shift in to consider.</span>
<span class="sd">  axis_range : tuple of int or None</span>
<span class="sd">    Use only a sub set of the axis range to speed up processing.</span>
<span class="sd">  clip : number or None</span>
<span class="sd">    If not None, clip the soruces at this value when calculating the alignment.</span>
<span class="sd">  background : number or None</span>
<span class="sd">    If not None, if the values in the overlap region are less than this number make alignment return -inf quality as there is no signal to use for alignment. </span>
<span class="sd">  processes : int or &#39;serial&#39; layout.alig    </span>
<span class="sd">    Number of processor to use for parallel processing, if &#39;serial&#39; process in serial.</span>
<span class="sd">  verbose : bool</span>
<span class="sd">    Print progress information.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  layout : Layout </span>
<span class="sd">    The layout with updated axis-alignments.</span>
<span class="sd">    </span>
<span class="sd">  Note</span>
<span class="sd">  ----</span>
<span class="sd">  To speed up the calculation, a mip projection is used in the direction of the tiling.</span>
<span class="sd">  The tiling dimension are assumed to be alinged with the first image dimensions.</span>
<span class="sd">  &quot;&quot;&quot;</span>    
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: rigidly aligning sources in layout: </span><span class="si">%r</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">layout</span><span class="p">)</span>
  
  <span class="c1">#format the shifts</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth</span><span class="p">,)</span> <span class="o">*</span> <span class="n">layout</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
            
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ranges</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">ranges</span><span class="p">]</span> <span class="o">*</span> <span class="n">layout</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>    
  
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">_format_max_shifts</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">layout</span><span class="o">.</span><span class="n">ndim</span><span class="p">);</span>
  <span class="n">n_alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">n_alignments</span><span class="p">;</span>
  
  <span class="n">_align</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_align_layout_ridgid_mip</span><span class="p">,</span> 
                      <span class="n">n_alignments</span><span class="o">=</span><span class="n">n_alignments</span><span class="p">,</span>
                      <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span>
                      <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">processes</span> <span class="o">!=</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">();</span>
  
  <span class="k">if</span> <span class="n">processes</span> <span class="o">==</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">_align</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">)];</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">layout</span><span class="o">.</span><span class="n">sources_as_virtual</span><span class="p">();</span>                        
    <span class="n">alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">;</span>
    <span class="c1">#print(&#39;align_axis&#39;)</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
      <span class="n">results</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_align</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_alignments</span><span class="p">));</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>                       
  
    <span class="c1">#layout.sources_as_real();</span>
  
  <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
    <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span><span class="p">;</span>
    <span class="n">a</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">quality</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Alignment: rigidly aligning sources in layout: </span><span class="si">%r</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">layout</span><span class="p">)</span>
  
  <span class="k">return</span> <span class="n">layout</span><span class="p">;</span></div>


<span class="nd">@ptb</span><span class="o">.</span><span class="n">parallel_traceback</span>
<span class="k">def</span> <span class="nf">_align_layout_ridgid_mip</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: aligning </span><span class="si">%r</span><span class="s1"> with </span><span class="si">%r</span><span class="s1">, alignment pair </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> !&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">tile_position</span><span class="p">,</span> <span class="n">src2</span><span class="o">.</span><span class="n">tile_position</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">));</span>
     
  <span class="c1">#mip axis</span>
<span class="c1">#  t1 = src1.tile_position;</span>
<span class="c1">#  t2 = src2.tile_position;</span>
<span class="c1">#  if not t1 is None and not t2 is None:</span>
<span class="c1">#    mip_axis = np.where(np.array(t1) - t2 != 0)[0][0];</span>
<span class="c1">#  else:</span>
<span class="c1">#    mip_axis = None;</span>
<span class="c1">#  </span>
<span class="c1">#  if mip_axis is None:</span>
<span class="c1">#    #take the smallest overlapping dim</span>
<span class="c1">#    r1 = Region(position = src1.position, shape = src1.shape);</span>
<span class="c1">#    r2 = Region(position = src2.position, shape = src2.shape);</span>
<span class="c1">#    overlap1, _ = _overlap_with_shifts(r1, r2, max_shifts = max_shifts);</span>
<span class="c1">#    mip_shape = None; </span>
<span class="c1">#    mip_axis = None; </span>
<span class="c1">#    for d,s in enumerate(overlap1.shape):</span>
<span class="c1">#        if mip_shape is None:</span>
<span class="c1">#          mip_shape = s;</span>
<span class="c1">#          mip_axis = d;</span>
<span class="c1">#        elif mip_shape &lt; s:</span>
<span class="c1">#          mip_shape = s;</span>
<span class="c1">#          mip_axis = d;</span>
  <span class="n">mip_axis</span> <span class="o">=</span> <span class="n">_mip_axis</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">);</span> 
  <span class="n">mip_depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">mip_axis</span><span class="p">];</span>
  
  <span class="c1">#reduce sources to ranges along non-mip axes</span>
  <span class="k">if</span> <span class="n">ranges</span> <span class="o">!=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">):</span>
    <span class="n">sl1</span> <span class="o">=</span> <span class="p">();</span> <span class="n">sl2</span> <span class="o">=</span> <span class="p">();</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">;</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>          
    <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ranges</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">mip_axis</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sl1</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="n">d</span><span class="p">]),)</span>
        <span class="n">sl2</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="n">d</span><span class="p">]),)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sl1</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),);</span>
        <span class="n">sl2</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),);</span>      

    <span class="n">src1</span> <span class="o">=</span> <span class="n">Slice</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">src1</span><span class="p">,</span> <span class="n">slicing</span> <span class="o">=</span> <span class="n">sl1</span><span class="p">);</span>
    <span class="n">src2</span> <span class="o">=</span> <span class="n">Slice</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">src2</span><span class="p">,</span> <span class="n">slicing</span> <span class="o">=</span> <span class="n">sl2</span><span class="p">);</span>                  
                   
              
  <span class="n">result</span> <span class="o">=</span> <span class="n">align_2_sources_along_axis_mip</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">mip_axis</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">mip_depth</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: aligning </span><span class="si">%r</span><span class="s1"> with </span><span class="si">%r</span><span class="s1">, alignment pair </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> done, shift = </span><span class="si">%r</span><span class="s1">, quality = </span><span class="si">%.2e</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">tile_position</span><span class="p">,</span> <span class="n">src2</span><span class="o">.</span><span class="n">tile_position</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">quality</span><span class="p">));</span>
         
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>


<span class="c1">#TODO: align two sources using mip projections in different directions</span>
<div class="viewcode-block" id="align_layout_rigid_mips"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.align_layout_rigid_mips">[docs]</a><span class="k">def</span> <span class="nf">align_layout_rigid_mips</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ranges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Aligns sources in a layout using mip in all directions.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout: Layout class</span>
<span class="sd">    The layout in which to align the 3d sources in z-direction.</span>
<span class="sd">  depth : int or list of ints</span>
<span class="sd">    The approximate overlaps of the images in the different dimensions to use for mip projection.</span>
<span class="sd">    Only the depth parameter along the relevant axis is used.</span>
<span class="sd">  max_shifts : tuple of ints</span>
<span class="sd">    The minmal and maximal shift in to consider.</span>
<span class="sd">  axis_range : tuple of int or None</span>
<span class="sd">    Use only a sub set of the axis range to speed up processing.</span>
<span class="sd">  clip : number or None</span>
<span class="sd">    If not None, clip the soruces at this value when calculating the alignment.</span>
<span class="sd">  background : number or None</span>
<span class="sd">    If not None, if the values in the overlap region are less than this number make alignment return -inf quality as there is no signal to use for alignment. </span>
<span class="sd">  processes : int or &#39;serial&#39; layout.alig    </span>
<span class="sd">    Number of processor to use for parallel processing, if &#39;serial&#39; process in serial.</span>
<span class="sd">  verbose : bool</span>
<span class="sd">    Print progress information.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  layout : Layout </span>
<span class="sd">    The layout with updated axis-alignments.</span>
<span class="sd">    </span>
<span class="sd">  Note</span>
<span class="sd">  ----</span>
<span class="sd">  To speed up the calculation, a mip projection is used in the direction of the tiling.</span>
<span class="sd">  The tiling dimension are assumed to be alinged with the first image dimensions.</span>
<span class="sd">  &quot;&quot;&quot;</span>    
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: rigidly aligning sources in layout: </span><span class="si">%r</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">layout</span><span class="p">)</span>
  
  <span class="c1">#format the shifts</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth</span><span class="p">,)</span> <span class="o">*</span> <span class="n">layout</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
            
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ranges</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">ranges</span><span class="p">]</span> <span class="o">*</span> <span class="n">layout</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>    
  
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">_format_max_shifts</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">layout</span><span class="o">.</span><span class="n">ndim</span><span class="p">);</span>
  <span class="n">n_alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">n_alignments</span><span class="p">;</span>
  
  <span class="n">_align</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_align_layout_ridgid_mips</span><span class="p">,</span> 
                      <span class="n">n_alignments</span><span class="o">=</span><span class="n">n_alignments</span><span class="p">,</span>
                      <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span>
                      <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">processes</span> <span class="o">!=</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">();</span>
  
  <span class="k">if</span> <span class="n">processes</span> <span class="o">==</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">_align</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">)];</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">layout</span><span class="o">.</span><span class="n">sources_as_virtual</span><span class="p">();</span>                        
    <span class="n">alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;align_axis&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
      <span class="n">results</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_align</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">],</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_alignments</span><span class="p">));</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>                       
  
    <span class="c1">#layout.sources_as_real();</span>
  
  <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="n">shift</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
    <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span><span class="p">;</span>
    <span class="n">a</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="n">quality</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Alignment: rigidly aligning sources in layout: </span><span class="si">%r</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">layout</span><span class="p">)</span>
  
  <span class="k">return</span> <span class="n">layout</span><span class="p">;</span></div>


<span class="nd">@ptb</span><span class="o">.</span><span class="n">parallel_traceback</span>
<span class="k">def</span> <span class="nf">_align_layout_ridgid_mips</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">,</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">clip</span><span class="p">,</span> <span class="n">background</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: aligning </span><span class="si">%r</span><span class="s1"> with </span><span class="si">%r</span><span class="s1">, alignment pair </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> !&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src1</span><span class="o">.</span><span class="n">tile_position</span><span class="p">,</span> <span class="n">src2</span><span class="o">.</span><span class="n">tile_position</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">));</span>
  
  <span class="c1">#overlaps</span>
  <span class="n">r1</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span>
  <span class="n">r2</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span>
  <span class="n">o1</span><span class="p">,</span> <span class="n">o2</span> <span class="o">=</span> <span class="n">_overlap_with_shifts</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">);</span>
                               
  
<span class="c1">#  </span>
<span class="c1">#  #reduce sources to ranges along non-mip axes</span>
<span class="c1">#  if ranges != [None] * len(ranges):</span>
<span class="c1">#    sl1 = (); sl2 = ();</span>
<span class="c1">#    p1 = src1.position; p2 = src2.position;          </span>
<span class="c1">#    for d,r in enumerate(ranges):</span>
<span class="c1">#      if d != mip_axis and r is not None:</span>
<span class="c1">#        sl1 += (slice(r[0] - p1[d], r[1] - p1[d]),)</span>
<span class="c1">#        sl2 += (slice(r[0] - p2[d], r[1] - p2[d]),)</span>
<span class="c1">#      else:</span>
<span class="c1">#        sl1 += (slice(None),);</span>
<span class="c1">#        sl2 += (slice(None),);      </span>
<span class="c1">#</span>
<span class="c1">#    src1 = Slice(source = src1, slicing = sl1);</span>
<span class="c1">#    src2 = Slice(source = src2, slicing = sl2);                  </span>
<span class="c1">#                   </span>
<span class="c1">#              </span>
<span class="c1">#  result = align_2_sources_along_axis_mip(src1, src2, axis = mip_axis, depth = mip_depth, max_shifts = max_shifts, clip = clip, background = background, verbose = False);</span>
<span class="c1">#  </span>
<span class="c1">#  if verbose:</span>
<span class="c1">#    shift, quality = result;</span>
<span class="c1">#    print(&#39;Alignment: aligning %r with %r, alignment pair %d/%d done, shift = %r, quality = %.2e!&#39; % (src1.tile_position, src2.tile_position, aid, n_alignments, shift, quality));</span>
<span class="c1">#         </span>
<span class="c1">#  return result;</span>
<span class="c1">#</span>


<span class="k">def</span> <span class="nf">_mip_axis</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Determine a axis for max intensity projection.&quot;&quot;&quot;</span>
  <span class="c1">#mip axis</span>
  <span class="n">t1</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">tile_position</span><span class="p">;</span>
  <span class="n">t2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">tile_position</span><span class="p">;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">mip_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span> <span class="o">-</span> <span class="n">t2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">mip_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">mip_axis</span> <span class="o">==</span> <span class="n">axis</span><span class="p">:</span>
    <span class="c1">#take the smallest overlapping dim</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span>
    <span class="n">overlap1</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_overlap_with_shifts</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">);</span>
    <span class="n">mip_shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> 
    <span class="n">mip_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> 
    <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">overlap1</span><span class="o">.</span><span class="n">shape</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mip_shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">mip_shape</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
          <span class="n">mip_axis</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
        <span class="k">elif</span> <span class="n">mip_shape</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">:</span>
          <span class="n">mip_shape</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
          <span class="n">mip_axis</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">mip_axis</span>


<span class="k">def</span> <span class="nf">_format_max_shifts</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">ndim</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper to format the max_shift specifications.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
    <span class="n">max_shifts</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">)]</span> <span class="o">*</span> <span class="n">ndim</span><span class="p">;</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
    <span class="n">max_shifts</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_shifts</span><span class="p">]</span> <span class="o">*</span> <span class="n">ndim</span><span class="p">;</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="n">max_shifts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">);</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_shifts expected to be int, tuple, list or array, found </span><span class="si">%r</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">max_shifts</span><span class="p">));</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ndim</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_shifts len = </span><span class="si">%d</span><span class="s1"> expected to be of same dimension as the source = </span><span class="si">%d</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">),</span> <span class="n">ndim</span><span class="p">));</span>
  <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">ms</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
      <span class="n">ms</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">ms</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ms</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
      <span class="n">ms</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ms</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_shifts entry at dimension </span><span class="si">%d</span><span class="s1"> expected to be of the firm (min,max), found </span><span class="si">%r</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ms</span><span class="p">));</span>
    <span class="k">if</span> <span class="n">max_shifts</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">max_shifts</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_shifts entry at dimension </span><span class="si">%d</span><span class="s1"> expected to be ordered (min &lt;= max), found </span><span class="si">%r</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ms</span><span class="p">));</span>
    <span class="n">max_shifts</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">ms</span><span class="p">;</span>
  <span class="c1">#max_shifts = np.array(max_shifts, dtype = int);</span>
  <span class="k">return</span> <span class="n">max_shifts</span><span class="p">;</span>


<span class="c1">#########################################################################</span>
<span class="c1">### Placement</span>
<span class="c1">#########################################################################</span>

<div class="viewcode-block" id="filter_alignments"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.filter_alignments">[docs]</a><span class="k">def</span> <span class="nf">filter_alignments</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Filter out alignments that fall below a certain quality level.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  alignments : list of Alignments classes</span>
<span class="sd">    The pairwise alignments between images to optimize globally.</span>
<span class="sd">  min_quality : float</span>
<span class="sd">    The minimal quality of the alignment.</span>
<span class="sd"> </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  alignments : list of Alignment classes</span>
<span class="sd">    The filtered alignments.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">min_quality</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">alignments</span><span class="p">;</span>
  
  <span class="n">max_quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">min_quality</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_quality</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">alignments</span><span class="p">;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_quality</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">min_quality</span> <span class="o">=</span> <span class="n">min_quality</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">max_quality</span> <span class="o">=</span> <span class="n">min_quality</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="n">min_quality</span> <span class="o">=</span> <span class="n">min_quality</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>                               

  <span class="n">new_alignments</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">quality</span> <span class="o">&gt;</span> <span class="n">min_quality</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">max_quality</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">quality</span> <span class="o">&lt;</span> <span class="n">max_quality</span><span class="p">:</span>
          <span class="n">new_alignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">new_alignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="n">new_alignments</span><span class="p">;</span></div>


<div class="viewcode-block" id="alignments_from_source_positions"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.alignments_from_source_positions">[docs]</a><span class="k">def</span> <span class="nf">alignments_from_source_positions</span><span class="p">(</span><span class="n">alignments</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Update alignment shifts from source positions and shapes</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  alignments : list of Alignments classes</span>
<span class="sd">    The alignments pairs of the sources.</span>

<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  alignments : list of Alignments classes</span>
<span class="sd">    The updated alignments. </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
    <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">alignments</span><span class="p">;</span></div>
  

<div class="viewcode-block" id="positions_from_tree"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.positions_from_tree">[docs]</a><span class="k">def</span> <span class="nf">positions_from_tree</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fixed_source</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Update source positions from alignments.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  alignments : list of Alignments classes</span>
<span class="sd">    The alignments pairs of the sources.</span>
<span class="sd">  sources : list of Source classes or None</span>
<span class="sd">    Optional sources to update the positions for, if None extracted from alignment classes.</span>
<span class="sd">  min_quality : float</span>
<span class="sd">    The minimal quality of the alignment.</span>
<span class="sd">  fixed_source : Source class, int or None</span>
<span class="sd">    Optional source to kept fixed. If None the first source is placed at the origin.</span>
<span class="sd">  lower_to_origin : bool</span>
<span class="sd">    If True the lower corner of the aligned images is set to zero.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  positions : list of tuple of ints</span>
<span class="sd">    The source positions.</span>
<span class="sd">    </span>
<span class="sd">  Note</span>
<span class="sd">  ----</span>
<span class="sd">  The result will be a single consistent solution based on a minimal paths between the first and the other sources of the layout.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">#TODO: base on spanning tree with best quality measure</span>
  <span class="n">alignments</span> <span class="o">=</span> <span class="n">filter_alignments</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="n">min_quality</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">sources_from_alignments</span><span class="p">(</span><span class="n">alignments</span><span class="p">);</span>
  <span class="n">nsources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">);</span>
  
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span>
  <span class="n">source_to_index</span> <span class="o">=</span> <span class="p">{</span> <span class="n">s</span> <span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">)};</span>
  
  <span class="c1">#construct minimal tree to connect sources</span>
  <span class="n">g</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">directed</span> <span class="o">=</span> <span class="kc">True</span><span class="p">);</span>    
  <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="n">nsources</span><span class="p">);</span>
  <span class="n">p</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">new_edge_property</span><span class="p">(</span><span class="s1">&#39;vector&lt;int&gt;&#39;</span><span class="p">);</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
    <span class="n">ipre</span> <span class="o">=</span> <span class="n">source_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">];</span>
    <span class="n">ipost</span> <span class="o">=</span> <span class="n">source_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">];</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">displacement</span><span class="p">;</span>
    <span class="n">e</span>  <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">ipre</span><span class="p">,</span> <span class="n">ipost</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">ipost</span><span class="p">,</span> <span class="n">ipre</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="o">-</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shift</span><span class="p">);</span>
  
  <span class="c1">#calculate positions from tree</span>
  <span class="n">start_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="n">fixed_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">start_id</span> <span class="o">=</span> <span class="n">source_to_index</span><span class="p">[</span><span class="n">fixed_source</span><span class="p">];</span>
  
  <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsources</span><span class="p">,</span> <span class="n">ndim</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsources</span><span class="p">):</span>
    <span class="n">vlist</span><span class="p">,</span> <span class="n">elist</span> <span class="o">=</span> <span class="n">gtt</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">start_id</span><span class="p">),</span> <span class="n">g</span><span class="o">.</span><span class="n">vertex</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elist</span><span class="p">:</span>
      <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="n">e</span><span class="p">];</span>
  
  <span class="c1">#correct for origin and fixed source</span>
  <span class="k">if</span> <span class="n">fixed_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fixed_id</span> <span class="o">=</span> <span class="n">source_to_index</span><span class="p">[</span><span class="n">fixed_source</span><span class="p">];</span>
    <span class="n">fixed_position</span> <span class="o">=</span> <span class="n">fixed_source</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span> <span class="o">-</span> <span class="n">positions</span><span class="p">[</span><span class="n">fixed_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">fixed_position</span><span class="p">;</span>

  <span class="k">if</span> <span class="n">lower_to_origin</span><span class="p">:</span>
    <span class="n">min_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">positions</span> <span class="o">-=</span> <span class="n">min_pos</span><span class="p">;</span>  
  
  <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">positions</span><span class="p">;</span>  </div>


<div class="viewcode-block" id="positions_from_optimization"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.positions_from_optimization">[docs]</a><span class="k">def</span> <span class="nf">positions_from_optimization</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fixed_source</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span> <span class="c1"># optimize positions !</span>
  <span class="sd">&quot;&quot;&quot;Use least squares optimization to find globally optimal source positions from pairwise alignments.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  alignments : list of Alignments classes</span>
<span class="sd">    The pairwise alignments between images to optimize globally.</span>
<span class="sd">  sources : list of Source classes or None</span>
<span class="sd">    The sources to optimze the positions for, if None determine from the alignments.</span>
<span class="sd">  min_quality : float</span>
<span class="sd">    The minimal quality of the alignment.</span>
<span class="sd">  fixed_source : Source class, int or None</span>
<span class="sd">    Optional source to kept fixed. If None the first source is kept fixed.</span>
<span class="sd">  lower_to_origin : bool</span>
<span class="sd">    If True, the lower corner of the aligned images is set to zero.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  sources : list of Source classes</span>
<span class="sd">    The sources with the optimized positions.</span>
<span class="sd">    </span>
<span class="sd">  Note</span>
<span class="sd">  ----</span>
<span class="sd">  The error function is sum (x_i + s_ij - x_j)^2 with x_i the image positions and s_ij the pairwise shifts.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">#TODO: use qaulity measure in optimization</span>
  <span class="n">alignments</span> <span class="o">=</span> <span class="n">filter_alignments</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="n">min_quality</span><span class="p">);</span>
  
  <span class="n">nalignments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alignments</span><span class="p">);</span>
  <span class="k">if</span> <span class="n">nalignments</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">None</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">];</span>
    
  <span class="c1">#sources</span>
  <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">sources_from_alignments</span><span class="p">(</span><span class="n">alignments</span><span class="p">);</span>
  <span class="n">source_to_index</span> <span class="o">=</span> <span class="p">{</span> <span class="n">s</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">)};</span>  
  
  <span class="k">if</span> <span class="ow">not</span> <span class="n">connected</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Sources need to be connected for optimized placement!&#39;</span><span class="p">)</span>
  
  <span class="c1"># construct the mappings between node ids and index 1:nimages</span>
  <span class="n">pre_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">source_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">]);</span>
  <span class="n">post_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">source_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">]);</span>
  <span class="n">node_to_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">pre_indices</span><span class="p">,</span> <span class="n">post_indices</span><span class="p">]));</span>
  <span class="n">nnodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_to_index</span><span class="p">);</span>
  
  <span class="n">index_to_node</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">node_to_index</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>                  
  <span class="n">index_to_node</span><span class="p">[</span><span class="n">node_to_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nnodes</span><span class="p">);</span>
  
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">ndim</span> <span class="o">*</span> <span class="n">nalignments</span><span class="p">;</span>
  <span class="n">m</span> <span class="o">=</span> <span class="n">ndim</span> <span class="o">*</span> <span class="p">(</span><span class="n">nnodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="c1"># first image is assumed to be fixed at zero</span>

  <span class="c1"># derivative of the error gives constraints s - M x == 0</span>
  <span class="c1"># s are the displacements, x the centers of the images, M is derived from the error terms</span>

  <span class="c1"># s</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">displacement</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
      <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  
  <span class="c1"># M</span>
  <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">));</span>
  <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
   <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
      <span class="n">pre_node</span> <span class="o">=</span> <span class="n">index_to_node</span><span class="p">[</span><span class="n">source_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">]];</span>
      <span class="k">if</span> <span class="n">pre_node</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">pre_node</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ndim</span> <span class="o">+</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

      <span class="n">post_node</span> <span class="o">=</span> <span class="n">index_to_node</span><span class="p">[</span><span class="n">source_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">]];</span>
      <span class="k">if</span> <span class="n">post_node</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">post_node</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ndim</span> <span class="o">+</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  
  <span class="c1">#print s</span>
  <span class="c1">#print M</span>
  <span class="c1">#print np.linalg.pinv(M)</span>
  
  <span class="c1"># find the centers of the images via pseudo inverse</span>
  <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">s</span><span class="p">);</span>  
  <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">),</span> <span class="n">positions</span><span class="p">]);</span>
  <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">));</span>
  <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">positions</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>
  
  <span class="c1">#correct for origin and fixed source</span>
  <span class="k">if</span> <span class="n">fixed_source</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fixed_id</span> <span class="o">=</span> <span class="n">source_index</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">fixed_source</span><span class="p">);</span>
    <span class="n">fixed_position</span> <span class="o">=</span> <span class="n">fixed_source</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">fixed_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fixed_position</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
  <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span> <span class="o">-</span> <span class="n">positions</span><span class="p">[</span><span class="n">fixed_id</span><span class="p">]</span> <span class="o">+</span> <span class="n">fixed_position</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">lower_to_origin</span><span class="p">:</span>
    <span class="n">min_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">positions</span> <span class="o">-=</span> <span class="n">min_pos</span><span class="p">;</span>  
  
  <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">];</span>
  <span class="k">return</span> <span class="n">positions</span><span class="p">;</span></div>


<div class="viewcode-block" id="place_layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.place_layout">[docs]</a><span class="k">def</span> <span class="nf">place_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;optimization&#39;</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Place the sources in a layout in a consistent way.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout in which the Sources will be placed in a consistent way.</span>
<span class="sd">  method : &#39;optimization&#39; or &#39;tree&#39;</span>
<span class="sd">    The method to use to place the sources.</span>
<span class="sd">  min_quality : float</span>
<span class="sd">    The minimal quality of the alignments to include in the placement process.</span>
<span class="sd">  lower_to_origin : bool</span>
<span class="sd">    If True, the lower corner of the aligned sources is set to zero.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout with the optimized positions of the sources.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">#if not isinstance(layout, Layout):</span>
  <span class="c1">#  raise ValueError(&quot;A Layout class is expected as input!&quot;);</span>
  
  <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;optimization&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">];</span>
  <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
    <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Method </span><span class="si">%r</span><span class="s1"> not in </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">methods</span><span class="p">));</span>
    
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Placement: placing </span><span class="si">%r</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">layout</span><span class="p">);</span>
  
  <span class="c1">#determine connected components</span>
  <span class="n">components</span><span class="p">,</span> <span class="n">component_sources</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">connected_components</span><span class="p">(</span><span class="n">min_quality</span> <span class="o">=</span> <span class="n">min_quality</span><span class="p">,</span> <span class="n">with_sources</span> <span class="o">=</span> <span class="kc">True</span><span class="p">);</span>                                                      
  <span class="c1">#print components, component_sources</span>
  
  <span class="n">component_positions</span> <span class="o">=</span> <span class="p">[];</span>                               
  <span class="k">for</span> <span class="n">component</span><span class="p">,</span> <span class="n">sources</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">component_sources</span><span class="p">):</span>
    <span class="n">fixed_source</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;optimization&#39;</span><span class="p">:</span>
      <span class="n">positions</span> <span class="o">=</span> <span class="n">positions_from_optimization</span><span class="p">(</span><span class="n">alignments</span> <span class="o">=</span> <span class="n">component</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">,</span> <span class="n">fixed_source</span> <span class="o">=</span> <span class="n">fixed_source</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">False</span><span class="p">);</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;tree&#39;</span><span class="p">:</span>
      <span class="n">positions</span> <span class="o">=</span> <span class="n">positions_from_tree</span><span class="p">(</span><span class="n">alignments</span> <span class="o">=</span> <span class="n">component</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">,</span> <span class="n">fixed_source</span> <span class="o">=</span> <span class="n">fixed_source</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">False</span><span class="p">);</span>

    <span class="n">component_positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">positions</span><span class="p">);</span>
  
  <span class="c1">#order positions according to layout                                  </span>
  <span class="n">positions</span> <span class="o">=</span> <span class="p">[];</span>                                
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">layout</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>                                
   <span class="k">for</span> <span class="n">sources</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">component_sources</span><span class="p">,</span> <span class="n">component_positions</span><span class="p">):</span>
     <span class="k">for</span> <span class="n">cs</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
       <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">cs</span><span class="o">.</span><span class="n">id</span><span class="p">:</span>
         <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
         <span class="k">break</span><span class="p">;</span>
  <span class="c1">#print(positions) </span>
  
  <span class="k">if</span> <span class="n">lower_to_origin</span><span class="p">:</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>     
    <span class="n">positions</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">)</span> <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">];</span>             

  <span class="n">layout</span><span class="o">.</span><span class="n">set_source_positions</span><span class="p">(</span><span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="p">,</span> <span class="n">update_alignments</span> <span class="o">=</span> <span class="kc">False</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Placement: placing </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">layout</span><span class="p">)</span>
  
  <span class="k">return</span> <span class="n">layout</span><span class="p">;</span></div>



<div class="viewcode-block" id="place_layout_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.place_layout_axis">[docs]</a><span class="k">def</span> <span class="nf">place_layout_axis</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;optimization&#39;</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Places the sources in a layout along a single axis only.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout: Layout class</span>
<span class="sd">    The layout of the stacks.</span>
<span class="sd">  method : &#39;optimization&#39; or &#39;tree&#39;</span>
<span class="sd">    The method to use to place the sources.</span>
<span class="sd">  min_quality : float</span>
<span class="sd">    The minimal quality of the alignment.</span>
<span class="sd">  lower_to_origin : bool</span>
<span class="sd">    If True the lower corner of the aligned images is set to zero.    </span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  layout : Layout </span>
<span class="sd">    The layout with updated z-alignments.  </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">Layout</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A Layout class is expected as input!&quot;</span><span class="p">);</span>
    
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Placement: placing </span><span class="si">%r</span><span class="s1"> along axis </span><span class="si">%d</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
  
  <span class="n">sources_1d</span> <span class="o">=</span> <span class="p">[</span><span class="n">SourceRegion</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="p">:</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">:</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">layout</span><span class="o">.</span><span class="n">sources</span><span class="p">];</span>  
  <span class="n">source_to_1d</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="p">:</span> <span class="n">s1</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">s1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">sources_1d</span><span class="p">)};</span>
  
  <span class="n">alignments_1d</span> <span class="o">=</span> <span class="p">[</span><span class="n">Alignment</span><span class="p">(</span><span class="n">pre</span> <span class="o">=</span> <span class="n">source_to_1d</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">],</span> <span class="n">post</span> <span class="o">=</span> <span class="n">source_to_1d</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">],</span> <span class="n">shift</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shift</span><span class="p">[</span><span class="n">axis</span><span class="p">:</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">quality</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">quality</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">];</span>

  <span class="n">layout_1d</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources_1d</span><span class="p">,</span> <span class="n">alignments</span> <span class="o">=</span> <span class="n">alignments_1d</span><span class="p">);</span>
  
  <span class="n">place_layout</span><span class="p">(</span><span class="n">layout_1d</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="n">min_quality</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="n">lower_to_origin</span><span class="p">);</span>
  
  <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">layout_1d</span><span class="o">.</span><span class="n">source_positions</span><span class="p">()):</span>
    <span class="n">position</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">);</span>
    <span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">s</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">position</span><span class="p">);</span>
    
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">:</span>
    <span class="n">shift</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shift</span><span class="p">);</span>
    <span class="n">shift</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">a</span><span class="o">.</span><span class="n">shift</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">shift</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Placement: placing </span><span class="si">%r</span><span class="s1"> along axis </span><span class="si">%d</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
  
  <span class="k">return</span> <span class="n">layout</span><span class="p">;</span></div>


<span class="c1">########################################################################################</span>
<span class="c1">### Stitching</span>
<span class="c1">########################################################################################</span>

<div class="viewcode-block" id="embedding"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.embedding">[docs]</a><span class="k">def</span> <span class="nf">embedding</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Splits a set of co-axial sources into a minimal set of non-overlaping regions.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  sources : list of Source or Region classes</span>
<span class="sd">    The sources to embed in a full image.</span>
<span class="sd">  shape : tuple of ints or None</span>
<span class="sd">    Optional fixed shape of the full image, if None use the minimal shape that fits all sources.</span>
<span class="sd">  position : tuple of ints or None</span>
<span class="sd">    Optional position form which to start the stitching. Together with shape this can be used to restrict the stitching region. </span>
<span class="sd">    If None, use the minimal position that fits all the contributing sources.</span>
<span class="sd">    </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  shape : tuple of int</span>
<span class="sd">    The shape that encapsulates all the regions.</span>
<span class="sd">  position : tuple of int</span>
<span class="sd">    The lowest corner of all the regions.</span>
<span class="sd">  regions : list of Overlap classes.</span>
<span class="sd">    The regions of different overlaps of the individual sources.    </span>
<span class="sd">  </span>
<span class="sd">  Note</span>
<span class="sd">  ----</span>
<span class="sd">  The result can be used to stitch the images.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">regions</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
    <span class="n">region</span> <span class="o">=</span> <span class="n">Overlap</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">]);</span>
    <span class="n">regions</span> <span class="o">=</span> <span class="n">_add_overlap_region</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">region</span><span class="p">);</span>
  <span class="c1">#print regions</span>
  <span class="c1">#print [r.position for r in regions]</span>
  <span class="c1">#print [r.shape for r in regions]</span>
  
  
  <span class="k">if</span> <span class="n">position</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">position</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">position</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">));</span>
    
  <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">upper</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">));</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">);</span>
  <span class="c1">#print position, shape</span>
  
  <span class="c1"># reduce to position</span>
  <span class="n">new_regions</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="k">else</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">position</span><span class="p">));</span>
    <span class="n">r</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">u</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="k">else</span> <span class="n">u</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">position</span><span class="p">));</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">u</span> <span class="o">&gt;</span> <span class="n">l</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">)]):</span>
      <span class="n">new_regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
  <span class="n">regions</span> <span class="o">=</span> <span class="n">new_regions</span><span class="p">;</span>
  
  <span class="c1">#reduce to shape</span>
  <span class="n">new_regions</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="n">shape</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">lower</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">l</span> <span class="o">&gt;</span> <span class="n">p</span> <span class="k">else</span> <span class="n">l</span> <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">ps</span><span class="p">));</span>
    <span class="n">r</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="k">if</span> <span class="n">u</span> <span class="o">&gt;</span> <span class="n">p</span> <span class="k">else</span> <span class="n">u</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">ps</span><span class="p">));</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">u</span> <span class="o">&gt;</span> <span class="n">l</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span><span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">)]):</span>
      <span class="n">new_regions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
  <span class="n">regions</span> <span class="o">=</span> <span class="n">new_regions</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">position</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">regions</span><span class="p">;</span></div>


<span class="k">def</span> <span class="nf">_overlap</span><span class="p">(</span><span class="n">region1</span><span class="p">,</span> <span class="n">region2</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper to determine overlap between two regions.&quot;&quot;&quot;</span>
  <span class="n">ovl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">region1</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">region2</span><span class="o">.</span><span class="n">lower</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">ovu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">region1</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">region2</span><span class="o">.</span><span class="n">upper</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">ovu</span> <span class="o">-</span> <span class="n">ovl</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span><span class="p">;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Overlap</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="n">ovl</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">ovu</span><span class="p">);</span>


<span class="k">def</span> <span class="nf">_split_region</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">o</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Split region into covering rectangles including the overlap region.&quot;&quot;&quot;</span>
  <span class="n">split</span> <span class="o">=</span> <span class="p">[</span><span class="n">o</span><span class="p">];</span>
  
  <span class="n">rl</span><span class="p">,</span><span class="n">ru</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">upper</span><span class="p">;</span>
  <span class="n">ol</span><span class="p">,</span><span class="n">ou</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">upper</span><span class="p">;</span>
  
  <span class="c1">#split along axes</span>
  <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">ndim</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rl</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ol</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>
      <span class="n">l</span> <span class="o">=</span> <span class="n">ol</span><span class="p">[:</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">rl</span><span class="p">[</span><span class="n">d</span><span class="p">:];</span>
      <span class="n">u</span> <span class="o">=</span> <span class="n">ou</span><span class="p">[:</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ol</span><span class="p">[</span><span class="n">d</span><span class="p">],)</span> <span class="o">+</span> <span class="n">ru</span><span class="p">[</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
      <span class="n">split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Overlap</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="n">l</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">u</span><span class="p">));</span>
    
    <span class="k">if</span> <span class="n">ou</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ru</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>
      <span class="n">l</span> <span class="o">=</span> <span class="n">ol</span><span class="p">[:</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ou</span><span class="p">[</span><span class="n">d</span><span class="p">],)</span> <span class="o">+</span> <span class="n">rl</span><span class="p">[</span><span class="n">d</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
      <span class="n">u</span> <span class="o">=</span> <span class="n">ou</span><span class="p">[:</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">ru</span><span class="p">[</span><span class="n">d</span><span class="p">:];</span>
      <span class="n">split</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Overlap</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="n">l</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">u</span><span class="p">));</span>
   
  <span class="k">return</span> <span class="n">split</span><span class="p">;</span>   


<span class="k">def</span> <span class="nf">_add_overlap_region</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper to determine overlap regions.&quot;&quot;&quot;</span>
  <span class="c1"># try too add the full new region first</span>
  <span class="n">regsadd</span> <span class="o">=</span> <span class="p">[</span><span class="n">region</span><span class="p">];</span>

  <span class="c1"># the non-overlapping rectangles to be checked for overlap with regsadd</span>
  <span class="n">regscheck</span> <span class="o">=</span> <span class="n">regions</span><span class="p">;</span>

  <span class="c1"># rectangles that will not have any further overlap with regsadd</span>
  <span class="n">regsnew</span>   <span class="o">=</span> <span class="p">[];</span>
  
  <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">regscheck</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">regsadd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># chek the next one in list</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="n">regscheck</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="c1">#print &#39;add:&#39;, regsadd</span>
    <span class="c1">#print &#39;check:&#39;, regscheck</span>
    <span class="c1">#print &#39;new:&#39;, regsnew</span>
      
    <span class="c1">#check if overlap with any of the regions to be added</span>
    <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">regsadd</span><span class="p">)):</span>
      <span class="n">ra</span> <span class="o">=</span> <span class="n">regsadd</span><span class="p">[</span><span class="n">a</span><span class="p">];</span>
      <span class="n">ov</span> <span class="o">=</span> <span class="n">_overlap</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">ra</span><span class="p">);</span>
      <span class="c1">#print &#39;chk,add %d:&#39; % a, rc, ra</span>
      <span class="c1">#print &#39;ovl %d:&#39; % a, ov</span>
      
      <span class="k">if</span> <span class="n">ov</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="c1">#print &#39;overlap: &#39;, rc, ra, ov</span>
        
        <span class="c1"># split region to check</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">_split_region</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">ov</span><span class="p">);</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">split</span><span class="p">:</span>
          <span class="n">s</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">rc</span><span class="o">.</span><span class="n">sources</span><span class="p">;</span>
        
        <span class="c1">#add id of immage to add to overlapping region </span>
        <span class="c1">#-&gt; cannot overlap with other region -&gt; safe to put into new list</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sources</span><span class="p">;</span>
        <span class="n">sources</span> <span class="o">+=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ra</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">);</span>
        <span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span>
        <span class="c1">#print &#39;split1:&#39;, split        </span>
        
        <span class="n">regsnew</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="c1">#.copy()); </span>
        
        <span class="c1"># other non-overlapping regions from split need to be checked again</span>
        <span class="c1">#regscheck = [s.copy() for s in split[1:]] + regscheck[1:];</span>
        <span class="n">regscheck</span> <span class="o">=</span> <span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">regscheck</span><span class="p">[</span><span class="mi">1</span><span class="p">:];</span>
        
        <span class="c1">#split added region</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">_split_region</span><span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">ov</span><span class="p">)[</span><span class="mi">1</span><span class="p">:];</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">split</span><span class="p">:</span>
          <span class="n">s</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="n">ra</span><span class="o">.</span><span class="n">sources</span><span class="p">;</span>
        <span class="c1">#print &#39;split2:&#39;, split        </span>
        
        <span class="c1"># add all non-verlapping regions to the &#39;to be added&#39; list</span>
        <span class="c1">#regsadd = regsadd[:a] + [r.copy() for r in split[1:]] + regsadd[a+1:];</span>
        <span class="n">regsadd</span> <span class="o">=</span> <span class="n">regsadd</span><span class="p">[:</span><span class="n">a</span><span class="p">]</span> <span class="o">+</span> <span class="n">split</span> <span class="o">+</span> <span class="n">regsadd</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
          
        <span class="c1"># start cehcking anew</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
            
    <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>   <span class="c1"># -&gt; check region not overlapping -&gt; add to new list and remove from checklist</span>
      <span class="n">regsnew</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
      <span class="n">regscheck</span> <span class="o">=</span> <span class="n">regscheck</span><span class="p">[</span><span class="mi">1</span><span class="p">:];</span>
        
  <span class="n">regsnew</span> <span class="o">=</span> <span class="n">regsnew</span> <span class="o">+</span> <span class="n">regscheck</span> <span class="o">+</span> <span class="n">regsadd</span><span class="p">;</span>
  <span class="c1">#print &#39;done add:&#39;, regsnew</span>
  
  <span class="k">return</span> <span class="n">regsnew</span><span class="p">;</span>


<div class="viewcode-block" id="stitch_by_function"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.stitch_by_function">[docs]</a><span class="k">def</span> <span class="nf">stitch_by_function</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Stitch sources according to shifts applying a specific function in the overlapping regions.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout to use for the sources.</span>
<span class="sd">  sink : array like or None</span>
<span class="sd">    The sink to write the result to.</span>
<span class="sd">  function : function</span>
<span class="sd">    The function to apply in overlapping regions, e.g. np.max or np.mean.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  stitched : array</span>
<span class="sd">    The stitched array.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># determine all the overlap regions</span>
  <span class="n">position</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">embedding</span><span class="p">();</span>
  
  <span class="c1"># stitch image</span>
  <span class="k">if</span> <span class="s1">&#39;axis&#39;</span> <span class="ow">in</span> <span class="n">insp</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">sink</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">stitched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">order</span><span class="p">);</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">stitched</span> <span class="o">=</span> <span class="n">sink</span><span class="p">;</span>
  
  <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
    <span class="n">nsources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sources</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="n">nsources</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">rd</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">sl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">source_slicings</span><span class="p">())];</span>
      <span class="n">rd</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">rd</span><span class="p">);</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">rd</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">r</span><span class="o">.</span><span class="n">source_slicings</span><span class="p">()[</span><span class="mi">0</span><span class="p">]];</span>
    
    <span class="n">stitched</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">local_slicing</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rd</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">stitched</span><span class="p">;</span></div>


<div class="viewcode-block" id="stitch_weights"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.stitch_weights">[docs]</a><span class="k">def</span> <span class="nf">stitch_weights</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns the weights of a source of a given shape to use in stitching routines.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  shape : tuple of ints</span>
<span class="sd">    The shape of the source.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  weights : array</span>
<span class="sd">    The weigthsfor the pixels of the source.</span>
<span class="sd">  &quot;&quot;&quot;</span> 
  <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">];</span>
  <span class="n">mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="o">*</span><span class="n">ranges</span><span class="p">,</span> <span class="n">indexing</span> <span class="o">=</span> <span class="s1">&#39;ij&#39;</span><span class="p">);</span>
  <span class="n">mesh</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="n">m</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mesh</span><span class="p">];</span>
  <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>  
  <span class="k">return</span> <span class="n">weights</span><span class="p">;</span></div>
  

<div class="viewcode-block" id="stitch_by_function_with_weights"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.stitch_by_function_with_weights">[docs]</a><span class="k">def</span> <span class="nf">stitch_by_function_with_weights</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">,</span> <span class="n">weight_function</span> <span class="o">=</span> <span class="n">stitch_weights</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Stitch sources applying a specific weighting function in the overlapping regions.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layour of the sources.</span>
<span class="sd">  sink : array like or None</span>
<span class="sd">    The sink to write the result to.</span>
<span class="sd">  function : function</span>
<span class="sd">    The function to apply in overlapping regions, e.g. np.sum or np.mean.</span>
<span class="sd">  weight_function : function</span>
<span class="sd">    A function that returns an array of pixel weights given the source shape.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  stitched : array</span>
<span class="sd">    The stitched array.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># determine all the overlap regions</span>
  <span class="n">position</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">regions</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">embedding</span><span class="p">();</span>
  
  <span class="c1"># stitch image</span>
  <span class="k">if</span> <span class="s1">&#39;axis&#39;</span> <span class="ow">in</span> <span class="n">insp</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">function</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
    <span class="n">function</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">sink</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">stitched</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">order</span><span class="p">);</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">stitched</span> <span class="o">=</span> <span class="n">sink</span><span class="p">;</span>
  
  <span class="c1">#determine weights</span>
  <span class="n">shapes</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">layout</span><span class="o">.</span><span class="n">sources</span><span class="p">];</span>
  <span class="k">if</span> <span class="n">shapes</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">shapes</span><span class="p">):</span>
    <span class="n">same_shape</span> <span class="o">=</span> <span class="kc">True</span><span class="p">;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">weight_function</span><span class="p">(</span><span class="n">shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">same_shape</span> <span class="o">=</span> <span class="kc">False</span><span class="p">;</span>
    <span class="n">source_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">sources</span><span class="p">)};</span>
    <span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="n">weight_function</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shapes</span><span class="p">];</span>
  
  
  <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">:</span>
    <span class="n">nsources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sources</span><span class="p">);</span>
    <span class="c1">#print nsources, r</span>
    
    <span class="k">if</span> <span class="n">nsources</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="n">rd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsources</span><span class="p">,)</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span>
      <span class="n">wd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsources</span><span class="p">,)</span> <span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">shape</span><span class="p">);</span>
      
      <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">sl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">sources</span><span class="p">)),</span> <span class="n">r</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">source_slicings</span><span class="p">()):</span>
        <span class="c1">#print i, s, sl</span>
        <span class="n">rd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">sl</span><span class="p">];</span>
        <span class="k">if</span> <span class="n">same_shape</span><span class="p">:</span>
          <span class="n">wd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">sl</span><span class="p">];</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">wd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">source_to_index</span><span class="p">[</span><span class="n">s</span><span class="p">]][</span><span class="n">sl</span><span class="p">];</span>        
        
      <span class="n">rd</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">rd</span><span class="p">,</span> <span class="n">wd</span><span class="p">);</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">rd</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">source_slicings</span><span class="p">()[</span><span class="mi">0</span><span class="p">]];</span>
    
    <span class="n">stitched</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">local_slicing</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">)]</span> <span class="o">=</span> <span class="n">rd</span><span class="p">;</span>  
  
  <span class="k">return</span> <span class="n">stitched</span><span class="p">;</span></div>


<div class="viewcode-block" id="stitch_by_mean"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.stitch_by_mean">[docs]</a><span class="k">def</span> <span class="nf">stitch_by_mean</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Stitch sources according to shifts applying mean function in the overlap regions.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout of the sources.</span>
<span class="sd">  sink : array like or None</span>
<span class="sd">    The sink to write the result to.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  stitched : array</span>
<span class="sd">    The stitched array.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">stitch_by_function</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">);</span></div>


<div class="viewcode-block" id="stitch_by_max"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.stitch_by_max">[docs]</a><span class="k">def</span> <span class="nf">stitch_by_max</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Stitch sources according to shifts applying max function in the overlap regions.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout of the sources.</span>
<span class="sd">  sink : array like or None</span>
<span class="sd">    The sink to write the result to.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  stitched : array</span>
<span class="sd">    The stitched array.</span>
<span class="sd">  &quot;&quot;&quot;</span> 
  <span class="k">return</span> <span class="n">stitch_by_function</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">);</span></div>
  

<div class="viewcode-block" id="stitch_by_min"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.stitch_by_min">[docs]</a><span class="k">def</span> <span class="nf">stitch_by_min</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Stitch sources according to shifts applying min function in the overlap regions.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout of the sources.</span>
<span class="sd">  sink : array like or None</span>
<span class="sd">    The sink to write the result to.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  stitched : array</span>
<span class="sd">    The stitched array.</span>
<span class="sd">  &quot;&quot;&quot;</span> 
  <span class="k">return</span> <span class="n">stitch_by_function</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">);</span></div>


<div class="viewcode-block" id="stitch_by_interpolation"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.stitch_by_interpolation">[docs]</a><span class="k">def</span> <span class="nf">stitch_by_interpolation</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Stitch sources according to shifts applying linear interpolation in the overlap regions.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout of the sources.</span>
<span class="sd">  sink : array like or None</span>
<span class="sd">    The sink to write the result to.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  stitched : array</span>
<span class="sd">    The stitched array.</span>
<span class="sd">  &quot;&quot;&quot;</span> 
  <span class="k">def</span> <span class="nf">weigthed_mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span> <span class="o">*</span> <span class="n">weights</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">stitch_by_function_with_weights</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">weigthed_mean</span><span class="p">,</span> <span class="n">weight_function</span> <span class="o">=</span> <span class="n">stitch_weights</span><span class="p">);</span></div>

  
<div class="viewcode-block" id="stitch_by_interpolation_adjust_max"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.stitch_by_interpolation_adjust_max">[docs]</a><span class="k">def</span> <span class="nf">stitch_by_interpolation_adjust_max</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Stitch sources according to shifts applying linear interpolation in the overlap regions.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout of the sources.</span>
<span class="sd">  sink : array like or None</span>
<span class="sd">    The sink to write the result to.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  stitched : array</span>
<span class="sd">    The stitched array.</span>
<span class="sd">  &quot;&quot;&quot;</span> 
  <span class="k">def</span> <span class="nf">weigthed_mean_adjust</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span> <span class="o">*</span> <span class="n">weights</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">ms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">ms</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">s</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">ms</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">stitch_by_function_with_weights</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">,</span> <span class="n">function</span> <span class="o">=</span> <span class="n">weigthed_mean_adjust</span><span class="p">,</span> <span class="n">weight_function</span> <span class="o">=</span> <span class="n">stitch_weights</span><span class="p">);</span></div>


<span class="k">def</span> <span class="nf">_stitching_function_from_method</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper to convert stitching method string to function&quot;&quot;&quot;</span>
  <span class="n">method_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;interpolation&#39;</span>            <span class="p">:</span>  <span class="n">stitch_by_interpolation</span><span class="p">,</span>
                <span class="s1">&#39;interpolation-adjust-max&#39;</span> <span class="p">:</span>  <span class="n">stitch_by_interpolation_adjust_max</span><span class="p">,</span>
                <span class="s1">&#39;max&#39;</span>                      <span class="p">:</span>  <span class="n">stitch_by_max</span><span class="p">,</span>
                <span class="s1">&#39;min&#39;</span>                      <span class="p">:</span>  <span class="n">stitch_by_min</span><span class="p">,</span>
                <span class="s1">&#39;mean&#39;</span>                     <span class="p">:</span>  <span class="n">stitch_by_mean</span><span class="p">};</span>
  
  <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">method_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Method </span><span class="si">%r</span><span class="s1"> not in </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">method_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()));</span>  
  
  <span class="k">return</span> <span class="n">method_map</span><span class="p">[</span><span class="n">method</span><span class="p">];</span>


<div class="viewcode-block" id="stitch_layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.stitch_layout">[docs]</a><span class="k">def</span> <span class="nf">stitch_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;interpolation&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Stitch a layout according to its current alignment.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout of the sources.</span>
<span class="sd">  sink : array like or None</span>
<span class="sd">    The sink to write the result to.</span>
<span class="sd">  method : str</span>
<span class="sd">    The method to use for the stitching: &#39;interpolation&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mean&#39;</span>
<span class="sd">  verbose : bool</span>
<span class="sd">    If True, print progress information.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  stitched : array</span>
<span class="sd">    The stitched array.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stitching: Stitching </span><span class="si">%r</span><span class="s1"> with method </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">method</span><span class="p">));</span>

  <span class="n">function</span> <span class="o">=</span> <span class="n">_stitching_function_from_method</span><span class="p">(</span><span class="n">method</span><span class="p">);</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Stitching: Stitching </span><span class="si">%r</span><span class="s1"> with method </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">method</span><span class="p">));</span>
  
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span></div>


<span class="c1">########################################################################################</span>
<span class="c1">### Visualization</span>
<span class="c1">########################################################################################</span>

<div class="viewcode-block" id="overlay_sources"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.overlay_sources">[docs]</a><span class="k">def</span> <span class="nf">overlay_sources</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="mi">98</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Overlays the sources to check thier placement.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout with the sources to overlay.</span>
<span class="sd">  colors : list of tuple of floats or color names</span>
<span class="sd">    The optional RGB colors to use.</span>
<span class="sd">  percentile : int</span>
<span class="sd">    Use this percentile as upper cutoff in the resulting image to enhance contrast.</span>
<span class="sd">  normalize : bool</span>
<span class="sd">    If True normalize image to floats between 0 and 1.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  image : array</span>
<span class="sd">    A color image. </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">overlay_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">);</span></div>


<div class="viewcode-block" id="layout_coloring"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.layout_coloring">[docs]</a><span class="k">def</span> <span class="nf">layout_coloring</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">color_ids</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="n">sources</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">sources</span><span class="p">;</span>
  <span class="n">nsources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">);</span> 
  
  <span class="k">if</span> <span class="n">color_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1">#find sources that overlap</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">):</span>
      <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
      <span class="n">s1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
      <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nsources</span><span class="p">):</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">p1</span><span class="o">+</span><span class="n">s1</span><span class="p">,</span> <span class="n">p2</span><span class="o">+</span><span class="n">s2</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)):</span>
          <span class="n">edges</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">));</span>
    
    <span class="c1"># find graph coloring of overlap structure</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">directed</span> <span class="o">=</span> <span class="kc">False</span><span class="p">);</span>
    <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">nsources</span><span class="p">);</span>
    <span class="n">g</span><span class="o">.</span><span class="n">add_edge_list</span><span class="p">(</span><span class="n">edges</span><span class="p">);</span>  
    <span class="n">color_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gtt</span><span class="o">.</span><span class="n">sequential_vertex_coloring</span><span class="p">(</span><span class="n">g</span><span class="p">)</span><span class="o">.</span><span class="n">a</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">colors</span> <span class="o">==</span> <span class="s1">&#39;ids&#39;</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">color_ids</span><span class="p">;</span>
  
  <span class="n">ncols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">color_ids</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ncols</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
      <span class="n">colors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]];</span>
    <span class="k">elif</span> <span class="n">ncols</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
      <span class="n">colors</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]];</span>
    <span class="k">else</span><span class="p">:</span> 
      <span class="n">colors</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>     <span class="mi">0</span>   <span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span>    <span class="mf">0.25</span><span class="p">,</span>  <span class="mi">0</span>   <span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>     <span class="mf">0.25</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span>  <span class="mi">0</span>   <span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span>    <span class="mf">0.25</span><span class="p">,</span>  <span class="mf">0.25</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>     <span class="mf">0.25</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.125</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span>  <span class="mi">0</span>   <span class="p">],</span>
                <span class="p">[</span><span class="mf">0.125</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>     <span class="mf">0.25</span><span class="p">]];</span>
  <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">as_int</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">];</span>
  <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">colors</span><span class="p">[:</span><span class="n">ncols</span><span class="p">],</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">))),(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;wrap&#39;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">colors</span><span class="p">[</span><span class="n">color_ids</span><span class="p">];</span></div>


<div class="viewcode-block" id="overlay_layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.overlay_layout">[docs]</a><span class="k">def</span> <span class="nf">overlay_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="mi">98</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color_ids</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Overlays the sources to check their placement.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout : Layout class</span>
<span class="sd">    The layout with the sources to overlay.</span>
<span class="sd">  colors : list of tuple of floats or color names</span>
<span class="sd">    The optional RGB colors to use.</span>
<span class="sd">  percentile : int</span>
<span class="sd">    Use this percentile as upper cutoff in the resulting image to enhance contrast.</span>
<span class="sd">  normalize : bool</span>
<span class="sd">    If True normalize image to floats between 0 and 1.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  image : array</span>
<span class="sd">    A color image. </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">#full shape</span>
  <span class="n">full_shape</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">extent</span><span class="p">);</span>
  <span class="n">full_lower</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">lower</span><span class="p">;</span>
  
  <span class="n">source_colors</span> <span class="o">=</span> <span class="n">layout_coloring</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">color_ids</span><span class="o">=</span><span class="n">color_ids</span><span class="p">);</span>                             
  <span class="k">if</span> <span class="n">colors</span> <span class="o">==</span> <span class="s1">&#39;ids&#39;</span><span class="p">:</span>
    <span class="n">image</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">full_shape</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">source_colors</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)];</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">full_shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,));</span>
  
  <span class="c1"># construct full image</span>
  <span class="n">sources</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">sources</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">source_colors</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">;</span> <span class="n">u</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">ll</span> <span class="o">-</span> <span class="n">fl</span> <span class="p">,</span> <span class="n">uu</span> <span class="o">-</span> <span class="n">fl</span><span class="p">)</span> <span class="k">for</span> <span class="n">ll</span><span class="p">,</span><span class="n">uu</span><span class="p">,</span><span class="n">fl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">full_lower</span><span class="p">));</span>
    <span class="k">if</span> <span class="n">colors</span> <span class="o">==</span> <span class="s1">&#39;ids&#39;</span><span class="p">:</span>
      <span class="n">image</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">r</span><span class="p">]</span> <span class="o">+=</span> <span class="n">s</span><span class="p">[:];</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">r</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),);</span>
      <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">image</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="p">[:],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span><span class="p">[:]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">c</span><span class="p">);</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">s</span><span class="p">[:],</span> <span class="n">c</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">percentile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">colors</span> <span class="o">==</span> <span class="s1">&#39;ids&#39;</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">percentile</span><span class="p">);</span> 
        <span class="n">i</span><span class="p">[</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">percentile</span><span class="p">);</span> 
      <span class="n">image</span><span class="p">[</span><span class="n">image</span> <span class="o">&gt;</span> <span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
  <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">colors</span> <span class="o">==</span> <span class="s1">&#39;ids&#39;</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">/=</span> <span class="n">i</span><span class="o">.</span><span class="n">max</span><span class="p">();</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">c</span><span class="p">]</span> <span class="o">/=</span> <span class="n">image</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">image</span><span class="p">;</span></div>


<div class="viewcode-block" id="plot_sources"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.plot_sources">[docs]</a><span class="k">def</span> <span class="nf">plot_sources</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="mi">98</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Overlays and plots sources in a layout to check alignment.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout: Layout class</span>
<span class="sd">    The layout to use for plotting.</span>
<span class="sd">  colors : list of colors or None</span>
<span class="sd">    The optional RGB colors to use.</span>
<span class="sd">  percentile : int</span>
<span class="sd">    Use this percentile as upper cutoff in the resulting image to enhance contrast.</span>
<span class="sd">  normalize : bool</span>
<span class="sd">    If True normalize image to floats between 0 and 1.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  image : array</span>
<span class="sd">    A color image of the overlayed sources.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">plot_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.plot_layout">[docs]</a><span class="k">def</span> <span class="nf">plot_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="mi">98</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">color_ids</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Overlays and plots sources in a layout to check alignment.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout: Layout class</span>
<span class="sd">    The layout to use for plotting.</span>
<span class="sd">  colors : list of colors or None</span>
<span class="sd">    The optional RGB colors to use.</span>
<span class="sd">  percentile : int</span>
<span class="sd">    Use this percentile as upper cutoff in the resulting image to enhance contrast.</span>
<span class="sd">  normalize : bool</span>
<span class="sd">    If True normalize image to floats between 0 and 1.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  image : array</span>
<span class="sd">    A color image of the overlayed sources.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">img</span> <span class="o">=</span> <span class="n">overlay_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">colors</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="n">percentile</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">color_ids</span> <span class="o">=</span> <span class="n">color_ids</span><span class="p">);</span>
  <span class="k">if</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])[:,:,:],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">img</span><span class="p">);</span></div>
  

<div class="viewcode-block" id="plot_regions"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.plot_regions">[docs]</a><span class="k">def</span> <span class="nf">plot_regions</span><span class="p">(</span><span class="n">regions</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">rainbow</span><span class="p">,</span> <span class="n">annotate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
  <span class="sd">&quot;&quot;&quot;Overlays and plots regions to check the alignment.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  regions : list of Region classes.</span>
<span class="sd">    The regions to plot.</span>
<span class="sd">  cmap : colormap</span>
<span class="sd">    The color map to use to color the regions.</span>
<span class="sd">  annotate : bool</span>
<span class="sd">    Use annotaton or not.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">sources</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">])));</span>
  
  <span class="n">sources_to_ids</span> <span class="o">=</span> <span class="p">{</span> <span class="n">s</span> <span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">)};</span>
    
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">regions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  <span class="k">if</span> <span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The regions are plotted in 2d using axes </span><span class="si">%r</span><span class="s1"> but are </span><span class="si">%d</span><span class="s1">d!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">ndim</span><span class="p">));</span>
    
  <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span>
  
  <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">();</span>
  <span class="n">rmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">);</span>
  <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">);</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regions</span><span class="p">):</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">)[</span><span class="n">axes</span><span class="p">],</span> <span class="n">r</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">r</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">-</span> <span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">regions</span><span class="p">)));</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">annotate</span><span class="p">:</span>
      <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">sources_to_ids</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">sources</span><span class="p">]</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ids</span><span class="p">)),</span> <span class="n">xy</span><span class="o">=</span><span class="n">rec</span><span class="o">.</span><span class="n">get_xy</span><span class="p">(),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> 
                  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                  <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round, pad=.5&#39;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">92</span><span class="p">),</span> <span class="n">ec</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">));</span>
    <span class="n">rmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">rmin</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">lower</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">rmax</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">upper</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
                                          
  <span class="c1">#limits</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">rmin</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">rmax</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]));</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="n">rmin</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">rmax</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]));</span> </div>


<div class="viewcode-block" id="plot_alignments"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.plot_alignments">[docs]</a><span class="k">def</span> <span class="nf">plot_alignments</span><span class="p">(</span><span class="n">alignments</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">annotate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span>  <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">hot</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Plots the alignments with their quality&quot;&quot;&quot;</span>
  
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  <span class="k">if</span> <span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The regions are plotted in 2d using axes </span><span class="si">%r</span><span class="s1"> but are </span><span class="si">%d</span><span class="s1">d!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">ndim</span><span class="p">));</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    
  <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">];</span>  
  
  <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">quality</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">]);</span>
  
  <span class="n">q_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
  <span class="k">if</span> <span class="n">q_max</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
    <span class="n">q_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">q_min</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">q_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">q_min</span> <span class="o">==</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
      <span class="n">q_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">q</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]);</span>
    <span class="n">q_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_quality</span><span class="p">,</span> <span class="n">q_min</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">q_max</span> <span class="o">&lt;=</span> <span class="n">q_min</span><span class="p">:</span>
      <span class="n">q_max</span> <span class="o">=</span> <span class="n">q_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">if</span> <span class="n">sources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">sources_from_alignments</span><span class="p">(</span><span class="n">alignments</span><span class="p">);</span>
  
  <span class="c1">#plot</span>
  <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">();</span>
  <span class="n">rmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">);</span>
  <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">);</span>
  
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
    <span class="c1">#plot the source boundary</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">)[</span><span class="n">axes</span><span class="p">];</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">upper</span><span class="p">)[</span><span class="n">axes</span><span class="p">];</span>
    
    <span class="n">rec</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Rectangle</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">upper</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fill</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;gray&#39;</span><span class="p">);</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>
    <span class="c1">#if annotate:</span>
    <span class="c1">#  ax.annotate(str(s.id), xy=rec.get_xy(), xytext=(0, 0), textcoords=&#39;offset points&#39;, </span>
    <span class="c1">#              color=&#39;w&#39;, ha=&#39;center&#39;, fontsize=8,</span>
    <span class="c1">#              bbox=dict(boxstyle=&#39;round, pad=.5&#39;, fc=(.1, .1, .1, .92), ec=(1., 1., 1.), lw=1, zorder=1));</span>
    <span class="n">rmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">rmin</span><span class="p">,</span> <span class="n">lower</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">rmax</span><span class="p">,</span> <span class="n">upper</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
  
  <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">((</span><span class="n">rmin</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">rmax</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]));</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">((</span><span class="n">rmin</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">rmax</span><span class="p">[</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]));</span> 


  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
    <span class="c1">#print a, a.pre.lower, a.pre.upper</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">lower</span><span class="p">)[</span><span class="n">axes</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">upper</span><span class="p">)[</span><span class="n">axes</span><span class="p">]);</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">lower</span><span class="p">)[</span><span class="n">axes</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">upper</span><span class="p">)[</span><span class="n">axes</span><span class="p">]);</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">quality</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
      <span class="n">c</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">quality</span><span class="p">)</span> <span class="o">-</span> <span class="n">q_min</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">q_max</span> <span class="o">-</span> <span class="n">q_min</span><span class="p">));</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span><span class="p">;</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">color</span> <span class="o">=</span> <span class="n">c</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">annotate</span><span class="p">:</span>
      <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.2e</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">a</span><span class="o">.</span><span class="n">quality</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span><span class="o">+</span><span class="n">p2</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> 
                  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                  <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round, pad=.5&#39;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="o">.</span><span class="mi">92</span><span class="p">),</span> <span class="n">ec</span><span class="o">=</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">));</span></div>



<span class="c1">#TODO: join overlap with real code</span>
<div class="viewcode-block" id="layout_along_axis_mip"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.layout_along_axis_mip">[docs]</a><span class="k">def</span> <span class="nf">layout_along_axis_mip</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ranges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Layout corresponding to a mip projected alignment</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  &quot;&quot;&quot;</span>  
  <span class="c1">#format the shifts</span>
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">depth</span><span class="p">,)</span> <span class="o">*</span> <span class="n">ndim</span><span class="p">;</span>
            
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ranges</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="n">ranges</span><span class="p">]</span> <span class="o">*</span> <span class="n">ndim</span><span class="p">;</span>    
  
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">_format_max_shifts</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">ndim</span><span class="p">);</span>

  <span class="c1">#mip axis</span>
<span class="c1">#  t1 = src1.tile_position;</span>
<span class="c1">#  t2 = src2.tile_position;</span>
<span class="c1">#  if not t1 is None and not t2 is None:</span>
<span class="c1">#    mip_axis = np.where(np.array(t1) - t2 != 0)[0][0];</span>
<span class="c1">#  else:</span>
<span class="c1">#    mip_axis = None;</span>
<span class="c1">#  </span>
<span class="c1">#  if mip_axis is None:</span>
<span class="c1">#    #take the smallest overlapping dim</span>
<span class="c1">#    r1 = Region(position = src1.position, shape = src1.shape);</span>
<span class="c1">#    r2 = Region(position = src2.position, shape = src2.shape);</span>
<span class="c1">#    overlap1, _ = _overlap_with_shifts(r1, r2, max_shifts = max_shifts);</span>
<span class="c1">#    mip_shape = None; </span>
<span class="c1">#    mip_axis = None; </span>
<span class="c1">#    for d,s in enumerate(overlap1.shape):</span>
<span class="c1">#        if mip_shape is None:</span>
<span class="c1">#          mip_shape = s;</span>
<span class="c1">#          mip_axis = d;</span>
<span class="c1">#        elif mip_shape &lt; s:</span>
<span class="c1">#          mip_shape = s;</span>
<span class="c1">#          mip_axis = d;</span>
  <span class="n">mip_axis</span> <span class="o">=</span> <span class="n">_mip_axis</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">);</span>
  <span class="n">mip_depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">mip_axis</span><span class="p">];</span>
  
  <span class="c1">#reduce sources to ranges along non-mip axes</span>
  <span class="k">if</span> <span class="n">ranges</span> <span class="o">!=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranges</span><span class="p">):</span>
    <span class="n">sl1</span> <span class="o">=</span> <span class="p">();</span> <span class="n">sl2</span> <span class="o">=</span> <span class="p">();</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">;</span> <span class="n">p2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>          
    <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ranges</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">mip_axis</span> <span class="ow">and</span> <span class="n">r</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sl1</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="n">d</span><span class="p">]),)</span>
        <span class="n">sl2</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p2</span><span class="p">[</span><span class="n">d</span><span class="p">]),)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">sl1</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),);</span>
        <span class="n">sl2</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),);</span>      

    <span class="n">src1</span> <span class="o">=</span> <span class="n">Slice</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">src1</span><span class="p">,</span> <span class="n">slicing</span> <span class="o">=</span> <span class="n">sl1</span><span class="p">);</span>
    <span class="n">src2</span> <span class="o">=</span> <span class="n">Slice</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">src2</span><span class="p">,</span> <span class="n">slicing</span> <span class="o">=</span> <span class="n">sl2</span><span class="p">);</span>                  
  
  <span class="c1">#mip</span>
  <span class="n">mip_depth</span> <span class="o">=</span> <span class="n">depth</span><span class="p">[</span><span class="n">mip_axis</span><span class="p">];</span>
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">[:</span><span class="n">mip_axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_shifts</span><span class="p">[</span><span class="n">mip_axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
  
  <span class="n">s1</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
  <span class="n">s2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
  
  <span class="c1"># max intensity projections </span>
  <span class="n">sub1</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">ndim</span><span class="p">;</span>
  <span class="n">sub1</span><span class="p">[</span><span class="n">mip_axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s1</span><span class="p">[</span><span class="n">mip_axis</span><span class="p">]</span> <span class="o">-</span> <span class="n">mip_depth</span><span class="p">),</span> <span class="kc">None</span><span class="p">);</span>
  <span class="n">sub1</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sub1</span><span class="p">);</span>
  
  <span class="n">sub2</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">ndim</span><span class="p">;</span>
  <span class="n">sub2</span><span class="p">[</span><span class="n">mip_axis</span><span class="p">]</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">mip_depth</span><span class="p">,</span> <span class="n">s2</span><span class="p">[</span><span class="n">mip_axis</span><span class="p">]));</span>
  <span class="n">sub2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sub2</span><span class="p">);</span>          
              
  <span class="c1"># calculate max projection along axis  </span>
  <span class="n">mip1</span> <span class="o">=</span> <span class="n">max_intensity_projection</span><span class="p">(</span><span class="n">src1</span><span class="p">[</span><span class="n">sub1</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">mip_axis</span><span class="p">);</span>
  <span class="n">mip2</span> <span class="o">=</span> <span class="n">max_intensity_projection</span><span class="p">(</span><span class="n">src2</span><span class="p">[</span><span class="n">sub2</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">mip_axis</span><span class="p">);</span>                               
  
  <span class="c1">#add position information</span>
  <span class="n">p1</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">[:</span><span class="n">mip_axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">src1</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">mip_axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
  <span class="n">p2</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">[:</span><span class="n">mip_axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">src2</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">mip_axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
  <span class="c1">#print axis, p1, p2</span>
  
  <span class="n">mip1</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">mip1</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="n">p1</span><span class="p">,</span> <span class="n">tile_position</span> <span class="o">=</span> <span class="n">src1</span><span class="o">.</span><span class="n">tile_position</span><span class="p">);</span>
  <span class="n">mip2</span> <span class="o">=</span> <span class="n">Source</span><span class="p">(</span><span class="n">mip2</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="n">p2</span><span class="p">,</span> <span class="n">tile_position</span> <span class="o">=</span> <span class="n">src2</span><span class="o">.</span><span class="n">tile_position</span><span class="p">);</span>
  <span class="c1">#print mip1, mip2              </span>

  <span class="k">return</span> <span class="n">Layout</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">mip1</span><span class="p">,</span> <span class="n">mip2</span><span class="p">]);</span></div>
 
 
<div class="viewcode-block" id="overlay_along_axis_mip"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.overlay_along_axis_mip">[docs]</a><span class="k">def</span> <span class="nf">overlay_along_axis_mip</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ranges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="n">layout</span> <span class="o">=</span> <span class="n">layout_along_axis_mip</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">overlay_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_along_axis_mip"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingRigid.html#ClearMap.Alignment.Stitching.StitchingRigid.plot_along_axis_mip">[docs]</a><span class="k">def</span> <span class="nf">plot_along_axis_mip</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ranges</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="n">layout</span> <span class="o">=</span> <span class="n">layout_along_axis_mip</span><span class="p">(</span><span class="n">src1</span><span class="p">,</span> <span class="n">src2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="n">ranges</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">plot_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
 

<span class="c1">########################################################################################</span>
<span class="c1">### Tests</span>
<span class="c1">########################################################################################</span>

<span class="k">def</span> <span class="nf">_test</span><span class="p">():</span>
  <span class="kn">import</span> <span class="nn">ClearMap.Alignment.Stitching.StitchingRigid</span> <span class="k">as</span> <span class="nn">stb</span><span class="p">;</span>
  <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stb</span><span class="p">);</span>
  
  <span class="c1">#overlaps and embeddings</span>
  <span class="n">r1</span> <span class="o">=</span> <span class="n">stb</span><span class="o">.</span><span class="n">Region</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">upper</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">));</span>
  <span class="n">r2</span> <span class="o">=</span> <span class="n">stb</span><span class="o">.</span><span class="n">Region</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span> <span class="n">upper</span> <span class="o">=</span> <span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">120</span><span class="p">));</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">stb</span><span class="o">.</span><span class="n">embedding</span><span class="p">([</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">])</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
  
  
  <span class="kn">import</span> <span class="nn">ClearMap.Alignment.Stitching.StitchingRigid</span> <span class="k">as</span> <span class="nn">stb</span><span class="p">;</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="kn">import</span> <span class="nn">ClearMap.Tests.Files</span> <span class="k">as</span> <span class="nn">tfs</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tfs</span><span class="o">.</span><span class="n">vasculature_pre</span><span class="p">)[:,:</span><span class="mi">100</span><span class="p">,:</span><span class="mi">100</span><span class="p">];</span>
  
  <span class="c1">#divide data</span>
  <span class="n">data1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">210</span><span class="p">,:,:]</span>
  <span class="n">data2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">200</span><span class="p">:,:,:];</span>
  
  <span class="c1">#reload(stb)</span>
  <span class="n">s1</span> <span class="o">=</span> <span class="n">stb</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">data1</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
  <span class="n">s2</span> <span class="o">=</span> <span class="n">stb</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">data2</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">190</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
  
  <span class="n">stb</span><span class="o">.</span><span class="n">align_2_sources</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
  
  
  <span class="c1">#Slicing layouts</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">stb</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">],</span> <span class="n">alignments</span> <span class="o">=</span> <span class="p">[</span><span class="n">stb</span><span class="o">.</span><span class="n">Alignment</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="n">s1</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="n">s2</span><span class="p">)])</span>
  
  <span class="n">l</span><span class="o">.</span><span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_overlay</span><span class="p">()</span>
  
  <span class="n">s</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">slice_along_axis</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
  
  
  <span class="n">s</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
  
  <span class="n">s</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
  <span class="n">s</span><span class="o">.</span><span class="n">plot_alignments</span><span class="p">()</span>
  
  <span class="n">d</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span>
  <span class="n">stb</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
  
  <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">data</span><span class="p">[:,:,</span><span class="mi">50</span><span class="p">])</span>
  
  
  <span class="n">l</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">15</span><span class="p">)</span>
  <span class="n">l</span><span class="o">.</span><span class="n">place</span><span class="p">()</span>

  <span class="n">l</span><span class="o">.</span><span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_overlay</span><span class="p">()</span>
  
  <span class="c1">#Tiled layouts</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stb</span><span class="p">)</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">stb</span><span class="o">.</span><span class="n">TiledLayout</span><span class="p">([</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">],</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="mi">15</span><span class="p">);</span>
  <span class="n">l</span><span class="o">.</span><span class="n">plot_regions</span><span class="p">()</span>
  
  <span class="n">l</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">max_shifts</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">l</span><span class="o">.</span><span class="n">plot_alignments</span><span class="p">()</span>

  <span class="n">l</span><span class="o">.</span><span class="n">sources</span>
  <span class="n">l</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">lower_to_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">l</span><span class="o">.</span><span class="n">sources</span>
  <span class="n">l</span><span class="o">.</span><span class="n">plot_alignments</span><span class="p">()</span>
  
  <span class="n">d</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span>
  <span class="n">stb</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
  

  
  <span class="c1">#2d Tiles</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tfs</span><span class="o">.</span><span class="n">vasculature_pre</span><span class="p">)[:,:,:</span><span class="mi">100</span><span class="p">];</span>
  <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
  
  <span class="c1">#divide data</span>
  <span class="n">data1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">220</span><span class="p">,:</span><span class="mi">220</span><span class="p">,:];</span>
  <span class="n">data2</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">200</span><span class="p">:,:</span><span class="mi">215</span><span class="p">,:];</span>
  <span class="n">data3</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">208</span><span class="p">,</span><span class="mi">200</span><span class="p">:,:];</span>
  <span class="n">data4</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">193</span><span class="p">:,</span><span class="mi">198</span><span class="p">:,:];</span>
  
  <span class="n">tiling</span> <span class="o">=</span> <span class="p">[[</span><span class="n">data1</span><span class="p">,</span> <span class="n">data3</span><span class="p">],[</span><span class="n">data2</span><span class="p">,</span> <span class="n">data4</span><span class="p">]];</span>
  <span class="c1">#this should result </span>
  
  <span class="n">reload</span><span class="p">(</span><span class="n">stb</span><span class="p">)</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">stb</span><span class="o">.</span><span class="n">TiledLayout</span><span class="p">(</span><span class="n">tiling</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">tile_positions</span><span class="p">)</span>
  <span class="n">l</span><span class="o">.</span><span class="n">center_tile_source</span><span class="p">()</span>
  <span class="n">l</span><span class="o">.</span><span class="n">source_positions</span><span class="p">()</span>
  
  <span class="n">l</span><span class="o">.</span><span class="n">align_on_tiling</span><span class="p">(</span><span class="n">max_shifts</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span><span class="mi">25</span><span class="p">),</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
  <span class="n">l</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;optimization&#39;</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
  <span class="n">l</span><span class="o">.</span><span class="n">plot_alignments</span><span class="p">()</span>  
  
  <span class="n">s</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
  <span class="n">stb</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span>
  
  <span class="c1"># Tiles from files</span>
  <span class="n">expression</span> <span class="o">=</span> <span class="n">stb</span><span class="o">.</span><span class="n">te</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="s1">&#39;test_&lt;X,I,2&gt;_&lt;Y,I,4&gt;.tif&#39;</span><span class="p">);</span>
  
  <span class="kn">import</span> <span class="nn">ClearMap.IO.IO</span> <span class="k">as</span> <span class="nn">io</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tiling</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tiling</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
      <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">string</span><span class="p">({</span><span class="s1">&#39;X&#39;</span> <span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span> <span class="p">:</span> <span class="n">j</span><span class="p">}),</span> <span class="n">tiling</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>  
  
  <span class="n">reload</span><span class="p">(</span><span class="n">stb</span><span class="p">)</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">stb</span><span class="o">.</span><span class="n">TiledLayout</span><span class="p">(</span><span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="p">)</span>  
  <span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">tile_positions</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">([</span><span class="n">src</span><span class="o">.</span><span class="n">location</span> <span class="k">for</span> <span class="n">src</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">sources</span><span class="p">])</span>
  
  <span class="n">l</span><span class="o">.</span><span class="n">align_on_tiling</span><span class="p">(</span><span class="n">max_shifts</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span><span class="mi">25</span><span class="p">),</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
  <span class="n">l</span><span class="o">.</span><span class="n">place</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;optimization&#39;</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> 
  
  <span class="n">s</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">stitch</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
  
  <span class="n">stb</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  
  <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span>
  
  <span class="c1">#cleanup</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tiling</span><span class="p">)):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tiling</span><span class="p">[</span><span class="n">i</span><span class="p">])):</span>
      <span class="n">stb</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">delete_file</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">string</span><span class="p">({</span><span class="s1">&#39;X&#39;</span> <span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span> <span class="p">:</span> <span class="n">j</span><span class="p">}))</span>  
  
</pre></div>
 <!-- body -->
    </div> <!-- body -->
    </div> <!-- bodywrapper -->
    

     
  <!-- mainrow --></div>
<!-- document --></div>
<div class="document" style="background-color: #ffffff; text-align: left; padding: 5px 0px 5px 0px">
<p align="center">
<a href="../../../../overview.html"><img src="../../../../_static/ClearMap_banner.jpg" height=150px width=150% border="0" alt="ClearMap"/></a>
</p>
</div>

    <div class="footer" role="contentinfo">
        &#169; Copyright Copyright Â© 2020 by Christoph Kirst.
    </div>
  </body>
</html>