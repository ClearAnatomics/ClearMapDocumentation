
<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>ClearMap.Alignment.Stitching.StitchingWobbly &#8212; ClearMap 2.0.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/clearmap.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/clearmap_utils.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/clearmap_sidebar.css" />
    
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <script src="https://platform.twitter.com/widgets.js"></script>
    <script src="../../../../_static/clipboard.min.js"></script>
    <script src="../../../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../../_static/clearmap.js"></script>
    <script src="../../../../_static/clearmap_sidebar.js"></script>
    <script src="../../../../_static/clearmap_togglebutton.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <!--[if lt IE 9]>
  <script src="_static/css3-mediaqueries.js"></script>
  <![endif]-->

  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700' rel='stylesheet' type='text/css'/>
   

  </head><body>
<div class="document">
 <div class="imagecontainer">
  <a href="../../../../home.html"><img src="../../../../_static/ClearMap_banner.jpg" height=150px width=150% border="0" alt="ClearMap"/></a>
  <div class="top-left">
    <p style="font-size: 30px"> 
       <a href="../../../../home.html" style="color: #ffffff; font-weight: bold"> ClearMap Documentation </a>
    </p>
  </div>
  <div class="top-right">
    <ul class="link-list">
     <li class="link-list"><a href="../../../../home.html">Home</a></li>
     <li class="link-list"><a href="../../../../overview.html">Overview</a></li>    
     <li class="link-list"><a href="../../../../installation.html">Installation</a></li>
     <li class="link-list"><a href="https://github.com/ChristophKirst/ClearMap2"> <img src="../../../../_static/GitHub-Mark.png" height=16px alt="Github"/> Source</a>
    </ul>
  </div>
  <div class="bottom-right">
    <a href="https://twitter.com/clearmap_idisco?ref_src=twsrc%5Etfw" class="twitter-follow-button" data-show-count="false">Follow @clearmap_idisco</a>
      <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>  </a>
  </div>
 </div>
</div>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
       <li><a href="../../../../home.html">Home</a>|&nbsp;</li>
       <li><a href="../../../../overview.html">Overview</a>|&nbsp;</li>      
       <li><a href="../../../../search.html">Search</a>|&nbsp;</li>
       <li><a href="../../../../index.html">Documentation </a> |&nbsp;</li>
       <li><a href="../../../../index.html#clearmap-api">API </a> &raquo;</li>     

          <li class="nav-item nav-item-1"><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
<div class="document">
    
    <div class="documentwrapper">
    
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3><a href="../../../../index.html">ClearMap</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../functionality.html">Functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../wobblystitcher.html">WobblyStitcher</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cellmap.html">CellMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../CellMap.html">CellMap Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tubemap.html">TubeMap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../TubeMap.html">TubeMap Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../media.html">News and Media</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">ClearMap</a></li>
</ul>
 

<h3>Questions? Suggestions?</h3>
<p>Open an issue at the
  <a href="https://github.com/ChristophKirst/ClearMap2/issues">tracker</a>.</p>
  

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
    <div class="sphinxsidebar_right" role="navigation" aria-label="right navigation">
      <div class="sphinxsidebarwrapper_right">
        <h3> <a href="../../../../cellmap.html">CellMap Pipeline</a></h3>
          <a href="../../../../cellmap.html">
            <img src="../../../../_static/CellMap_small_fast.gif" width=250px height=140px alt="CellMap"/></a>
        <h3> <a href="../../../../tubemap.html">Tubemap Pipeline</a></h3>
          <a href="../../../../tubemap.html">
            <img src="../../../../_static/TubeMap_raw_movie_small.gif" width=250px height=140px alt="TubeMap"/></a>
        <h3> <a href="../../../../media.html#gallery"> Gallery</a></h3>
          <a href="../../../../media.html#gallery">
            <img src="../../../../_static/TubeMap_graph_movie_small.gif" width=250px height=140px alt="Gallery"/></a> 
        <h3> <a href="../../../../media.html#videos">Social Media and Videos</a></h3>
          <a href="../../../../media.html#videos">   
            <img src="../../../../_static/TEDx.png" width=250px height=70px alt="Videos"/></a>  
      </div>
    </div>
      <!-- sidebar2 --> 
    
    
    <div class="bodywrapper">       
    <div class="body" role="main">
          
  <h1>Source code for ClearMap.Alignment.Stitching.StitchingWobbly</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">StitchingWobbly</span>
<span class="sd">===============</span>

<span class="sd">Wobbly stitching module handles the alginment of large volumetric data sets.</span>

<span class="sd">The module alings stacks allowing them to wobble around a wobble axis, i.e. </span>
<span class="sd">due to oscillatory movements during image aquisition.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="n">__author__</span>    <span class="o">=</span> <span class="s1">&#39;Christoph Kirst &lt;christoph.kirst.ck@gmail.com&gt;&#39;</span>
<span class="n">__license__</span>   <span class="o">=</span> <span class="s1">&#39;GPLv3 - GNU General Pulic License v3 (see LICENSE)&#39;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s1">&#39;Copyright Â© 2020 by Christoph Kirst&#39;</span>
<span class="n">__webpage__</span>   <span class="o">=</span> <span class="s1">&#39;http://idisco.info&#39;</span>
<span class="n">__download__</span>  <span class="o">=</span> <span class="s1">&#39;http://www.github.com/ChristophKirst/ClearMap2&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">functools</span> <span class="k">as</span> <span class="nn">ft</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mp</span>
<span class="kn">import</span> <span class="nn">concurrent.futures</span>

<span class="kn">import</span> <span class="nn">graph_tool</span> <span class="k">as</span> <span class="nn">gt</span>
<span class="kn">import</span> <span class="nn">graph_tool.topology</span> <span class="k">as</span> <span class="nn">gtt</span>


<span class="kn">import</span> <span class="nn">ClearMap.IO.IO</span> <span class="k">as</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">ClearMap.IO.Slice</span> <span class="k">as</span> <span class="nn">slc</span>

<span class="kn">import</span> <span class="nn">ClearMap.Alignment.Stitching.StitchingRigid</span> <span class="k">as</span> <span class="nn">strg</span>
<span class="kn">import</span> <span class="nn">ClearMap.Alignment.Stitching.Tracking</span> <span class="k">as</span> <span class="nn">trk</span>

<span class="kn">import</span> <span class="nn">ClearMap.ParallelProcessing.ParallelTraceback</span> <span class="k">as</span> <span class="nn">ptb</span>

<span class="kn">import</span> <span class="nn">ClearMap.Utils.Timer</span> <span class="k">as</span> <span class="nn">tmr</span>
<span class="kn">import</span> <span class="nn">ClearMap.Utils.TagExpression</span> <span class="k">as</span> <span class="nn">te</span>

<span class="c1">###############################################################################</span>
<span class="c1">###  Layout</span>
<span class="c1">###############################################################################</span>

<div class="viewcode-block" id="WobblySource"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource">[docs]</a><span class="k">class</span> <span class="nc">WobblySource</span><span class="p">(</span><span class="n">strg</span><span class="o">.</span><span class="n">Source</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Class to handle source data and positions of wobbly stacks.&quot;&quot;&quot;</span>
  
  <span class="n">ISOLATED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
  <span class="n">INVALID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">VALID</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">FIXED</span> <span class="o">=</span> <span class="mi">2</span>
  
  <span class="n">status_to_description</span> <span class="o">=</span> <span class="p">{</span><span class="n">ISOLATED</span> <span class="p">:</span> <span class="s1">&#39;isolated&#39;</span><span class="p">,</span>
                           <span class="n">INVALID</span>  <span class="p">:</span> <span class="s1">&#39;invalid&#39;</span><span class="p">,</span>
                           <span class="n">VALID</span>    <span class="p">:</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span>
                           <span class="n">FIXED</span>    <span class="p">:</span> <span class="s1">&#39;fixed&#39;</span><span class="p">}</span>
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">wobble</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Source class construtor.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    source: string, array or Source class</span>
<span class="sd">      The image source.</span>
<span class="sd">    position : list of tuple of ints or None</span>
<span class="sd">      The positions of the source&#39;s &#39;lower&#39; corner of the source.</span>
<span class="sd">    wobble : list of list of ints or None</span>
<span class="sd">      The positions of the individual planes in this wobbly source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">strg</span><span class="o">.</span><span class="n">Source</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span> <span class="o">=</span> <span class="n">source</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">,</span> <span class="n">tile_position</span> <span class="o">=</span> <span class="n">tile_position</span><span class="p">);</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">axis</span><span class="p">);</span>    
    
    <span class="k">if</span> <span class="n">wobble</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">WobblySource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_wobble</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_wobble</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wobble</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>  
  
    <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">WobblySource</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_axis</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>  
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;Wobbly-&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="p">;</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">axis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The axis along which the source is assumed to be wobbly.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    axis : int</span>
<span class="sd">      The wobble axes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_axis</span><span class="p">;</span>  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">];</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">height</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">];</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">wobble</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The wobblyness of this source.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wobble : array of ints</span>
<span class="sd">      The deviations from the source position along the wobble axes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wobble</span><span class="p">;</span>  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">wdim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span><span class="o">.</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

  
  <span class="nd">@wobble</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">wobble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wobble</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">wobble</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="ow">or</span> <span class="n">wobble</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wdim</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Number of wobbles </span><span class="si">%d</span><span class="s1"> is not equal the number of planes = </span><span class="si">%d</span><span class="s1"> along the wobble axis </span><span class="si">%d</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wobble</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">));</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_wobble</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wobble</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>
  
<div class="viewcode-block" id="WobblySource.wobble_from_positions"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.wobble_from_positions">[docs]</a>  <span class="k">def</span> <span class="nf">wobble_from_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">;</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_wobble</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">];</span>
    <span class="c1">#set status</span>
    <span class="n">finite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">non_finite</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">finite</span><span class="p">);</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">[</span><span class="n">non_finite</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INVALID</span><span class="p">;</span>  </div>
    <span class="c1">#self._status[finite] = self.VALID;                   </span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The status of each slice of this source.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    status : array of ints</span>
<span class="sd">      The status for each position along the wobble axes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">;</span>    
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">valids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">;</span>
  
  
  <span class="c1">### Geometry</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">lower_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The lower corner of the wobbly source.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lower : tuple of int</span>
<span class="sd">      The coordinates of the lower corner of the source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wobble_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wobble</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wobble_to_position</span><span class="p">(</span><span class="n">wobble_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">);</span>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">upper_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The upper corner of the source.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    upper : tuple of int</span>
<span class="sd">      The coordinates of the upper corner of the source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wobble_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wobble</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wobble_to_position</span><span class="p">(</span><span class="n">wobble_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">);</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>                                
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">s</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">shape</span><span class="p">));</span>                                      
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The positions of the lower corners of all slices along the wobble axis.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    positions : array</span>
<span class="sd">      The coordinates of the lower corner of the slices along the wobble axis.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">wobble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wobble</span><span class="p">;</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
    <span class="n">coordinate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">;</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">wobble</span><span class="p">[:,:</span><span class="n">axis</span><span class="p">],</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">wobble</span><span class="p">))[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">coordinate</span><span class="p">,</span> 
                                <span class="n">wobble</span><span class="p">[:,</span><span class="n">axis</span><span class="p">:]],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">positions</span><span class="p">;</span>
  
  
<div class="viewcode-block" id="WobblySource.coordinate_to_local"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.coordinate_to_local">[docs]</a>  <span class="k">def</span> <span class="nf">coordinate_to_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a wobble axis coordinate to the a local coordinate wrt to the sources origin.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    coordinate : int</span>
<span class="sd">      The non-local coordinate.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    loacl_coordinate : int</span>
<span class="sd">      The local coordinate within this source.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span><span class="p">;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">coordinate</span> <span class="o">&lt;</span> <span class="n">position</span> <span class="ow">or</span> <span class="n">coordinate</span> <span class="o">&gt;=</span> <span class="n">position</span> <span class="o">+</span> <span class="n">shape</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Coordinate </span><span class="si">%d</span><span class="s1"> out of range (</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">)!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">position</span> <span class="o">+</span> <span class="n">shape</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">coordinate</span> <span class="o">-</span> <span class="n">position</span><span class="p">;</span></div>
  
    
<div class="viewcode-block" id="WobblySource.coordinate_from_local"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.coordinate_from_local">[docs]</a>  <span class="k">def</span> <span class="nf">coordinate_from_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local_coordinate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a local wobble axis coordiante to the non-local coordinate.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    local_coordinate : int</span>
<span class="sd">      The local coordiante within the source.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    coordiante : int</span>
<span class="sd">      The non-local coordiante.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordainte</span><span class="p">;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">local_coordinate</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">local_coordinate</span> <span class="o">&gt;=</span> <span class="n">shape</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Coordinate </span><span class="si">%d</span><span class="s1"> out of range (</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">)!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">local_coordinate</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">position</span> <span class="o">+</span> <span class="n">shape</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">local_coordinate</span> <span class="o">+</span> <span class="n">position</span><span class="p">;</span></div>

  
<div class="viewcode-block" id="WobblySource.position_at_coordinate"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.position_at_coordinate">[docs]</a>  <span class="k">def</span> <span class="nf">position_at_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the wobbly position of the source at the specified coordinate along the wobble axis.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    coordinate : int</span>
<span class="sd">      The coordinate along the wobble axis.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    position : tuple of int.</span>
<span class="sd">      The non-local position of the specified coordainte slice.</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">local_coordinate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_to_local</span><span class="p">(</span><span class="n">coordinate</span><span class="p">);</span>                                          
    <span class="n">wobble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wobble</span><span class="p">[</span><span class="n">local_coordinate</span><span class="p">];</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wobble_to_position</span><span class="p">(</span><span class="n">wobble</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">);</span> </div>
  
 
<div class="viewcode-block" id="WobblySource.wobble_at_coordinate"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.wobble_at_coordinate">[docs]</a>  <span class="k">def</span> <span class="nf">wobble_at_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the wobbly position of the source at the specified coordinate along the wobble axis.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    coordinate : int</span>
<span class="sd">      The coordinate along the wobble axis.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    position : tuple of int.</span>
<span class="sd">      The non-local position of the specified coordainte slice.</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">local_coordinate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_to_local</span><span class="p">(</span><span class="n">coordinate</span><span class="p">);</span>   
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wobble</span><span class="p">[</span><span class="n">local_coordinate</span><span class="p">];</span></div>
  
  <span class="c1">#status  </span>
  
<div class="viewcode-block" id="WobblySource.status_at_coordinate"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.status_at_coordinate">[docs]</a>  <span class="k">def</span> <span class="nf">status_at_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="n">local_coordinate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_to_local</span><span class="p">(</span><span class="n">coordinate</span><span class="p">);</span>    
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">[</span><span class="n">local_coordinate</span><span class="p">];</span></div>

<div class="viewcode-block" id="WobblySource.set_status_at_coordinate"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.set_status_at_coordinate">[docs]</a>  <span class="k">def</span> <span class="nf">set_status_at_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
    <span class="n">local_coordinate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate_to_local</span><span class="p">(</span><span class="n">coordinate</span><span class="p">);</span>    
    <span class="bp">self</span><span class="o">.</span><span class="n">_status</span><span class="p">[</span><span class="n">local_coordinate</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span></div>
  
<div class="viewcode-block" id="WobblySource.is_valid"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.is_valid">[docs]</a>  <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">coordinate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_at_coordinate</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">;</span></div>
  
<div class="viewcode-block" id="WobblySource.set_invalid"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.set_invalid">[docs]</a>  <span class="k">def</span> <span class="nf">set_invalid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">coordinate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">set_status_at_coordinate</span><span class="p">(</span><span class="n">coordinate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">INVALID</span><span class="p">);</span></div>
  
<div class="viewcode-block" id="WobblySource.set_isolated"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.set_isolated">[docs]</a>  <span class="k">def</span> <span class="nf">set_isolated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">coordinate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinate</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">set_status_at_coordinate</span><span class="p">(</span><span class="n">coordinate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ISOLATED</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="WobblySource.fix_isolated"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.fix_isolated">[docs]</a>  <span class="k">def</span> <span class="nf">fix_isolated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude_borders</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fix the positons of isolated slices.&quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">;</span>
    <span class="n">wobble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wobble</span><span class="p">;</span>
    <span class="n">n_status</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
    <span class="n">isolated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ISOLATED</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
    <span class="n">isolated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">isolated</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">);</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">isolated</span><span class="p">);</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">ends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    
    <span class="c1">#whole stack has no isolated slices</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span>  
                   
    <span class="c1">#if whole stack is isolated</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">starts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ends</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ends</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_status</span><span class="p">:</span>
      <span class="n">status</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ISOLATED</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>             
                   
    <span class="c1">#find left and right bounds for isolated stretches</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">):</span>
      <span class="c1">#exclude borders</span>
      <span class="k">if</span> <span class="n">exclude_borders</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">e</span> <span class="o">==</span> <span class="n">n_status</span><span class="p">:</span>
           <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ISOLATED</span><span class="p">;</span>
           <span class="k">continue</span><span class="p">;</span>
      
      <span class="c1">#find next valid  in each direction</span>
      <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">wobble</span><span class="p">[[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]];</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>                     
      <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">n_status</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">:</span>                      
        <span class="n">right</span> <span class="o">=</span> <span class="n">wobble</span><span class="p">[[</span><span class="n">e</span><span class="p">]];</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">right</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
      <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ISOLATED</span><span class="p">;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">wobble</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
        <span class="k">elif</span> <span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">wobble</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># linearly interpolate</span>
          <span class="n">wobble</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">left</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>
        <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIXED</span><span class="p">;</span></div>
        
  
<div class="viewcode-block" id="WobblySource.smooth_positions"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.smooth_positions">[docs]</a>  <span class="k">def</span> <span class="nf">smooth_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">smooth</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="s1">&#39;bartlett&#39;</span><span class="p">,</span> <span class="n">window_length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)):</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">smooth_positions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="n">smooth</span><span class="p">);</span>                                      
    <span class="k">return</span> <span class="n">positions</span><span class="p">;</span></div>
  
  <span class="c1">### Helper</span>
  
  <span class="k">def</span> <span class="nf">_wobble_to_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wobble</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transform a wobble and axis coordainte to the full position.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    wobble : tuple</span>
<span class="sd">      The wobble to add.</span>
<span class="sd">    coordainte : int</span>
<span class="sd">      The coordinate along the axis</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    position : tuple</span>
<span class="sd">      The poisotn with added wobble.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:</span><span class="n">axis</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">coordinate</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">wobble</span><span class="p">[</span><span class="n">axis</span><span class="p">:]);</span>
  
  
  <span class="c1">### Other</span>
  
<div class="viewcode-block" id="WobblySource.array_wobbly"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblySource.array_wobbly">[docs]</a>  <span class="k">def</span> <span class="nf">array_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the array in the wobbly form with zeros at empty positions.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array : array</span>
<span class="sd">      The data of the array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
    <span class="n">extent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extent</span><span class="p">;</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">extent</span><span class="p">);</span>
    <span class="n">array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">);</span>
    <span class="n">lower_wobble</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wobble</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
    
    <span class="n">slicing</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">extent</span><span class="p">[</span><span class="n">axis</span><span class="p">]):</span>
      <span class="n">slicing_source</span> <span class="o">=</span> <span class="n">slicing</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="p">,)</span> <span class="o">+</span> <span class="n">slicing</span><span class="p">[</span><span class="n">axis</span><span class="p">:];</span>
      <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="n">slicing_source</span><span class="p">];</span>
      
      <span class="n">shape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
      <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wobble</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">lower_wobble</span><span class="p">;</span>
      <span class="n">slicing_data</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">p</span><span class="o">+</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">shape</span><span class="p">));</span>
      <span class="n">slicing_data</span> <span class="o">=</span> <span class="n">slicing_data</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">c</span><span class="p">,)</span> <span class="o">+</span> <span class="n">slicing_data</span><span class="p">[</span><span class="n">axis</span><span class="p">:];</span> 
      <span class="n">array</span><span class="p">[</span><span class="n">slicing_data</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="n">array</span><span class="p">;</span></div>
  
  
  <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="n">new</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="n">new</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
    <span class="n">new</span><span class="o">.</span><span class="n">_wobble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wobble</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">new</span></div>




<div class="viewcode-block" id="WobblyAlignment"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment">[docs]</a><span class="k">class</span> <span class="nc">WobblyAlignment</span><span class="p">(</span><span class="n">strg</span><span class="o">.</span><span class="n">Alignment</span><span class="p">):</span>
  
  <span class="n">NOSIGNAL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span>
  <span class="n">NOMINIMA</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span>
  <span class="n">UNALIGNED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span>
  <span class="n">UNTRACED</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
  <span class="n">INVALID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
  <span class="n">VALID</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">MEASURED</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="n">ALIGNED</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="n">FIXED</span> <span class="o">=</span> <span class="mi">3</span>
  
  <span class="n">status_to_description</span> <span class="o">=</span> <span class="p">{</span><span class="n">NOSIGNAL</span>  <span class="p">:</span> <span class="s1">&#39;no signal&#39;</span><span class="p">,</span>
                           <span class="n">NOMINIMA</span>  <span class="p">:</span> <span class="s1">&#39;no minima&#39;</span><span class="p">,</span>
                           <span class="n">UNALIGNED</span> <span class="p">:</span> <span class="s1">&#39;unaligned&#39;</span><span class="p">,</span>
                           <span class="n">UNTRACED</span>  <span class="p">:</span> <span class="s1">&#39;untraced&#39;</span><span class="p">,</span>
                           <span class="n">INVALID</span>   <span class="p">:</span> <span class="s1">&#39;invalid&#39;</span><span class="p">,</span>
                           <span class="n">VALID</span>     <span class="p">:</span> <span class="s1">&#39;valid&#39;</span><span class="p">,</span>
                           <span class="n">MEASURED</span>  <span class="p">:</span> <span class="s1">&#39;measured&#39;</span><span class="p">,</span>
                           <span class="n">ALIGNED</span>   <span class="p">:</span> <span class="s1">&#39;aligned&#39;</span><span class="p">,</span>
                           <span class="n">FIXED</span>     <span class="p">:</span> <span class="s1">&#39;fixed&#39;</span><span class="p">}</span>
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shifts</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">displacements</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">qualities</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>  <span class="n">shift</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">displacement</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">strg</span><span class="o">.</span><span class="n">Alignment</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="n">quality</span><span class="p">);</span>
    
    <span class="c1">#overlap region</span>
    <span class="n">ovlp</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">overlap</span><span class="p">(</span><span class="n">strg</span><span class="o">.</span><span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="p">:</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">:</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
                       <span class="n">strg</span><span class="o">.</span><span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="p">:</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">:</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">]));</span>
                         
    <span class="k">if</span> <span class="n">ovlp</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The two sources do not overlap along the wobble axis!&#39;</span><span class="p">);</span>
                      
    <span class="n">n</span> <span class="o">=</span> <span class="n">ovlp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="n">displacements</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">d</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">q</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">pre</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span> <span class="k">if</span> <span class="n">d</span> <span class="o">!=</span> <span class="n">axis</span><span class="p">);</span>
      <span class="k">if</span> <span class="n">shifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">displacements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">pre</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">displacements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shifts</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="p">;</span>
                                
    <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="o">=</span> <span class="n">displacements</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="n">qualities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">qualities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">);</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">qualities</span> <span class="o">=</span> <span class="n">qualities</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="n">status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">;</span>                         
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">displacements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">;</span>
    
  <span class="nd">@displacements</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">displacements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_coordinate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_coordinate</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Dimension mismatch </span><span class="si">%d</span><span class="s1"> != </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_coordinate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_coordinate</span><span class="p">));</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">lower_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">coordinate</span><span class="p">);</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">upper_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">coordinate</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">coordinate</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">height</span><span class="p">)</span>
  
<div class="viewcode-block" id="WobblyAlignment.coordinate_to_local"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.coordinate_to_local">[docs]</a>  <span class="k">def</span> <span class="nf">coordinate_to_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_coordinate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_coordinate</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">coordinate</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid coordinate!&#39;</span><span class="p">);</span>
    <span class="k">else</span><span class="p">:</span> 
      <span class="k">return</span> <span class="n">coordinate</span> <span class="o">-</span> <span class="n">lower</span><span class="p">;</span></div>
  
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">shifts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
    <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">;</span>
    <span class="n">pre_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
    <span class="n">post_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
    <span class="n">pre_pos</span> <span class="o">=</span> <span class="n">pre_pos</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">pre_pos</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
    <span class="n">post_pos</span> <span class="o">=</span> <span class="n">post_pos</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">post_pos</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>  
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">displacements</span> <span class="o">-</span> <span class="n">post_pos</span> <span class="o">+</span> <span class="n">pre_pos</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">shifts</span><span class="p">;</span>
  
  <span class="nd">@shifts</span><span class="o">.</span><span class="n">setter</span>
  <span class="k">def</span> <span class="nf">shifts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_coordinate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_coordinate</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Dimension mismatch </span><span class="si">%d</span><span class="s1"> != </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_coordinate</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_coordinate</span><span class="p">));</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
    <span class="n">pre_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
    <span class="n">post_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
    <span class="n">pre_pos</span> <span class="o">=</span> <span class="n">pre_pos</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">pre_pos</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
    <span class="n">post_pos</span> <span class="o">=</span> <span class="n">post_pos</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">post_pos</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>  
    <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="n">post_pos</span> <span class="o">-</span> <span class="n">pre_pos</span><span class="p">;</span>
  
                   
<div class="viewcode-block" id="WobblyAlignment.align_wobbly_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.align_wobbly_axis">[docs]</a>  <span class="k">def</span> <span class="nf">align_wobbly_axis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">shifts</span><span class="p">,</span> <span class="n">qualities</span> <span class="o">=</span> <span class="n">align_wobbly_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">qualities</span> <span class="o">=</span> <span class="n">qualities</span><span class="p">;</span>                                        </div>
  
  
<div class="viewcode-block" id="WobblyAlignment.displacement_at_coordinate"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.displacement_at_coordinate">[docs]</a>  <span class="k">def</span> <span class="nf">displacement_at_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_displacements</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_to_local</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)]</span></div>
    
<div class="viewcode-block" id="WobblyAlignment.quality_at_coordinate"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.quality_at_coordinate">[docs]</a>  <span class="k">def</span> <span class="nf">quality_at_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">qualities</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_to_local</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)]</span></div>
    
<div class="viewcode-block" id="WobblyAlignment.status_at_coordinate"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.status_at_coordinate">[docs]</a>  <span class="k">def</span> <span class="nf">status_at_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_to_local</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)]</span></div>
  
<div class="viewcode-block" id="WobblyAlignment.set_status_at_coordinate"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.set_status_at_coordinate">[docs]</a>  <span class="k">def</span> <span class="nf">set_status_at_coordinate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>     
    <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinate_to_local</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)]</span></div>
  

<div class="viewcode-block" id="WobblyAlignment.valids"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.valids">[docs]</a>  <span class="k">def</span> <span class="nf">valids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
    <span class="n">valids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">min_quality</span><span class="p">:</span>
      <span class="n">valids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">valids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qualities</span> <span class="o">&gt;</span> <span class="n">min_quality</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">valids</span><span class="p">;</span>                             </div>
  
<div class="viewcode-block" id="WobblyAlignment.smooth_displacements"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.smooth_displacements">[docs]</a>  <span class="k">def</span> <span class="nf">smooth_displacements</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">displacements</span> <span class="o">=</span> <span class="n">smooth_displacements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">displacements</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">valids</span><span class="p">(</span><span class="n">min_quality</span><span class="o">=</span><span class="n">min_quality</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span>
    <span class="c1">#self.displacements = displacements                                         </span>
    <span class="k">return</span> <span class="n">displacements</span><span class="p">;</span></div>

<div class="viewcode-block" id="WobblyAlignment.fix_unaligned"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.fix_unaligned">[docs]</a>  <span class="k">def</span> <span class="nf">fix_unaligned</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Linearly interpolate between unaligned coordinates&quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">;</span>
    <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacements</span><span class="p">;</span>
    <span class="n">qualities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qualities</span><span class="p">;</span>
    <span class="n">n_status</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
    <span class="n">unaligned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">UNALIGNED</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
    <span class="n">unaligned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">unaligned</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">);</span>                  
    <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">unaligned</span><span class="p">);</span>
    <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">ends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>                     
    
    <span class="c1">#whole stack is aligned</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">return</span>            
    <span class="c1">#whole stack is unalinged</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">starts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ends</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ends</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_status</span><span class="p">:</span>
      <span class="n">status</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INVALID</span><span class="p">;</span>
      <span class="k">return</span><span class="p">;</span>             
                   
    <span class="c1">#find left and right bounds for isolated stretches</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">):</span>
      <span class="c1">#find next valid  in each direction</span>
      <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">displacements</span><span class="p">[[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]];</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>                     
      <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">n_status</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">:</span>                      
        <span class="n">right</span> <span class="o">=</span> <span class="n">displacements</span><span class="p">[[</span><span class="n">e</span><span class="p">]];</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">right</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
      <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">INVALID</span><span class="p">;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">displacements</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
          <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">qualities</span><span class="p">[</span><span class="n">e</span><span class="p">];</span>
        <span class="k">elif</span> <span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">displacements</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
          <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># linearly interpolate</span>
          <span class="n">displacements</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">left</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>   
          <span class="n">qs</span> <span class="o">=</span> <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
          <span class="n">qe</span> <span class="o">=</span> <span class="n">qualities</span><span class="p">[</span><span class="n">e</span><span class="p">];</span>
          <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">qe</span><span class="p">):</span>                       
            <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">qe</span> <span class="o">-</span> <span class="n">qs</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">qs</span><span class="p">;</span>
          <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">qe</span><span class="p">):</span>
            <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">qe</span><span class="p">;</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">qs</span><span class="p">;</span>
        <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIXED</span><span class="p">;</span></div>
              

  
<div class="viewcode-block" id="WobblyAlignment.overlay_wobbly"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.overlay_wobbly">[docs]</a>  <span class="k">def</span> <span class="nf">overlay_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shifts</span><span class="p">;</span>
    <span class="n">n_slices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">);</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="n">shifts</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">]</span>
    <span class="n">min_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shifts</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shifts</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">min_shifts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">min_shifts</span><span class="p">[:</span><span class="n">axis</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">min_shifts</span><span class="p">[</span><span class="n">axis</span><span class="p">:]);</span> 
    <span class="n">max_shifts</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">[:</span><span class="n">axis</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">[</span><span class="n">axis</span><span class="p">:]);</span>          
    <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">min_shifts</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="n">overlap</span><span class="p">:</span>
      <span class="n">o1</span><span class="p">,</span><span class="n">o2</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">_overlap_with_shifts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="p">[(</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span><span class="p">,</span><span class="n">n</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">min_shifts</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">)]);</span>
    
      <span class="n">i1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">[</span><span class="n">o1</span><span class="o">.</span><span class="n">local_slicing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">)]</span>
      <span class="n">i2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">[</span><span class="n">o2</span><span class="o">.</span><span class="n">local_slicing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">)]</span>
    
      <span class="n">p1</span> <span class="o">=</span> <span class="n">o1</span><span class="o">.</span><span class="n">lower</span><span class="p">;</span>
      <span class="n">p2</span> <span class="o">=</span> <span class="n">o2</span><span class="o">.</span><span class="n">lower</span><span class="p">;</span>
      <span class="n">s1</span> <span class="o">=</span> <span class="n">o1</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
      <span class="n">s2</span> <span class="o">=</span> <span class="n">o2</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">i1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">;</span>
      <span class="n">i2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">;</span>      

      <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
      <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
      <span class="n">s1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
      <span class="n">s2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
    
    <span class="c1">#paddings</span>
    <span class="n">pad1</span> <span class="o">=</span> <span class="p">();</span>
    <span class="n">off2</span> <span class="o">=</span> <span class="p">();</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">();</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
      <span class="n">pad1</span> <span class="o">+=</span> <span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p1</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">p2</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">min_shifts</span><span class="p">[</span><span class="n">d</span><span class="p">])),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p2</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">s2</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_shifts</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">s1</span><span class="p">[</span><span class="n">d</span><span class="p">]))),);</span>
      <span class="n">off2</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p2</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">min_shifts</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">p1</span><span class="p">[</span><span class="n">d</span><span class="p">]),);</span>
      <span class="n">shape</span> <span class="o">+=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">s1</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">pad1</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pad1</span><span class="p">[</span><span class="n">d</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">off2</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_shifts</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_shifts</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="n">s2</span><span class="p">[</span><span class="n">d</span><span class="p">]),);</span>
    
    <span class="n">ovl</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">dtype</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">dtype</span><span class="p">)];</span>
    <span class="n">slice_i</span> <span class="o">=</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">)]</span> <span class="o">*</span> <span class="n">ndim</span><span class="p">;</span>
    
    <span class="n">pad1i</span> <span class="o">=</span> <span class="n">pad1</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">pad1</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_slices</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating overlay slice </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">n_slices</span><span class="p">))</span>
      
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">:</span>
        <span class="n">slice_i</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="n">shift</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">+</span> <span class="n">shift</span><span class="p">[</span><span class="n">axis</span><span class="p">:];</span>
        <span class="n">pad2</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">o</span> <span class="o">+</span> <span class="n">s</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="n">sh</span> <span class="o">-</span> <span class="p">(</span><span class="n">o</span> <span class="o">+</span> <span class="n">s</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="n">sp</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">sh</span><span class="p">,</span><span class="n">sp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">off2</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">min_shifts</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">s2</span><span class="p">));</span>
        <span class="n">pad2i</span> <span class="o">=</span> <span class="n">pad2</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">pad2</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
        <span class="n">ovl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">slice_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">slice_i</span><span class="p">],</span> <span class="n">pad1i</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
        <span class="n">ovl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">slice_i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">i2</span><span class="p">[</span><span class="n">slice_i</span><span class="p">],</span> <span class="n">pad2i</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
  
    <span class="k">return</span> <span class="n">ovl</span><span class="p">;</span>  </div>
  
<div class="viewcode-block" id="WobblyAlignment.plot_overlay_wobbly"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.plot_overlay_wobbly">[docs]</a>  <span class="k">def</span> <span class="nf">plot_overlay_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">strg</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">overlay_wobbly</span><span class="p">()]);</span></div>
   
<div class="viewcode-block" id="WobblyAlignment.overlay_mip_wobbly"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.overlay_mip_wobbly">[docs]</a>  <span class="k">def</span> <span class="nf">overlay_mip_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">mip_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="mi">98</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
    <span class="n">ovl_mip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_wobbly</span><span class="p">(</span><span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">);</span>
    
    <span class="c1">#max project</span>
    <span class="k">if</span> <span class="n">mip_axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">mip_axis</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">_mip_axis</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post</span><span class="p">);</span>
    
    <span class="n">ovl_mip</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">mip_axis</span><span class="p">)</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ovl_mip</span><span class="p">];</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">ovl_mip</span><span class="p">:</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">percentile</span><span class="p">);</span>
      <span class="n">o</span><span class="p">[</span><span class="n">o</span><span class="o">&gt;</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">p</span><span class="p">;</span>
    
    <span class="kn">import</span> <span class="nn">ClearMap.Visualization.Color</span> <span class="k">as</span> <span class="nn">col</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]];</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">color</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">as_int</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">];</span>
    
    <span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ovl_mip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,));</span>
    <span class="k">for</span> <span class="n">o</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ovl_mip</span><span class="p">,</span><span class="n">colors</span><span class="p">):</span>
      <span class="n">image</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">o</span> <span class="o">/</span><span class="n">o</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">c</span><span class="p">);</span>
     
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">image</span><span class="p">[:,:,</span><span class="n">c</span><span class="p">]</span> <span class="o">/=</span> <span class="n">image</span><span class="p">[:,:,</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">();</span> 
      
    <span class="k">return</span> <span class="n">image</span><span class="p">;</span></div>
    
<div class="viewcode-block" id="WobblyAlignment.plot_mip_wobbly"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyAlignment.plot_mip_wobbly">[docs]</a>  <span class="k">def</span> <span class="nf">plot_mip_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">mip_axis</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">percentile</span> <span class="o">=</span> <span class="mi">98</span><span class="p">):</span>
    <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">overlay_mip_wobbly</span><span class="p">(</span><span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span> <span class="n">mip_axis</span><span class="o">=</span><span class="n">mip_axis</span><span class="p">,</span> <span class="n">percentile</span><span class="o">=</span><span class="n">percentile</span><span class="p">);</span>   
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">])[:,:,:],</span> <span class="n">origin</span> <span class="o">=</span> <span class="s1">&#39;lower&#39;</span><span class="p">);</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="WobblyLayout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyLayout">[docs]</a><span class="k">class</span> <span class="nc">WobblyLayout</span><span class="p">(</span><span class="n">strg</span><span class="o">.</span><span class="n">TiledLayout</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Layout to handle stitching of wobbly sources.&quot;&quot;&quot;</span>
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">expression</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_axes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">tile_positions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">positions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">alignments</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;WobblyStackLayout constructor.</span>
<span class="sd">      </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    expression : str</span>
<span class="sd">      Regular expression of source names.</span>
<span class="sd">    tile_axes : tuple of strings</span>
<span class="sd">      The names and ordering of the grid axes of the named groups in the regular expression. If None use the names and order as they appear in expression.</span>
<span class="sd">    tile_shape : tuple of ints or None</span>
<span class="sd">      Shape of the grid. If None determine automatically.</span>
<span class="sd">    tile_positions : list of tuple of ints or None</span>
<span class="sd">      List of grid positions to consider, if None use all available.</span>
<span class="sd">    positions : list of tuples of ints</span>
<span class="sd">      The positions of the individual sources, if None use overlaps to position sources.</span>
<span class="sd">    overlaps : tuple of ints or None</span>
<span class="sd">      Overlaps of the individual sources in each grid dimension. If None assume overlap is zero.</span>
<span class="sd">    shape : tuple of int or None</span>
<span class="sd">      The fixed shape of this Layout, if None the minimal size to fit all sources will be used.</span>
<span class="sd">    position : tuple of int or None</span>
<span class="sd">      The fixed position of this layout, if None the lower corner to fit all sources will be used.</span>
<span class="sd">    dtype: dtype or None</span>
<span class="sd">      The data type to use for this layout, if None use the dtype of the first source.</span>
<span class="sd">    axis : int</span>
<span class="sd">      The wobbly axis of the sources.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize classes</span>
    <span class="n">strg</span><span class="o">.</span><span class="n">TiledLayout</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">,</span> <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="p">,</span> <span class="n">tile_axes</span> <span class="o">=</span> <span class="n">tile_axes</span><span class="p">,</span> <span class="n">tile_shape</span> <span class="o">=</span> <span class="n">tile_shape</span><span class="p">,</span> <span class="n">tile_positions</span> <span class="o">=</span> <span class="n">tile_positions</span><span class="p">,</span> <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="p">,</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="n">overlaps</span><span class="p">,</span> <span class="n">alignments</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">);</span>
    
    <span class="c1"># convert sources to WobblySources</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">WobblySource</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">s</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">];</span>

    <span class="n">alignments</span> <span class="o">=</span> <span class="p">[];</span>     
    <span class="n">sources_to_wobbly_sources</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="p">:</span> <span class="n">w</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">w</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">)};</span>          
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">:</span>
      <span class="n">pre</span> <span class="o">=</span> <span class="n">sources_to_wobbly_sources</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">];</span>
      <span class="n">post</span> <span class="o">=</span> <span class="n">sources_to_wobbly_sources</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">];</span>
      <span class="n">displacement</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">displacement</span><span class="p">;</span>
      <span class="n">quality</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">quality</span><span class="p">;</span>
      <span class="n">alignments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">WobblyAlignment</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="o">=</span><span class="n">post</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">displacement</span><span class="o">=</span><span class="n">displacement</span><span class="p">,</span> <span class="n">quality</span><span class="o">=</span><span class="n">quality</span><span class="p">));</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">alignments</span> <span class="o">=</span> <span class="n">alignments</span><span class="p">;</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">axis</span><span class="p">);</span> 
  
  
  <span class="nd">@property</span>    
  <span class="k">def</span> <span class="nf">lower_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the lower position of the entire layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    lower : tuple of ints</span>
<span class="sd">      The lower position of the full layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">lower_wobbly</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">));</span>
  
  
  <span class="nd">@property</span>   
  <span class="k">def</span> <span class="nf">upper_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculates the upper position of the entire layout.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    upper : tuple of ints</span>
<span class="sd">      The upper position of the full layout.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">upper_wobbly</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">));</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">origin_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_wobbly</span><span class="p">);</span>
  
  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">shape_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">o</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span><span class="n">o</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper_wobbly</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin_wobbly</span><span class="p">))</span>
  
  
<div class="viewcode-block" id="WobblyLayout.set_positions"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyLayout.set_positions">[docs]</a>  <span class="k">def</span> <span class="nf">set_positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set the positions of all wobbly slices and sources.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sources</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
      <span class="n">s</span><span class="o">.</span><span class="n">wobble_from_positions</span><span class="p">(</span><span class="n">p</span><span class="p">);</span></div>
  
                             
<div class="viewcode-block" id="WobblyLayout.slice_along_axis_wobbly"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyLayout.slice_along_axis_wobbly">[docs]</a>  <span class="k">def</span> <span class="nf">slice_along_axis_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a layout corresponding to a slice along the wobble axis in this layout.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    coordinate : int</span>
<span class="sd">      The coordinate at which to take the slice.</span>
<span class="sd">    axis : int</span>
<span class="sd">      The axis to take the slice in.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    layout : Layout class</span>
<span class="sd">      The sliced layout.</span>
<span class="sd">      </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The underlying sources are converted to virtual for parallel stitching.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
    <span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
    
    <span class="c1">#filter sources in slice</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">source</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sources</span> <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">is_valid</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)];</span>
           
    <span class="c1">#slice sources        </span>
    <span class="n">sliced_sources</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
      <span class="n">position</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">wobble_at_coordinate</span><span class="p">(</span><span class="n">coordinate</span><span class="p">);</span>
      <span class="n">slicing</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="n">axis</span> <span class="o">+</span> <span class="p">(</span><span class="n">coordinate</span> <span class="o">-</span> <span class="n">source</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">axis</span><span class="p">);</span>                           
      <span class="n">sliced_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strg</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">Slice</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">as_virtual</span><span class="p">(),</span> <span class="n">slicing</span><span class="o">=</span><span class="n">slicing</span><span class="p">),</span> <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">tile_position</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">tile_position</span><span class="p">));</span>
       
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shape</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_position</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="n">strg</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sliced_sources</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dtype</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_order</span><span class="p">);</span></div>
  
  
<div class="viewcode-block" id="WobblyLayout.layouts_along_axis_wobbly"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyLayout.layouts_along_axis_wobbly">[docs]</a>  <span class="k">def</span> <span class="nf">layouts_along_axis_wobbly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a list of Layouts representing the placed wobbly sources in each wobbly-axis slice of this layout.</span>
<span class="sd">    </span>
<span class="sd">    Arguments</span>
<span class="sd">    ---------</span>
<span class="sd">    coordinates : list of ints, all, or None</span>
<span class="sd">      The positions of the slices along the wobble axis. If all or None take all possible slices.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    slices : list of SlicedLayout classes</span>
<span class="sd">      The layouts in each wobble-axis-plane.</span>
<span class="sd">      </span>
<span class="sd">    Note</span>
<span class="sd">    ----</span>
<span class="sd">    The slices layouts can be used for stitching of the wobbly stacks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#create stitching planes</span>
    <span class="k">if</span> <span class="n">coordinates</span> <span class="ow">is</span> <span class="nb">all</span> <span class="ow">or</span> <span class="n">coordinates</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">coordinates</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_along_axis_wobbly</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">];</span></div>
 

<div class="viewcode-block" id="WobblyLayout.plot_wobble"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyLayout.plot_wobble">[docs]</a>  <span class="k">def</span> <span class="nf">plot_wobble</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">();</span>
    <span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)];</span>            
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alignments</span><span class="p">):</span>
      <span class="n">invalid</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">status</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="n">VALID</span>
      <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">displacements</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
      <span class="n">d</span><span class="p">[</span><span class="n">invalid</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
      <span class="c1">#print invalid.sum()     </span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">lower_coordinate</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">upper_coordinate</span><span class="p">)</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>    
      <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">: </span><span class="si">%r</span><span class="s1">-</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">identifier</span><span class="p">))</span> <span class="c1">#analysis:ignore</span>
    
      <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>            
      <span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">: </span><span class="si">%r</span><span class="s1">-</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">identifier</span><span class="p">))</span> <span class="c1">#analysis:ignore</span>
     
    <span class="k">def</span> <span class="nf">on_pick</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">curve</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_lines</span><span class="p">():</span>
          <span class="k">if</span> <span class="n">curve</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">event</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">curve</span><span class="o">.</span><span class="n">get_label</span><span class="p">())</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;motion_notify_event&#39;</span><span class="p">,</span> <span class="n">on_pick</span><span class="p">)</span>           
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="WobblyLayout.alignment_info"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.WobblyLayout.alignment_info">[docs]</a>  <span class="k">def</span> <span class="nf">alignment_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tile_position</span><span class="p">,</span> <span class="n">coordinate</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">use_displacements</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gathers all alignment info for a slice of a certain tile.&quot;&quot;&quot;</span>
    
    <span class="c1">#get status</span>
    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_from_tile_position</span><span class="p">(</span><span class="n">tile_position</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">status_at_coordinate</span><span class="p">(</span><span class="n">coordinate</span><span class="p">);</span>

    <span class="c1">#get all connecting alignemtns and thier status</span>
    <span class="n">a_status</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="n">alignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alignments_from_tile_position</span><span class="p">(</span><span class="n">tile_position</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
      <span class="n">a_status</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">status_at_coordinate</span><span class="p">(</span><span class="n">coordinate</span><span class="p">)));</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Source status: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">WobblySource</span><span class="o">.</span><span class="n">status_to_description</span><span class="p">[</span><span class="n">status</span><span class="p">]);</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">a_status</span><span class="p">:</span>         
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment status: </span><span class="si">%r</span><span class="s1">-&gt;</span><span class="si">%r</span><span class="s1">: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">status_to_description</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]]))</span>
    <span class="c1">#return status, a_status    </span>

    <span class="c1">#plot overlay to all neighbours</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
      <span class="n">axis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
      <span class="n">ndim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
      <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="p">];</span>
      <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
         <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
           <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">);</span>
         <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
           <span class="n">sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">);</span>
     
      <span class="c1">#slice sources        </span>
      <span class="n">sliced_sources</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_displacements</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">position</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">:</span>
              <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="o">-</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">displacement</span><span class="p">);</span>                        
                <span class="k">break</span><span class="p">;</span>
              <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">:</span>
                <span class="n">position</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">displacement</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">position</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">position</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">wobble_at_coordinate</span><span class="p">(</span><span class="n">coordinate</span><span class="p">);</span> 
                                              
        <span class="n">slicing</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="n">axis</span> <span class="o">+</span> <span class="p">(</span><span class="n">coordinate</span> <span class="o">-</span> <span class="n">source</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">axis</span><span class="p">);</span>                           
        <span class="n">sliced_sources</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strg</span><span class="o">.</span><span class="n">Source</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="n">slc</span><span class="o">.</span><span class="n">Slice</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">as_virtual</span><span class="p">(),</span> <span class="n">slicing</span><span class="o">=</span><span class="n">slicing</span><span class="p">),</span> <span class="n">position</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">tile_position</span><span class="o">=</span><span class="n">source</span><span class="o">.</span><span class="n">tile_position</span><span class="p">));</span>
         
      <span class="n">sliced_layout</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">Layout</span><span class="p">(</span><span class="n">sources</span> <span class="o">=</span> <span class="n">sliced_sources</span><span class="p">,</span> <span class="n">shape</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="p">);</span>
      <span class="n">strg</span><span class="o">.</span><span class="n">plot_layout</span><span class="p">(</span><span class="n">sliced_layout</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      
    <span class="k">return</span> <span class="n">sliced_layout</span>                                     </div></div>

    


<span class="c1">###############################################################################</span>
<span class="c1">###  Alignment</span>
<span class="c1">###############################################################################</span>


<div class="viewcode-block" id="Verbose"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.Verbose">[docs]</a><span class="k">class</span> <span class="nc">Verbose</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="n">flags</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;save&#39;</span>   <span class="p">:</span> <span class="mb">0b010</span><span class="p">,</span>
    <span class="s1">&#39;figure&#39;</span> <span class="p">:</span> <span class="mb">0b100</span>
  <span class="p">}</span>
  
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">save</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">directory</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">Verbose</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>  <span class="o">=</span> <span class="n">verbose</span><span class="o">.</span><span class="n">verbose</span><span class="p">;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">verbose</span><span class="o">.</span><span class="n">save</span><span class="p">;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">verbose</span><span class="o">.</span><span class="n">directory</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span><span class="p">;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="n">save</span><span class="p">;</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span><span class="p">;</span>
    
<div class="viewcode-block" id="Verbose.has_flag"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.Verbose.has_flag">[docs]</a>  <span class="k">def</span> <span class="nf">has_flag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">flag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">;</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
      <span class="k">return</span> <span class="kc">False</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span></div>

<div class="viewcode-block" id="Verbose.copy"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.Verbose.copy">[docs]</a>  <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">new</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)();</span>
    <span class="n">new</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">new</span><span class="p">;</span></div>

  <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">==</span> <span class="n">other</span><span class="p">;</span>
    
<div class="viewcode-block" id="Verbose.full_filename"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.Verbose.full_filename">[docs]</a>  <span class="k">def</span> <span class="nf">full_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">filename</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">io</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span></div>
      
<div class="viewcode-block" id="Verbose.create_directory"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.Verbose.create_directory">[docs]</a>  <span class="k">def</span> <span class="nf">create_directory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">datetime</span>
      <span class="n">directory</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y_%m_</span><span class="si">%d</span><span class="s1">_%H_%M_%S/&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">directory</span><span class="p">);</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">diretory</span> <span class="o">=</span> <span class="n">directory</span><span class="p">;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">io</span><span class="o">.</span><span class="n">is_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">):</span>
      <span class="n">io</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">);</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">directory</span><span class="p">;</span></div></div>


<div class="viewcode-block" id="verbose_has_flag"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.verbose_has_flag">[docs]</a><span class="k">def</span> <span class="nf">verbose_has_flag</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">flag</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">Verbose</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span><span class="o">.</span><span class="n">has_flag</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span></div>

    
<span class="c1">#TODO: use global plane wise coordinates if subsampling !</span>
<div class="viewcode-block" id="align_layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.align_layout">[docs]</a><span class="k">def</span> <span class="nf">align_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">axis_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">axis_mip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">validate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prepare</span> <span class="o">=</span> <span class="s1">&#39;normalization&#39;</span><span class="p">,</span>
                 <span class="n">validate_slice</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prepare_slice</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">find_shifts</span> <span class="o">=</span> <span class="s1">&#39;minimization&#39;</span><span class="p">,</span>
                 <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  
  <span class="n">axis</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
  <span class="n">alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: aligning </span><span class="si">%d</span><span class="s1"> pairs of wobbly sources.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alignments</span><span class="p">)));</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">Verbose</span><span class="p">(</span><span class="n">verbose</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="o">.</span><span class="n">has_flag</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">):</span>
       <span class="n">verbose</span><span class="o">.</span><span class="n">create_directory</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;WobblyAlginment&#39;</span><span class="p">);</span>
  
  <span class="n">_align</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">align_wobbly_axis</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">axis_range</span><span class="o">=</span><span class="n">axis_range</span><span class="p">,</span> <span class="n">axis_mip</span><span class="o">=</span><span class="n">axis_mip</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="n">max_shifts</span><span class="p">,</span>
                                         <span class="n">prepare</span><span class="o">=</span><span class="n">prepare</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="n">validate</span><span class="p">,</span> 
                                         <span class="n">prepare_slice</span><span class="o">=</span><span class="n">prepare_slice</span><span class="p">,</span> <span class="n">validate_slice</span><span class="o">=</span><span class="n">validate_slice</span><span class="p">,</span> 
                                         <span class="n">find_shifts</span><span class="o">=</span><span class="n">find_shifts</span><span class="p">,</span>
                                         <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">processes</span> <span class="o">!=</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">();</span>
  
  <span class="k">if</span> <span class="n">processes</span> <span class="o">==</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">_align</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">];</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">layout</span><span class="o">.</span><span class="n">sources_as_virtual</span><span class="p">();</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
      <span class="n">results</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_align</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">]);</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>                 
  
  <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">,</span> <span class="n">results</span><span class="p">):</span>
    <span class="n">a</span><span class="o">.</span><span class="n">shifts</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">a</span><span class="o">.</span><span class="n">qualities</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>   
    <span class="n">a</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>                
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Alignment: aligning </span><span class="si">%d</span><span class="s1"> pairs of wobbly sources&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alignments</span><span class="p">)));</span></div>


<div class="viewcode-block" id="align_wobbly_axis"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.align_wobbly_axis">[docs]</a><span class="nd">@ptb</span><span class="o">.</span><span class="n">parallel_traceback</span>
<span class="k">def</span> <span class="nf">align_wobbly_axis</span><span class="p">(</span><span class="n">source1</span><span class="p">,</span> <span class="n">source2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis_range</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">axis_mip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">validate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prepare</span> <span class="o">=</span> <span class="s1">&#39;normalization&#39;</span><span class="p">,</span>
                      <span class="n">validate_slice</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">prepare_slice</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">find_shifts</span> <span class="o">=</span> <span class="s1">&#39;minimization&#39;</span><span class="p">,</span>
                      <span class="n">with_errors</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">with_overlaps</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create shifts along the wobble axis, estimate smooth shifts and mark invalid slices, accounts for jumps in minima using multiple minima.&quot;&quot;&quot;</span>                      
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: wobbly alignment </span><span class="si">%r</span><span class="s1">-&gt;</span><span class="si">%r</span><span class="s1"> along axis </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source1</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">source2</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">axis</span><span class="p">));</span>
  
  <span class="c1">#prepare methods dicts</span>
  <span class="n">validate</span><span class="p">,</span> <span class="n">prepare</span><span class="p">,</span> <span class="n">validate_slice</span><span class="p">,</span> <span class="n">prepare_slice</span><span class="p">,</span> <span class="n">find_shifts</span> <span class="o">=</span> \
    <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">validate</span><span class="p">,</span> <span class="n">prepare</span><span class="p">,</span> <span class="n">validate_slice</span><span class="p">,</span> <span class="n">prepare_slice</span><span class="p">,</span> <span class="n">find_shifts</span><span class="p">)];</span>
  
  <span class="k">if</span> <span class="n">axis_mip</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis_mip</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="n">axis_mip</span> <span class="o">=</span> <span class="p">(</span><span class="n">axis_mip</span><span class="p">,</span> <span class="n">axis_mip</span><span class="p">);</span>
    
  <span class="c1">#overlap etc</span>
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">source1</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  <span class="n">p1</span> <span class="o">=</span> <span class="n">source1</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
  <span class="n">p2</span> <span class="o">=</span> <span class="n">source2</span><span class="o">.</span><span class="n">position</span><span class="p">;</span>
  <span class="n">s1</span> <span class="o">=</span> <span class="n">source1</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
  <span class="n">s2</span> <span class="o">=</span> <span class="n">source2</span><span class="o">.</span><span class="n">shape</span><span class="p">;</span>
  
  <span class="n">p1a</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[</span><span class="n">axis</span><span class="p">];</span> 
  <span class="n">p2a</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[</span><span class="n">axis</span><span class="p">];</span> 
  
  <span class="n">start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">p1a</span><span class="p">,</span> <span class="n">p2a</span><span class="p">);</span>
  <span class="n">stop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">p1a</span> <span class="o">+</span> <span class="n">s1</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">p2a</span> <span class="o">+</span> <span class="n">s2</span><span class="p">[</span><span class="n">axis</span><span class="p">]);</span>
  <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">stop</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The sources do not overlap along axis </span><span class="si">%d</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">axis</span><span class="p">);</span>
  <span class="n">n_slices</span> <span class="o">=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>              
  <span class="c1">#print n_slices, start, stop              </span>
  
  <span class="c1">#sampling</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">axis_range</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
    <span class="n">axis_range</span> <span class="o">=</span> <span class="p">(</span><span class="n">axis_range</span><span class="p">,);</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">axis_range</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
    <span class="n">axis_range</span> <span class="o">+=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">3</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">axis_range</span><span class="p">));</span>            
  <span class="n">a_start</span><span class="p">,</span> <span class="n">a_stop</span><span class="p">,</span> <span class="n">a_step</span> <span class="o">=</span> <span class="n">axis_range</span> <span class="k">if</span> <span class="n">axis_range</span> <span class="k">else</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
  <span class="n">a_start</span> <span class="o">=</span> <span class="n">start</span> <span class="k">if</span> <span class="n">a_start</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">a_start</span><span class="p">;</span>
  <span class="n">a_stop</span>  <span class="o">=</span> <span class="n">stop</span>  <span class="k">if</span> <span class="n">a_stop</span>  <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">a_stop</span><span class="p">;</span>
  <span class="n">a_step</span>  <span class="o">=</span> <span class="mi">1</span>     <span class="k">if</span> <span class="n">a_step</span>  <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">a_step</span><span class="p">;</span>
  <span class="n">a_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">a_start</span><span class="p">);</span>
  <span class="n">a_stop</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">stop</span><span class="p">,</span> <span class="n">a_stop</span><span class="p">);</span>               
  <span class="c1">#print a_start, a_stop, a_step, start, stop</span>
  
  <span class="c1">#max shifts formatting  </span>
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">_format_max_shifts</span><span class="p">(</span><span class="n">max_shifts</span><span class="p">,</span> <span class="n">ndim</span><span class="p">);</span>
  <span class="n">max_shifts</span> <span class="o">=</span> <span class="n">max_shifts</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_shifts</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:];</span>                                                   
                    
  <span class="c1">#slices for fft</span>
  <span class="n">sl1</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">p1</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">p1</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:],</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">s1</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">s1</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:]);</span>
  <span class="n">sl2</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">p2</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">p2</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:],</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">s2</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:]);</span>                  
  <span class="n">slice1</span><span class="p">,</span><span class="n">slice2</span><span class="p">,</span> <span class="n">pad1</span><span class="p">,</span><span class="n">pad2</span><span class="p">,</span> <span class="n">slice_no_pad1</span><span class="p">,</span><span class="n">slice_no_pad2</span><span class="p">,</span> <span class="n">shift_min</span><span class="p">,</span><span class="n">shift_max</span><span class="p">,</span> <span class="n">fft_roi</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">_slicing_and_padding_for_fft</span><span class="p">(</span><span class="n">sl1</span><span class="p">,</span> <span class="n">sl2</span><span class="p">,</span> <span class="n">max_shifts</span><span class="p">);</span>
  <span class="c1">#print slice1,slice2, pad1,pad2, slice_no_pad1,slice_no_pad2, shift_min,shift_max, fft_roi</span>
  <span class="c1">#sdim = len(shift_min);</span>
                                                                                                                                                            
  <span class="c1">#full slicings                                                                                                 </span>
  <span class="n">slice1_full</span> <span class="o">=</span> <span class="n">slice1</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">a_start</span> <span class="o">-</span> <span class="n">p1a</span><span class="p">,</span> <span class="n">a_stop</span> <span class="o">-</span> <span class="n">p1a</span><span class="p">),)</span> <span class="o">+</span> <span class="n">slice1</span><span class="p">[</span><span class="n">axis</span><span class="p">:];</span>
  <span class="n">slice2_full</span> <span class="o">=</span> <span class="n">slice2</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">a_start</span> <span class="o">-</span> <span class="n">p2a</span><span class="p">,</span> <span class="n">a_stop</span> <span class="o">-</span> <span class="n">p2a</span><span class="p">),)</span> <span class="o">+</span> <span class="n">slice2</span><span class="p">[</span><span class="n">axis</span><span class="p">:];</span>
  <span class="c1">#print(slice1_full, slice2_full)                     </span>
  <span class="c1">#pad1_full = pad1[:axis] + [(0,0)] + pad1[axis:];</span>
  <span class="c1">#pad2_full = pad2[:axis] + [(0,0)] + pad2[axis:];</span>
                                                                                                                                                           
  <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">source1</span><span class="p">[</span><span class="n">slice1_full</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">);</span>
  <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">source2</span><span class="p">[</span><span class="n">slice2_full</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">);</span>                
  <span class="c1">#print i1.shape, i2.shape       </span>
  
  <span class="c1">#initialize the error and status results</span>
  <span class="n">status</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">INVALID</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_slices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  <span class="n">error_shape</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_slices</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="o">-</span><span class="n">s</span><span class="o">.</span><span class="n">start</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">s</span><span class="o">.</span><span class="n">stop</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">fft_roi</span><span class="p">);</span>                                    
  <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">error_shape</span><span class="p">);</span>                
                   
  <span class="c1">#validate entire stacks </span>
  <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">_validate</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="o">**</span><span class="n">validate</span><span class="p">);</span>             
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: Source </span><span class="si">%r</span><span class="s1"> is not valid!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source1</span><span class="o">.</span><span class="n">identifier</span><span class="p">,));</span> 
    <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
      <span class="n">valid</span> <span class="o">=</span> <span class="n">_validate</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="o">**</span><span class="n">validate</span><span class="p">);</span>
      <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: Source </span><span class="si">%r</span><span class="s1"> is not valid!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source1</span><span class="o">.</span><span class="n">identifier</span><span class="p">,));</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
      <span class="n">status</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">NOSIGNAL</span><span class="p">;</span> 
      <span class="n">results</span> <span class="o">=</span> <span class="n">_shifts_qualities_status</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">correct_shift</span><span class="o">=</span><span class="n">shift_min</span><span class="p">,</span> <span class="o">**</span><span class="n">find_shifts</span><span class="p">);</span>
      <span class="k">if</span> <span class="n">with_errors</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">+=</span> <span class="p">(</span><span class="n">errors</span><span class="p">,);</span>
      <span class="k">if</span> <span class="n">with_overlaps</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">+=</span> <span class="p">((</span><span class="n">i1</span><span class="p">,</span><span class="n">i2</span><span class="p">),);</span>
      <span class="k">return</span> <span class="n">results</span><span class="p">;</span>                            

  <span class="c1">#keep original copy for validation               </span>
  <span class="k">if</span> <span class="n">validate_slice</span><span class="p">:</span>
    <span class="n">i1raw</span> <span class="o">=</span> <span class="n">i1</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
    <span class="n">i2raw</span> <span class="o">=</span> <span class="n">i2</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>

  <span class="c1">#prepare</span>
  <span class="k">if</span> <span class="n">prepare</span><span class="p">:</span>
    <span class="n">i1</span> <span class="o">=</span> <span class="n">_prepare</span><span class="p">(</span><span class="n">i1</span><span class="p">,</span> <span class="o">**</span><span class="n">prepare</span><span class="p">);</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="n">_prepare</span><span class="p">(</span><span class="n">i2</span><span class="p">,</span> <span class="o">**</span><span class="n">prepare</span><span class="p">);</span>
  
  <span class="c1">#weights</span>
  <span class="n">shape1</span> <span class="o">=</span> <span class="n">i1</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">i1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span>
  <span class="n">w1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape1</span><span class="p">),</span> <span class="n">pad1</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">);</span>          
  <span class="n">w1</span><span class="p">[</span><span class="n">slice_no_pad1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">w1fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">w1</span><span class="p">);</span>
  
  <span class="n">w2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape1</span><span class="p">),</span> <span class="n">pad1</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">);</span>             
  <span class="n">w2</span><span class="p">[</span><span class="n">slice_no_pad2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">w2fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">w2</span><span class="p">);</span>
   
  <span class="c1">#norm                    </span>
  <span class="n">nrm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">w1fft</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">w2fft</span><span class="p">));</span>                     
  <span class="n">nrm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">nrm</span><span class="p">[</span><span class="n">fft_roi</span><span class="p">]);</span>
  <span class="n">eps</span> <span class="o">=</span>  <span class="mf">2.2204e-16</span><span class="p">;</span>
  <span class="n">nrm</span><span class="p">[</span><span class="n">nrm</span> <span class="o">&lt;</span> <span class="n">eps</span><span class="p">]</span> <span class="o">=</span> <span class="n">eps</span><span class="p">;</span>             
    
  <span class="c1">#align slices              </span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: Wobbly alignment </span><span class="si">%r</span><span class="s1">-&gt;</span><span class="si">%r</span><span class="s1"> along axis </span><span class="si">%d</span><span class="s1">: slice </span><span class="si">%d</span><span class="s1"> / </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source1</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">source2</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">a_stop</span><span class="o">-</span><span class="n">a_start</span><span class="p">));</span>
    
    <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">a_start</span> <span class="ow">or</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="n">a_stop</span> <span class="ow">or</span> <span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">a_start</span><span class="p">)</span> <span class="o">%</span> <span class="n">a_step</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">UNALIGNED</span><span class="p">;</span>
      <span class="k">continue</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="n">axis_mip</span><span class="p">:</span>
      <span class="n">mip_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a_start</span> <span class="o">-</span> <span class="n">axis_mip</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="n">mip_end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">a</span> <span class="o">-</span> <span class="n">a_start</span> <span class="o">+</span> <span class="n">axis_mip</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="n">slice1_a</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="n">axis</span> <span class="o">+</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">mip_start</span><span class="p">,</span><span class="n">mip_end</span><span class="p">),)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">axis</span><span class="p">)</span>
      <span class="n">slice2_a</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="n">axis</span> <span class="o">+</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="n">mip_start</span><span class="p">,</span><span class="n">mip_end</span><span class="p">),)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">axis</span><span class="p">)</span>
      <span class="n">i1a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">i1</span><span class="p">[</span><span class="n">slice1_a</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">);</span>
      <span class="n">i2a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">i2</span><span class="p">[</span><span class="n">slice2_a</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">);</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">slice1_a</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="n">axis</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a_start</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">axis</span><span class="p">)</span>
      <span class="n">slice2_a</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="n">axis</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a_start</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">axis</span><span class="p">)</span>
   
      <span class="n">i1a</span> <span class="o">=</span> <span class="n">i1</span><span class="p">[</span><span class="n">slice1_a</span><span class="p">];</span>
      <span class="n">i2a</span> <span class="o">=</span> <span class="n">i2</span><span class="p">[</span><span class="n">slice2_a</span><span class="p">];</span>
    
    <span class="k">if</span> <span class="n">validate_slice</span><span class="p">:</span>
      <span class="n">i1rawa</span> <span class="o">=</span> <span class="n">i1raw</span><span class="p">[</span><span class="n">slice1_a</span><span class="p">];</span>
      <span class="n">valid</span> <span class="o">=</span> <span class="n">_validate</span><span class="p">(</span><span class="n">i1rawa</span><span class="p">,</span> <span class="o">**</span><span class="n">validate_slice</span><span class="p">);</span>
      <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: Slice </span><span class="si">%d</span><span class="s1"> with coordainte </span><span class="si">%d</span><span class="s1"> in source </span><span class="si">%r</span><span class="s1"> is not valid!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a_start</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">source1</span><span class="o">.</span><span class="n">identifier</span><span class="p">));</span> 
      <span class="k">if</span> <span class="n">valid</span><span class="p">:</span>
        <span class="n">i2rawa</span> <span class="o">=</span> <span class="n">i2raw</span><span class="p">[</span><span class="n">slice2_a</span><span class="p">];</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">_validate</span><span class="p">(</span><span class="n">i2rawa</span><span class="p">,</span> <span class="o">**</span><span class="n">validate_slice</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: Slice </span><span class="si">%d</span><span class="s1"> with coordainte </span><span class="si">%d</span><span class="s1"> in source </span><span class="si">%r</span><span class="s1"> is not valid!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">a_start</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">source2</span><span class="o">.</span><span class="n">identifier</span><span class="p">));</span> 
      <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
        <span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">NOSIGNAL</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>                        
    
    <span class="k">if</span> <span class="n">prepare_slice</span><span class="p">:</span>
      <span class="n">i1a</span> <span class="o">=</span> <span class="n">_prepare</span><span class="p">(</span><span class="n">i1a</span><span class="p">,</span> <span class="o">**</span><span class="n">prepare_slice</span><span class="p">);</span>
      <span class="n">i2a</span> <span class="o">=</span> <span class="n">_prepare</span><span class="p">(</span><span class="n">i2a</span><span class="p">,</span> <span class="o">**</span><span class="n">prepare_slice</span><span class="p">);</span>
    
    <span class="n">i1a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">i1a</span><span class="p">,</span> <span class="n">pad1</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">);</span>
    <span class="n">i2a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">i2a</span><span class="p">,</span> <span class="n">pad2</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">);</span>                  
    
    <span class="c1"># fft</span>
    <span class="n">i1fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">i1a</span><span class="p">);</span> 
    <span class="n">i2fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">i2a</span><span class="p">);</span>
    <span class="n">s1fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">i1a</span> <span class="o">*</span> <span class="n">i1a</span><span class="p">);</span>  
    <span class="n">s2fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">i2a</span> <span class="o">*</span> <span class="n">i2a</span><span class="p">);</span>
    <span class="n">wssd</span> <span class="o">=</span> <span class="n">w1fft</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">s2fft</span><span class="p">)</span> <span class="o">+</span> <span class="n">s1fft</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">w2fft</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i1fft</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">i2fft</span><span class="p">);</span>
    <span class="n">wssd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">wssd</span><span class="p">);</span>        
    <span class="n">wssd</span> <span class="o">=</span> <span class="n">wssd</span><span class="p">[</span><span class="n">fft_roi</span><span class="p">];</span>
    
    <span class="c1"># normalize</span>
    <span class="n">wssd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">wssd</span><span class="p">);</span>           
    <span class="n">wssd</span> <span class="o">=</span> <span class="n">wssd</span> <span class="o">/</span> <span class="n">nrm</span><span class="p">;</span>
              
    <span class="c1"># save least square errors             </span>
    <span class="n">errors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">wssd</span><span class="p">;</span>
    <span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">MEASURED</span>
    
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Alignment: Wobbly slice alignment </span><span class="si">%r</span><span class="s1">-&gt;</span><span class="si">%r</span><span class="s1"> along axis </span><span class="si">%d</span><span class="s1"> done&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source1</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">source2</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">axis</span><span class="p">));</span>
  
    <span class="k">if</span> <span class="n">verbose_has_flag</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="s1">&#39;save&#39;</span><span class="p">):</span>
      <span class="n">filename</span> <span class="o">=</span> <span class="n">verbose</span><span class="o">.</span><span class="n">full_filename</span><span class="p">(</span><span class="s1">&#39;errors_</span><span class="si">%r</span><span class="s1">_</span><span class="si">%r</span><span class="s1">.npy&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source1</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">source2</span><span class="o">.</span><span class="n">identifier</span><span class="p">));</span>
      <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">errors</span><span class="p">);</span>
      <span class="n">verbose</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1">_</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source1</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">source2</span><span class="o">.</span><span class="n">identifier</span><span class="p">)</span>
                
  <span class="n">results</span> <span class="o">=</span> <span class="n">_shifts_qualities_status</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">add_shift</span><span class="o">=</span><span class="n">shift_min</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">find_shifts</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Alignment: Wobbly alignment </span><span class="si">%r</span><span class="s1">-&gt;</span><span class="si">%r</span><span class="s1"> along axis </span><span class="si">%d</span><span class="s1"> done&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source1</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">source2</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">axis</span><span class="p">));</span>
                              
  <span class="k">if</span> <span class="n">with_errors</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">+=</span> <span class="p">(</span><span class="n">errors</span><span class="p">,);</span>
  <span class="k">if</span> <span class="n">with_overlaps</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">+=</span> <span class="p">((</span><span class="n">i1raw</span><span class="p">,</span><span class="n">i2raw</span><span class="p">),);</span>
  <span class="k">return</span> <span class="n">results</span><span class="p">;</span>  </div>



<div class="viewcode-block" id="prepare_normalization"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.prepare_normalization">[docs]</a><span class="k">def</span> <span class="nf">prepare_normalization</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">clip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
  <span class="c1"># clip images for better alignment performance  </span>
  <span class="k">if</span> <span class="n">clip</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>                 
    <span class="c1">#clip</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clip</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
      <span class="k">if</span> <span class="n">clip</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">array</span><span class="p">[</span><span class="n">array</span> <span class="o">&lt;</span> <span class="n">clip</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clip</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">if</span> <span class="n">clip</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">array</span><span class="p">[</span><span class="n">array</span> <span class="o">&gt;</span> <span class="n">clip</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">clip</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">array</span><span class="p">[</span><span class="n">array</span> <span class="o">&gt;</span> <span class="n">clip</span><span class="p">]</span> <span class="o">=</span> <span class="n">clip</span><span class="p">;</span>
  
  <span class="c1">#normalize the full image</span>
  <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
    <span class="n">array</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
    <span class="n">array</span> <span class="o">*=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">array</span><span class="o">*</span><span class="n">array</span><span class="p">));</span>

  <span class="k">return</span> <span class="n">array</span><span class="p">;</span></div>

<span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;normalization&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;normalization&#39;</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">prepare_normalization</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Preparation method </span><span class="si">%r</span><span class="s1"> not valid!&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">);</span>
                

<div class="viewcode-block" id="validate_foreground"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.validate_foreground">[docs]</a><span class="k">def</span> <span class="nf">validate_foreground</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">valid_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">800</span><span class="p">,</span><span class="kc">None</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fraction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
  <span class="c1">#check if overlaps are background</span>
  <span class="k">if</span> <span class="n">valid_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">;</span>
  
  <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">valid_range</span><span class="p">;</span>
  <span class="k">if</span> <span class="n">low</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">high</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">foreground</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">low</span> <span class="o">&lt;</span> <span class="n">array</span><span class="p">,</span> <span class="n">array</span> <span class="o">&lt;</span> <span class="n">high</span><span class="p">));</span>
  <span class="k">elif</span> <span class="n">low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">foreground</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">low</span> <span class="o">&lt;=</span> <span class="n">array</span><span class="p">);</span>       
  <span class="k">else</span><span class="p">:</span>
    <span class="n">foreground</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">array</span> <span class="o">&lt;=</span> <span class="n">high</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">fraction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">fraction</span> <span class="o">*</span> <span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">;</span>
    
  <span class="k">if</span> <span class="n">size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">foreground</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: All </span><span class="si">%d</span><span class="s1"> pixels are background in range </span><span class="si">%r</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">valid_range</span><span class="p">));</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">foreground</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Alignment: Not enough foreground pixels </span><span class="si">%d</span><span class="s1"> &lt; </span><span class="si">%d</span><span class="s1"> in range </span><span class="si">%r</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">foreground</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">valid_range</span><span class="p">));</span>
    
  <span class="k">return</span> <span class="n">valid</span><span class="p">;</span></div>


<span class="k">def</span> <span class="nf">_validate</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;foreground&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;foreground&#39;</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">validate_foreground</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Validation method </span><span class="si">%r</span><span class="s1"> not valid!&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">);</span> 



<span class="kn">import</span> <span class="nn">skimage.feature</span> <span class="k">as</span> <span class="nn">skif</span>

<div class="viewcode-block" id="detect_local_minima"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.detect_local_minima">[docs]</a><span class="k">def</span> <span class="nf">detect_local_minima</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">distance</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
  <span class="n">minima</span> <span class="o">=</span> <span class="n">skif</span><span class="o">.</span><span class="n">peak_local_max</span><span class="p">(</span><span class="o">-</span><span class="n">error</span><span class="p">,</span> <span class="n">min_distance</span><span class="o">=</span><span class="n">distance</span><span class="p">,</span> <span class="n">exclude_border</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
                              
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">minima</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>                              
    <span class="n">shifts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">minima</span><span class="p">];</span>
    <span class="n">qualities</span> <span class="o">=</span> <span class="p">[</span><span class="n">error</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">];</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,)</span> <span class="o">*</span> <span class="n">error</span><span class="o">.</span><span class="n">ndim</span><span class="p">];</span>
    <span class="n">qualities</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">];</span>
  
  <span class="k">return</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">qualities</span>                   </div>


<span class="k">def</span> <span class="nf">_detect_minima</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;local_minima&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;local_minima&#39;</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">detect_local_minima</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Method </span><span class="si">%r</span><span class="s1"> not valid for minima detection!&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">);</span>
                


<div class="viewcode-block" id="shifts_from_minimization"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.shifts_from_minimization">[docs]</a><span class="k">def</span> <span class="nf">shifts_from_minimization</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
  <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
  <span class="n">qualities</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>    
  <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">errors</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  
  <span class="c1"># find minimal shifts</span>
  <span class="k">for</span> <span class="n">e</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span> 
    <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">MEASURED</span><span class="p">:</span>
      <span class="n">shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
      <span class="n">shift</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">shape</span><span class="p">));</span> 

      <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift</span><span class="p">;</span>                                                
      <span class="n">qualities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">shift</span><span class="p">]);</span>
      <span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">ALIGNED</span><span class="p">;</span>           
            
  <span class="k">return</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">qualities</span><span class="p">,</span> <span class="n">status</span>        </div>
 


<div class="viewcode-block" id="shifts_from_tracing"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.shifts_from_tracing">[docs]</a><span class="k">def</span> <span class="nf">shifts_from_tracing</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_trajectory_cost</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minima</span><span class="o">=</span><span class="s1">&#39;local_minima&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="n">verbose</span> <span class="o">=</span> <span class="n">Verbose</span><span class="p">(</span><span class="n">verbose</span><span class="p">);</span>  
  
  <span class="c1">#defaults</span>
  <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
  <span class="n">qualities</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>    
  <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">errors</span><span class="o">.</span><span class="n">ndim</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  
  <span class="c1">#measured entries</span>
  <span class="n">measured</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">MEASURED</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">measured</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">qualities</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
                           
  <span class="c1">#minima detection</span>
  <span class="n">mins</span> <span class="o">=</span> <span class="p">[</span><span class="n">_detect_minima</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">minima</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">[</span><span class="n">measured</span><span class="p">]];</span>             
  
  <span class="c1">#invalid minima</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">measured</span><span class="p">,</span> <span class="n">mins</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
      <span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">NOMINIMA</span>     
      <span class="c1">#print(&#39;no min&#39;)           </span>
  <span class="n">mins</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mins</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])];</span>
          
  <span class="c1">#valid regions</span>
  <span class="n">measured</span> <span class="o">=</span> <span class="n">status</span> <span class="o">==</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">MEASURED</span>
  <span class="n">valids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">measured</span><span class="p">,</span> <span class="n">status</span> <span class="o">==</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">UNALIGNED</span><span class="p">);</span>
  <span class="n">valids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  <span class="n">valids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">valids</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">));</span>                     
  <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">valids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">ends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">valids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>   
  <span class="c1">#print starts, ends</span>
  
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">qualities</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

  <span class="k">if</span> <span class="n">new_trajectory_cost</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
     <span class="n">new_trajectory_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mi">2</span><span class="p">)));</span>

  <span class="n">n_measured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">):</span>
    <span class="c1">#account for subsampling</span>
    <span class="n">measured_se</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">measured</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">])[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">n_measured_se</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">measured_se</span><span class="p">);</span>                    
    <span class="k">if</span> <span class="n">n_measured_se</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">continue</span><span class="p">;</span>
                 
    <span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">mins</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_measured</span><span class="p">,</span> <span class="n">n_measured</span> <span class="o">+</span> <span class="n">n_measured_se</span><span class="p">)];</span>
    <span class="n">n_measured</span> <span class="o">+=</span> <span class="n">n_measured_se</span><span class="p">;</span>
    
    <span class="n">trajectories</span> <span class="o">=</span> <span class="n">trk</span><span class="o">.</span><span class="n">track_positions</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">new_trajectory_cost</span><span class="o">=</span><span class="n">new_trajectory_cost</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="o">.</span><span class="n">has_flag</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">):</span>
      <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>   <span class="c1">#analysis:ignore</span>
      <span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span> <span class="c1">#analysis:ignore</span>
      <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
      <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
      <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span> 
      <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">positions</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">],</span> <span class="p">[</span><span class="n">positions</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">],</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">])</span>    
      <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Tracked trajectories&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="o">.</span><span class="n">has_flag</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">):</span>
      <span class="n">filename</span> <span class="o">=</span> <span class="n">verbose</span><span class="o">.</span><span class="n">full_filename</span><span class="p">(</span><span class="s1">&#39;trajectories_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.npy&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">verbose</span><span class="o">.</span><span class="n">save</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
      <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">trajectories</span><span class="p">);</span>
      <span class="n">filename</span> <span class="o">=</span> <span class="n">verbose</span><span class="o">.</span><span class="n">full_filename</span><span class="p">(</span><span class="s1">&#39;positions_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.npy&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">verbose</span><span class="o">.</span><span class="n">save</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
      <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">positions</span><span class="p">);</span>
    
    <span class="c1">#successivley add longer trajectories </span>
    <span class="c1">#TODO: could search local error landscape for best error, etc</span>
    <span class="n">n_opt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">t_opt</span> <span class="o">=</span> <span class="p">[];</span> 
    <span class="k">while</span> <span class="n">n_opt</span> <span class="o">&lt;</span> <span class="n">n_measured_se</span><span class="p">:</span>
      <span class="c1">#find longest</span>
      <span class="n">lens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">]);</span>             
      <span class="n">iopt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">lens</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">lens</span><span class="p">))[</span><span class="mi">0</span><span class="p">];</span>                
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iopt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">errors</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="nb">tuple</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]])]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iopt</span><span class="p">];</span>
        <span class="n">iopt</span> <span class="o">=</span> <span class="n">iopt</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">q</span><span class="p">)];</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">iopt</span> <span class="o">=</span> <span class="n">iopt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">t_opt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trajectories</span><span class="p">[</span><span class="n">iopt</span><span class="p">]);</span>
      <span class="n">n_opt</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_opt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]);</span>
    
      <span class="c1">#remove non relevant trajcetories</span>
      <span class="n">ts</span> <span class="o">=</span> <span class="n">t_opt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">te</span> <span class="o">=</span> <span class="n">t_opt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
      <span class="n">trajectories</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trajectories</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ts</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">ts</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">te</span> <span class="ow">and</span> <span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">te</span><span class="p">)]</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trajectories</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="o">.</span><span class="n">has_flag</span><span class="p">(</span><span class="s1">&#39;figure&#39;</span><span class="p">):</span>
      <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">201</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
      <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span> 
      <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_opt</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">positions</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">],</span> <span class="p">[</span><span class="n">positions</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">],</span> <span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">])</span>    
      <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Optimal trajectory&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="o">.</span><span class="n">has_flag</span><span class="p">(</span><span class="s1">&#39;save&#39;</span><span class="p">):</span>
      <span class="c1">#print(verbose.save, (s,e));</span>
      <span class="n">filename</span> <span class="o">=</span> <span class="n">verbose</span><span class="o">.</span><span class="n">full_filename</span><span class="p">(</span><span class="s1">&#39;trajectory_opt_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">_</span><span class="si">%d</span><span class="s1">.npy&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">verbose</span><span class="o">.</span><span class="n">save</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">));</span>
      <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">t_opt</span><span class="p">);</span>
    
    <span class="c1">#update results</span>
    <span class="n">measured_se</span> <span class="o">+=</span> <span class="n">s</span><span class="p">;</span>
    <span class="n">status</span><span class="p">[</span><span class="n">measured_se</span><span class="p">]</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">UNTRACED</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_opt</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">l</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">measured_se</span><span class="p">[</span><span class="n">l</span><span class="p">];</span>
        <span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">m</span><span class="p">];</span>
        <span class="n">qualities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">errors</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="nb">tuple</span><span class="p">(</span><span class="n">shifts</span><span class="p">[</span><span class="n">i</span><span class="p">])];</span>
        <span class="n">status</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">ALIGNED</span><span class="p">;</span>              

  <span class="k">return</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">qualities</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span></div>


<span class="k">def</span> <span class="nf">_shifts_qualities_status</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;minimization&#39;</span><span class="p">,</span> <span class="n">add_shift</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper to calculate shifts, qualities and status from alignment errors.&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;minimization&#39;</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;minimization&#39;</span><span class="p">:</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">shifts_from_minimization</span>
  <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;tracing&#39;</span><span class="p">:</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">shifts_from_tracing</span><span class="p">;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Method </span><span class="si">%r</span><span class="s1"> not a vaild for shift detection!&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">);</span>
  
  <span class="c1">#strg.dv.plot(errors)</span>
  <span class="n">shifts</span><span class="p">,</span> <span class="n">qualities</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span>
  <span class="c1">#print shifts, qualities, status</span>
  
  <span class="k">if</span> <span class="n">add_shift</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">m</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">add_shift</span><span class="p">))</span> <span class="k">for</span> <span class="n">shift</span> <span class="ow">in</span> <span class="n">shifts</span><span class="p">];</span>
  
  <span class="k">return</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">qualities</span><span class="p">,</span> <span class="n">status</span>



<div class="viewcode-block" id="inspect_align_layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.inspect_align_layout">[docs]</a><span class="k">def</span> <span class="nf">inspect_align_layout</span><span class="p">(</span><span class="n">alignment</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Parse the infomration saved during a align_layout.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  errors : array </span>
<span class="sd">    The error landscape for each slice.</span>
<span class="sd">  minima : array</span>
<span class="sd">   Coordinates of the detected minima  </span>
<span class="sd">  trajectories : list</span>
<span class="sd">    List of coordaintes of the detected trajectories.</span>
<span class="sd">  trajectories_optimal : list</span>
<span class="sd">    List of the optimal trajectories.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">verbose</span> <span class="o">=</span> <span class="n">Verbose</span><span class="p">(</span><span class="n">verbose</span><span class="p">);</span>  
  <span class="n">verbose</span><span class="o">.</span><span class="n">save</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1">_</span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">alignment</span><span class="o">.</span><span class="n">pre</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="n">alignment</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">identifier</span><span class="p">);</span>
  
  <span class="c1">#error</span>
  <span class="n">error_file</span> <span class="o">=</span> <span class="n">verbose</span><span class="o">.</span><span class="n">full_filename</span><span class="p">(</span><span class="s1">&#39;errors_</span><span class="si">%s</span><span class="s1">.npy&#39;</span> <span class="o">%</span> <span class="n">verbose</span><span class="o">.</span><span class="n">save</span><span class="p">);</span>
  <span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">error_file</span><span class="p">)</span>
  <span class="c1">#p3d.plot(error_file)</span>
  
  <span class="c1">#minima</span>
  <span class="n">positions_expression</span> <span class="o">=</span> <span class="n">verbose</span><span class="o">.</span><span class="n">full_filename</span><span class="p">(</span><span class="n">te</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="s1">&#39;positions_</span><span class="si">%s</span><span class="s1">_&lt;s&gt;_&lt;e&gt;.npy&#39;</span> <span class="o">%</span> <span class="n">verbose</span><span class="o">.</span><span class="n">save</span><span class="p">))</span>
  <span class="n">positions_files</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">file_list</span><span class="p">(</span><span class="n">positions_expression</span><span class="p">)</span>  

  <span class="n">minima</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">positions_files</span><span class="p">:</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">positions_expression</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">];</span> <span class="n">e</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">];</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">z</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span>  <span class="n">mm</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span><span class="p">,</span><span class="n">mm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">),</span><span class="n">positions</span><span class="p">)]);</span>
    <span class="n">minima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pp</span><span class="p">);</span>
  <span class="n">minima</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">minima</span><span class="p">)</span>
  
  <span class="c1">#potential trajectories</span>
  <span class="n">trajectory_expression</span> <span class="o">=</span> <span class="n">verbose</span><span class="o">.</span><span class="n">full_filename</span><span class="p">(</span><span class="n">te</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="s1">&#39;trajectories_</span><span class="si">%s</span><span class="s1">_&lt;s&gt;_&lt;e&gt;.npy&#39;</span> <span class="o">%</span> <span class="n">verbose</span><span class="o">.</span><span class="n">save</span><span class="p">))</span>
  <span class="n">trajectory_files</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">file_list</span><span class="p">(</span><span class="n">trajectory_expression</span><span class="p">)</span>  
  <span class="n">paths</span> <span class="o">=</span> <span class="p">[];</span>  
  <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trajectory_files</span><span class="p">:</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">trajectory_expression</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">];</span> <span class="n">e</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">];</span>
    <span class="n">trajectories</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">positions_expression</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>    
    <span class="n">z_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">trajectory</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">:</span>
      <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span><span class="p">(</span><span class="n">z_positions</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">trajectory</span><span class="p">]));</span>
  
  <span class="c1">#p3d.list_line_plot_3d(paths[1])</span>
   
  <span class="c1">#optimal trajectory</span>
  <span class="n">trajectory_expression</span> <span class="o">=</span> <span class="n">verbose</span><span class="o">.</span><span class="n">full_filename</span><span class="p">(</span><span class="n">te</span><span class="o">.</span><span class="n">Expression</span><span class="p">(</span><span class="s1">&#39;trajectory_opt_</span><span class="si">%s</span><span class="s1">_&lt;s&gt;_&lt;e&gt;.npy&#39;</span> <span class="o">%</span> <span class="n">verbose</span><span class="o">.</span><span class="n">save</span><span class="p">))</span>
  <span class="n">trajectory_files</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">file_list</span><span class="p">(</span><span class="n">trajectory_expression</span><span class="p">)</span>  
  <span class="n">opt_paths</span> <span class="o">=</span> <span class="p">[];</span>  
  <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trajectory_files</span><span class="p">:</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">trajectory_expression</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">];</span> <span class="n">e</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="s1">&#39;e&#39;</span><span class="p">];</span>
    <span class="n">trajectories</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">positions_expression</span><span class="o">.</span><span class="n">string</span><span class="p">(</span><span class="n">values</span><span class="p">))</span>
    <span class="n">z_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">trajectory</span> <span class="ow">in</span> <span class="n">trajectories</span><span class="p">:</span>
      <span class="n">opt_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span><span class="p">(</span><span class="n">z_positions</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]],))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">trajectory</span><span class="p">]));</span>
  
  <span class="k">return</span> <span class="n">error</span><span class="p">,</span> <span class="n">minima</span><span class="p">,</span> <span class="n">paths</span><span class="p">,</span> <span class="n">opt_paths</span></div>





<span class="c1">###############################################################################</span>
<span class="c1">### Placement</span>
<span class="c1">###############################################################################</span>


<div class="viewcode-block" id="place_layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.place_layout">[docs]</a><span class="k">def</span> <span class="nf">place_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;optimization&#39;</span><span class="p">,</span> 
                 <span class="n">smooth</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">smooth_optimized</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fix_isolated</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>                       
                 <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Place a layout with the WobblyAlignments.&quot;&quot;&quot;</span>
  
  <span class="c1">#prepare methods dicts</span>
  <span class="n">smooth</span><span class="p">,</span> <span class="n">smooth_optimized</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">(</span><span class="n">smooth</span><span class="p">,</span> <span class="n">smooth_optimized</span><span class="p">)];</span>
  
  <span class="c1">#place tiles in each slice first</span>
  <span class="n">sources</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">sources</span><span class="p">;</span>
  <span class="n">alignments</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">alignments</span><span class="p">;</span>
  <span class="n">axis</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
  
  <span class="c1">#TODO: fix all the upper lower etc defs to not only work with lower_to_origin layout ?</span>
  <span class="n">n_slices</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">extent</span><span class="p">[</span><span class="n">axis</span><span class="p">];</span>                   
  <span class="n">n_sources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sources</span><span class="p">);</span>
  <span class="k">if</span> <span class="n">n_sources</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n_slices</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Placement: placing positions in </span><span class="si">%d</span><span class="s1"> slices!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_slices</span><span class="p">));</span>
  
  <span class="c1">#compose the slice info</span>
  <span class="n">source_to_index</span> <span class="o">=</span> <span class="p">{</span><span class="n">s</span> <span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sources</span><span class="p">)};</span>
  <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">position</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">]);</span>
  <span class="n">alignment_pairs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">source_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">],</span> <span class="n">source_to_index</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">])</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignments</span><span class="p">]);</span>
  <span class="n">n_alignments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alignment_pairs</span><span class="p">);</span>
  <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            
  <span class="c1">#displacmeents and qualities</span>
  <span class="n">displacements</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_slices</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">,</span> <span class="n">ndim</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">);</span>
  <span class="n">qualities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_slices</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">);</span>  
  <span class="n">status</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_slices</span><span class="p">,</span> <span class="n">n_alignments</span><span class="p">),</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">INVALID</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>                               
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alignments</span><span class="p">):</span>
    <span class="c1"># fill in undersampled gaps</span>
    <span class="n">a</span><span class="o">.</span><span class="n">fix_unaligned</span><span class="p">();</span>
    
    <span class="c1"># smooth</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">lower_coordinate</span><span class="p">;</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">upper_coordinate</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>               
      <span class="n">displacements</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">smooth_displacements</span><span class="p">(</span><span class="n">min_quality</span><span class="o">=</span><span class="n">min_quality</span><span class="p">,</span> <span class="o">**</span><span class="n">smooth</span><span class="p">);</span>  
    <span class="k">else</span><span class="p">:</span>
      <span class="n">displacements</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">displacements</span><span class="p">;</span>
    <span class="n">qualities</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">qualities</span><span class="p">;</span>                  
    <span class="n">status</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="n">u</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">status</span><span class="p">;</span>
  
  <span class="c1">#np.save(&#39;displacements.npy&#39;, displacements);</span>
  <span class="c1">#np.save(&#39;qualities.npy&#39;, qualities);</span>
  <span class="c1">#np.save(&#39;status.npy&#39;, status);</span>
  
  <span class="c1">#place each slice</span>
  <span class="n">_place</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_place_slice</span><span class="p">,</span> <span class="n">positions</span><span class="o">=</span><span class="n">positions</span><span class="p">,</span> <span class="n">alignment_pairs</span><span class="o">=</span><span class="n">alignment_pairs</span><span class="p">,</span> <span class="n">min_quality</span><span class="o">=</span><span class="n">min_quality</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">processes</span> <span class="o">!=</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">();</span>
  
  <span class="k">if</span> <span class="n">processes</span> <span class="o">==</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">_place</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">displacements</span><span class="p">,</span> <span class="n">qualities</span><span class="p">,</span> <span class="n">status</span><span class="p">)];</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
      <span class="n">results</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_place</span><span class="p">,</span> <span class="n">displacements</span><span class="p">,</span> <span class="n">qualities</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>                 
  
  <span class="n">positions_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]);</span>             
  <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">];</span>   
  
  <span class="c1">#np.save(&#39;positions_new.npy&#39;, positions_new.swapaxes(0,1));</span>
  <span class="c1">#TODO: transform status from alignments to source staus ?  </span>

               
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Placement: placing positions in </span><span class="si">%d</span><span class="s1"> slices done!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">n_slices</span><span class="p">));</span>                                 
  
  <span class="c1">#mark and remove isolated tiles</span>
  <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">components_slice</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components_slice</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">layout</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_isolated</span><span class="p">(</span><span class="n">coordinate</span> <span class="o">=</span> <span class="n">s</span><span class="p">);</span> 
  <span class="n">components</span> <span class="o">=</span> <span class="p">[[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components_slice</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">components_slice</span> <span class="ow">in</span> <span class="n">components</span><span class="p">];</span>              
  
  <span class="c1">#optimize positions</span>
  <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;optimization&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Placement: optimizing wobbly positions!&#39;</span><span class="p">)</span>
    <span class="n">positions_optimized</span> <span class="o">=</span> <span class="n">_optimize_slice_positions</span><span class="p">(</span><span class="n">positions_new</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="n">processes</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">);</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Placement: combining wobbly positions!&#39;</span><span class="p">)</span>      
    <span class="n">positions_optimized</span> <span class="o">=</span> <span class="n">_straighten_slice_positions</span><span class="p">(</span><span class="n">positions_new</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">layout</span><span class="o">.</span><span class="n">tile_positions</span><span class="p">);</span>
  <span class="n">positions_optimized</span> <span class="o">=</span> <span class="n">positions_optimized</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
  
  <span class="c1">#np.save(&#39;positions_optimized_1.npy&#39;, positions_optimized);</span>

  <span class="c1">#TODO: after fixing isolated !!!! or including status !!!</span>
  <span class="c1">#smoooth optimized positions</span>
  <span class="k">if</span> <span class="n">smooth_optimized</span><span class="p">:</span>
     <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">positions_optimized</span><span class="p">:</span>
       <span class="n">valids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">);</span> 
       <span class="c1">#include status validation here !                       </span>
       <span class="n">p</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">smooth_positions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">valids</span><span class="o">=</span><span class="n">valids</span><span class="p">,</span> <span class="o">**</span><span class="n">smooth_optimized</span><span class="p">);</span>
                                                    
  <span class="c1">#zero origin</span>
  <span class="k">if</span> <span class="n">lower_to_origin</span><span class="p">:</span>
    <span class="n">positions_optimized_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">positions_optimized</span><span class="p">);</span>
    <span class="n">min_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">positions_optimized_valid</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">));</span>
    <span class="n">positions_optimized</span> <span class="o">-=</span> <span class="n">min_pos</span><span class="p">;</span>
   
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Placement: placing wobbly layout done!&#39;</span><span class="p">);</span>
  
  <span class="c1">#np.save(&#39;positions_optimized_2.npy&#39;, positions_optimized);</span>
  
  <span class="n">layout</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">positions_optimized</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">fix_isolated</span><span class="p">:</span>                      
    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="n">layout</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
      <span class="n">source</span><span class="o">.</span><span class="n">fix_isolated</span><span class="p">();</span></div>
  
  <span class="c1">#return positions_optimized;</span>

<span class="nd">@ptb</span><span class="o">.</span><span class="n">parallel_traceback</span>
<span class="k">def</span> <span class="nf">_place_slice</span><span class="p">(</span><span class="n">displacements</span><span class="p">,</span> <span class="n">qualities</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">positions</span><span class="p">,</span> <span class="n">alignment_pairs</span><span class="p">,</span> <span class="n">min_quality</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
  
  <span class="n">positions</span> <span class="o">=</span> <span class="n">positions</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
                           
  <span class="c1">#filter alignments by quality</span>
  <span class="n">valid</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&gt;=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">VALID</span><span class="p">;</span>
  <span class="k">if</span> <span class="n">min_quality</span><span class="p">:</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">qualities</span> <span class="o">&gt;</span> <span class="n">min_quality</span><span class="p">);</span>

  <span class="n">alignment_pairs</span> <span class="o">=</span> <span class="n">alignment_pairs</span><span class="p">[</span><span class="n">valid</span><span class="p">];</span>
  <span class="n">displacements</span> <span class="o">=</span> <span class="n">displacements</span><span class="p">[</span><span class="n">valid</span><span class="p">];</span>
  <span class="n">qualities</span> <span class="o">=</span> <span class="n">qualities</span><span class="p">[</span><span class="n">valid</span><span class="p">];</span>
                         
  <span class="c1">#connected components</span>
  <span class="n">component_ids</span><span class="p">,</span> <span class="n">component_pairs</span><span class="p">,</span> <span class="n">component_displacements</span> <span class="o">=</span> <span class="n">_connected_components</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">alignment_pairs</span><span class="p">,</span> <span class="n">displacements</span><span class="p">);</span>
  
  <span class="k">for</span> <span class="n">pairs</span><span class="p">,</span><span class="n">displ</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">component_pairs</span><span class="p">,</span> <span class="n">component_displacements</span><span class="p">):</span>
    <span class="n">_place_slice_component</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">pairs</span><span class="p">,</span> <span class="n">displ</span><span class="p">);</span>                                    
                                   
  <span class="k">return</span> <span class="n">positions</span><span class="p">,</span> <span class="n">component_ids</span><span class="p">;</span>


<span class="k">def</span> <span class="nf">_connected_components</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">alignment_pairs</span><span class="p">,</span> <span class="n">displacements</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns the connected components of the alignments.&quot;&quot;&quot;</span>
  <span class="n">n_sources</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">);</span>
    
  <span class="c1">#determine connected compoenents</span>
  <span class="n">g</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">directed</span> <span class="o">=</span> <span class="kc">False</span><span class="p">);</span>    
  <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="n">n_sources</span><span class="p">);</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignment_pairs</span><span class="p">:</span>
    <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">connected_components</span><span class="p">,</span> <span class="n">hist</span> <span class="o">=</span> <span class="n">gtt</span><span class="o">.</span><span class="n">label_components</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
  <span class="n">connected_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">connected_components</span><span class="o">.</span><span class="n">a</span><span class="p">);</span>                            
  <span class="n">n_components</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">);</span>
  <span class="c1">#print connected_components, hist, len(hist), np.max(hist)   </span>
  
  <span class="c1"># create components</span>
  <span class="n">component_pairs</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="n">component_displacements</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="n">component_ids</span> <span class="o">=</span> <span class="p">[];</span>                            
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_components</span><span class="p">):</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">connected_components</span> <span class="o">==</span> <span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">pairs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="n">displ</span> <span class="o">=</span> <span class="p">[];</span>           
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alignment_pairs</span><span class="p">,</span> <span class="n">displacements</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
        <span class="n">displ</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>           
     
    <span class="n">component_pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pairs</span><span class="p">);</span>
    <span class="n">component_displacements</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">displ</span><span class="p">);</span> 
    <span class="n">component_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">);</span>                             
                         
  <span class="k">return</span> <span class="n">component_ids</span><span class="p">,</span> <span class="n">component_pairs</span><span class="p">,</span> <span class="n">component_displacements</span><span class="p">;</span>
  
  
<span class="k">def</span> <span class="nf">_place_slice_component</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">alignment_pairs</span><span class="p">,</span> <span class="n">displacements</span><span class="p">,</span> <span class="n">fixed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Optimize positions for a connected component.&quot;&quot;&quot;</span>
  <span class="n">nalignments</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alignment_pairs</span><span class="p">);</span>
  <span class="k">if</span> <span class="n">nalignments</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">positions</span><span class="p">;</span>
  
  <span class="c1"># construct the mappings between node ids and index 1:nimages</span>
  <span class="n">pre_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">alignment_pairs</span><span class="p">])</span>
  <span class="n">post_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">alignment_pairs</span><span class="p">]);</span>
  <span class="n">node_to_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">pre_indices</span><span class="p">,</span> <span class="n">post_indices</span><span class="p">]));</span>
  <span class="n">index_to_node</span> <span class="o">=</span> <span class="p">{</span> <span class="n">i</span> <span class="p">:</span> <span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node_to_index</span><span class="p">)}</span>    
  <span class="n">nnodes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">node_to_index</span><span class="p">);</span>
    
  <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="n">n</span> <span class="o">=</span> <span class="n">ndim</span> <span class="o">*</span> <span class="n">nalignments</span><span class="p">;</span>
  <span class="n">m</span> <span class="o">=</span> <span class="n">ndim</span> <span class="o">*</span> <span class="p">(</span><span class="n">nnodes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="c1"># first image is assumed to be fixed at zero</span>

  <span class="c1"># derivative of the error gives constraints s - M x == 0</span>
  <span class="c1"># s are the displacements, x the centers of the images, M is derived from the error terms</span>

  <span class="c1"># s</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
  <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">sh</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">alignment_pairs</span><span class="p">,</span> <span class="n">displacements</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
      <span class="n">s</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">sh</span><span class="p">[</span><span class="n">d</span><span class="p">];</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  
  <span class="c1"># M</span>
  <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">));</span>
  <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">alignment_pairs</span><span class="p">:</span>
    <span class="n">pre_node</span> <span class="o">=</span> <span class="n">index_to_node</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
    <span class="n">post_node</span> <span class="o">=</span> <span class="n">index_to_node</span><span class="p">[</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>                      
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">pre_node</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">pre_node</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ndim</span> <span class="o">+</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="n">post_node</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
         <span class="n">M</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="n">post_node</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ndim</span> <span class="o">+</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">k</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  
  <span class="c1">#print s</span>
  <span class="c1">#print M</span>
  <span class="c1">#print np.linalg.pinv(M)</span>
  
  <span class="c1"># find the centers of the images via pseudo inverse</span>
  <span class="n">positions_optimized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">M</span><span class="p">),</span> <span class="n">s</span><span class="p">);</span>  
  <span class="n">positions_optimized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">),</span> <span class="n">positions_optimized</span><span class="p">]);</span>
  <span class="n">positions_optimized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">positions_optimized</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">));</span>
  <span class="n">positions_optimized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">positions_optimized</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>
  
  <span class="c1">#correct for origin and fixed source</span>
  <span class="k">if</span> <span class="n">fixed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">fixed_id</span> <span class="o">=</span> <span class="n">fixed</span><span class="p">;</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">fixed_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">alignment_pairs</span><span class="p">);</span>
  <span class="n">fixed_position</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">fixed_id</span><span class="p">];</span>
  <span class="n">positions_optimized</span> <span class="o">=</span> <span class="n">positions_optimized</span> <span class="o">-</span> <span class="n">positions_optimized</span><span class="p">[</span><span class="n">index_to_node</span><span class="p">[</span><span class="n">fixed_id</span><span class="p">]]</span> <span class="o">+</span> <span class="n">fixed_position</span><span class="p">;</span>
  
  <span class="c1">#update positions</span>
  <span class="n">positions</span><span class="p">[</span><span class="n">node_to_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">positions_optimized</span><span class="p">;</span>



<span class="k">def</span> <span class="nf">_cluster_components</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Find the connected components of the cluster components&quot;&quot;&quot;</span>
  <span class="n">c_lens</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">];</span>
  <span class="n">c_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">c_lens</span><span class="p">);</span>
  <span class="n">c_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">c_ids</span><span class="p">]);</span>
  <span class="n">n_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c_lens</span><span class="p">);</span>
  
  <span class="k">def</span> <span class="nf">is_to_c</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">c_ids</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span>
    
  <span class="k">def</span> <span class="nf">c_to_si</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">c_ids</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">c</span> <span class="o">-</span> <span class="n">c_ids</span><span class="p">[</span><span class="n">s</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">,</span><span class="n">i</span>
  
  <span class="n">g</span> <span class="o">=</span> <span class="n">gt</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">directed</span> <span class="o">=</span> <span class="kc">False</span><span class="p">);</span>    
  <span class="n">g</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="n">n_components</span><span class="p">);</span>
  
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)):</span>  
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">ci</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
      <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">cj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="n">s</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">ci</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cj</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">is_to_c</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">),</span><span class="n">is_to_c</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">j</span><span class="p">));</span>
            <span class="k">break</span><span class="p">;</span>
  
  <span class="n">connected_components</span><span class="p">,</span> <span class="n">hist</span> <span class="o">=</span> <span class="n">gtt</span><span class="o">.</span><span class="n">label_components</span><span class="p">(</span><span class="n">g</span><span class="p">);</span>
  <span class="n">connected_components</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">connected_components</span><span class="o">.</span><span class="n">a</span><span class="p">);</span>
  <span class="n">n_components</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist</span><span class="p">);</span>
  <span class="n">components_full</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">connected_components</span><span class="o">==</span><span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_components</span><span class="p">)];</span>
  
  <span class="c1">#remove isolated nodes</span>
  <span class="n">components_full</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components_full</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span> 
                     
  <span class="k">return</span> <span class="n">components_full</span><span class="p">,</span> <span class="n">is_to_c</span><span class="p">,</span> <span class="n">c_to_si</span>


<span class="k">def</span> <span class="nf">_optimize_slice_positions</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Helper to optimize the positions of the slices on top of each other&quot;&quot;&quot;</span>
  
  <span class="c1">#Setting:</span>
  <span class="c1">#refer to the slice components as &#39;clusters&#39;</span>

  <span class="c1">#positions is a list of the tile positions in each slice</span>
  <span class="c1">#positions[slice, tile] is a ndim array of the tile position in slice s</span>
  <span class="c1">#positions of non-existent tiles are set to [npinf] * ndim</span>
  
  <span class="c1">#components is a list of lists indicating the clusters in each slice</span>
  <span class="c1">#components[slice] = [cluster1, cluster2, ...]</span>
  <span class="c1">#each cluster is a list of tile ids. tiles not in a slice are not listed.</span>
  
  <span class="c1">#Optimization:</span>
  <span class="c1">#minimize displacements of all sources between the slices</span>
  <span class="n">n_slices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">);</span>
  <span class="n">ndim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]);</span>
  
  <span class="c1">#compute connected components of the clusters</span>
  <span class="n">cluster_components</span><span class="p">,</span> <span class="n">si_to_c</span><span class="p">,</span> <span class="n">c_to_si</span> <span class="o">=</span> <span class="n">_cluster_components</span><span class="p">(</span><span class="n">components</span><span class="p">);</span>                                                                                                               
  <span class="c1">#cluster_components is a list of lists of ints indicating the cluster ids</span>
  <span class="c1">#that belong to the connected compoenents of the clusters</span>
  <span class="c1">#cluster_components[0] = [c1, c2, ...] with cluster ids c1,c2,...</span>
  <span class="c1">#print cluster_components   </span>
  <span class="n">n_components</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_components</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Placement: found </span><span class="si">%d</span><span class="s1"> components to optimize!&#39;</span> <span class="o">%</span> <span class="n">n_components</span><span class="p">);</span>
  
  <span class="c1">#optimize positions for each cluster component</span>
  <span class="k">for</span> <span class="n">cci</span><span class="p">,</span> <span class="n">cluster_component</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_components</span><span class="p">):</span>
    <span class="c1">#Error functon:</span>
    <span class="c1"># E = \sum_s \sum_{i \in C_s} \sum_{j \in C_{s+1}} \sum_{k\in C_{s,i} \cup C_{s+1,j}} (x_{s,k} + s_{s,i} - (x_{s+1,k} + s_{s+1,j}))^2</span>
    <span class="c1"># x_{s,k} is the position of the k-th tile in the s-th slice</span>
    <span class="c1"># s_{s,i} is the shift of the i-th cluster C_{s,i} in slice s</span>
    <span class="c1"># C_s is the set of clusters in slice s</span>
    <span class="c1"># s0 = argmin_s(|C_s|&gt;0), i0 = argmin(C_\bar{s}) is the first cluster</span>
    <span class="c1"># s_{s0,i0} = 0 is fixed as the overall shift is arbitrary otherwise.</span>
    
    <span class="c1"># derivative of error gives constraints x - M s == 0</span>
    <span class="c1"># and cluster shifts are given as the pseudo inverse: s = M^\dagger x</span>
    
    <span class="c1">#Notation: </span>
    <span class="c1"># slice indices: t = s+1, r = s-1</span>
    <span class="c1"># C_{s,i} has an id c, c_to_si and si_to_c convert between s,i and c</span>
    <span class="c1"># The clusters in this connected component of clusters are enumerated by d</span>
    <span class="c1"># starting at the second cluster as the first cluster&#39;s shift is fixed</span>
    <span class="c1"># d_to_si, si_to_d convert between them.</span>
    
    <span class="n">n_clusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_component</span><span class="p">);</span>
    <span class="n">n_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_clusters</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="c1"># first s == 0</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Placement: optimizing component </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> with </span><span class="si">%d</span><span class="s1"> clusters!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cci</span><span class="p">,</span> <span class="n">n_components</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">));</span>
                 
     
    <span class="c1">#construct map : slice -&gt; cluster ids</span>
    <span class="n">slice_to_cluster_ids</span> <span class="o">=</span> <span class="p">[()]</span> <span class="o">*</span> <span class="n">n_slices</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cluster_component</span><span class="p">:</span>
       <span class="n">s</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">c_to_si</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>                  
       <span class="n">slice_to_cluster_ids</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">i</span><span class="p">,);</span>
    
    
    <span class="c1">#construct generic id d to si maps</span>
    <span class="n">si_to_d</span> <span class="o">=</span> <span class="p">{};</span> 
    <span class="n">d_to_si</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="k">for</span> <span class="n">d</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_component</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
      <span class="n">s</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">c_to_si</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="n">si_to_d</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
      <span class="n">d_to_si</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
    
    <span class="n">s0</span><span class="p">,</span><span class="n">i0</span> <span class="o">=</span> <span class="n">c_to_si</span><span class="p">(</span><span class="n">cluster_component</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>     
    
    
    <span class="c1"># construct x, M</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">sma</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_s</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)];</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">sma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_s</span><span class="p">,</span> <span class="n">n_s</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)];</span>
    <span class="k">for</span> <span class="n">ci</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cluster_component</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span> 
      <span class="c1">#if verbose and ci % 100 == 0:</span>
      <span class="c1">#  print(&#39;Placement: constructing constraints %d/%d!&#39; % (ci, n_clusters))</span>
      
      <span class="n">s</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">c_to_si</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="n">C_si</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">d</span> <span class="o">=</span> <span class="n">si_to_d</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)];</span>
      <span class="c1">#print s,i,C_si,d</span>
      
      <span class="c1">#if s &lt; n_slices - 1:</span>
      <span class="c1">#for c2 in cluster_component:</span>
      <span class="n">t</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">n_slices</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">slice_to_cluster_ids</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span>
          <span class="n">C_tj</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
          <span class="n">is_first</span> <span class="o">=</span> <span class="n">s0</span> <span class="o">==</span> <span class="n">t</span> <span class="ow">and</span> <span class="n">i0</span> <span class="o">==</span> <span class="n">j</span><span class="p">;</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">si_to_d</span><span class="p">[(</span><span class="n">t</span><span class="p">,</span><span class="n">j</span><span class="p">)];</span>
            <span class="c1">#print t,j,C_tj,is_first,f</span>
          <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">C_si</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">C_tj</span><span class="p">:</span>
              <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
                <span class="n">X</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="n">d</span><span class="p">]</span> <span class="o">+=</span> <span class="n">positions</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">e</span><span class="p">]</span> <span class="o">-</span> <span class="n">positions</span><span class="p">[</span><span class="n">t</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">e</span><span class="p">];</span>
                <span class="n">M</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="n">d</span><span class="p">,</span><span class="n">d</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
                  <span class="n">M</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="n">d</span><span class="p">,</span><span class="n">f</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
      
      <span class="n">r</span> <span class="o">=</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">if</span> <span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">slice_to_cluster_ids</span><span class="p">[</span><span class="n">r</span><span class="p">]:</span>  
          <span class="n">C_rj</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
          <span class="n">is_first</span> <span class="o">=</span> <span class="n">s0</span> <span class="o">==</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">i0</span> <span class="o">==</span> <span class="n">j</span><span class="p">;</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">si_to_d</span><span class="p">[(</span><span class="n">r</span><span class="p">,</span><span class="n">j</span><span class="p">)];</span>
          <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">C_si</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">C_rj</span><span class="p">:</span>
              <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
                <span class="n">X</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="n">d</span><span class="p">]</span> <span class="o">-=</span> <span class="n">positions</span><span class="p">[</span><span class="n">r</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">e</span><span class="p">]</span> <span class="o">-</span> <span class="n">positions</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">e</span><span class="p">];</span>
                <span class="n">M</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="n">d</span><span class="p">,</span><span class="n">d</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_first</span><span class="p">:</span>
                  <span class="n">M</span><span class="p">[</span><span class="n">e</span><span class="p">][</span><span class="n">d</span><span class="p">,</span><span class="n">f</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Placement: done constructing constraints for component </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cci</span><span class="p">,</span> <span class="n">n_components</span><span class="p">))</span>
    <span class="c1"># find the shifts of the clusters via pseudo inverse</span>
    <span class="c1">#print X</span>
    <span class="c1">#print M</span>
    <span class="c1">#print np.linalg.pinv(-M)</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
      <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">sma</span><span class="o">.</span><span class="n">smm</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">M</span><span class="p">];</span>
      <span class="n">X</span> <span class="o">=</span> <span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">sma</span><span class="o">.</span><span class="n">smm</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">X</span><span class="p">];</span>           
      <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span> <span class="k">as</span> <span class="n">executer</span><span class="p">:</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="n">executer</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_optimize_shifts</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">X</span><span class="p">);</span>
      <span class="n">shifts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">shifts</span><span class="p">);</span>
      <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">shifts</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="o">-</span><span class="n">M</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">X</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)];</span>
      <span class="n">shifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">shifts</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">;</span>
    
    <span class="c1">#update positions of the tiles</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cluster_component</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
      <span class="n">s</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">c_to_si</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="n">C_si</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">d</span> <span class="o">=</span> <span class="n">si_to_d</span><span class="p">[(</span><span class="n">s</span><span class="p">,</span><span class="n">i</span><span class="p">)];</span>
      <span class="c1">#print s,i,d,C_si, shifts[d]</span>
      <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">C_si</span><span class="p">:</span>
        <span class="n">positions</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shifts</span><span class="p">[</span><span class="n">d</span><span class="p">];</span> 
                 
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Placement: component </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1"> optimized!&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cci</span><span class="p">,</span> <span class="n">n_components</span><span class="p">))</span>             
  
  
  <span class="c1">#note overall shifts between components is not touched but might be based on</span>
  <span class="c1">#keeping ovrall distance.</span>
  <span class="k">return</span> <span class="n">positions</span><span class="p">;</span>


<span class="k">def</span> <span class="nf">_optimize_shifts</span><span class="p">(</span><span class="n">MM</span><span class="p">,</span><span class="n">XX</span><span class="p">):</span>
  <span class="n">M</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">sma</span><span class="o">.</span><span class="n">smm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">MM</span><span class="p">);</span>
  <span class="n">X</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">sma</span><span class="o">.</span><span class="n">smm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">XX</span><span class="p">);</span>                  
  
  <span class="c1">#ss = np.dot(np.linalg.pinv(-M), X);</span>
  <span class="n">ss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="o">-</span><span class="n">M</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="c1">#ss = scipy.sparse.linalg.lsqr(-M, X)[0];</span>

  <span class="n">io</span><span class="o">.</span><span class="n">sma</span><span class="o">.</span><span class="n">smm</span><span class="o">.</span><span class="n">free</span><span class="p">(</span><span class="n">MM</span><span class="p">);</span>
  <span class="n">io</span><span class="o">.</span><span class="n">sma</span><span class="o">.</span><span class="n">smm</span><span class="o">.</span><span class="n">free</span><span class="p">(</span><span class="n">XX</span><span class="p">);</span>                     
  
  <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ss</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>


<span class="k">def</span> <span class="nf">_straighten_slice_positions</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">tile_positions</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Straighten the center tiles in each connected cluster component&quot;&quot;&quot;</span>
  
  <span class="c1">#The cluster components always split between different tiles </span>
  <span class="c1">#so we can straighten the center tile in each cluster compoenent.</span>
  
  <span class="n">n_slices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">);</span>
  
  <span class="c1">#compute connected components of the clusters</span>
  <span class="n">cluster_components</span><span class="p">,</span> <span class="n">si_to_c</span><span class="p">,</span> <span class="n">c_to_si</span> <span class="o">=</span> <span class="n">_cluster_components</span><span class="p">(</span><span class="n">components</span><span class="p">);</span>

  <span class="k">for</span> <span class="n">cluster_component</span> <span class="ow">in</span> <span class="n">cluster_components</span><span class="p">:</span>

    <span class="n">slice_ids</span> <span class="o">=</span> <span class="p">[];</span>    
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cluster_component</span><span class="p">:</span>
      <span class="n">s</span><span class="p">,</span><span class="n">i</span> <span class="o">=</span> <span class="n">c_to_si</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="k">if</span> <span class="n">s</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slice_ids</span><span class="p">:</span>
        <span class="n">slice_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
      
      <span class="n">C_si</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="n">tile_ids</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="n">tile_pos</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">C_si</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tile_ids</span><span class="p">:</span>
          <span class="n">tile_pos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tile_positions</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
          <span class="n">tile_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
    
    <span class="n">center_tile_position</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">_center_tile</span><span class="p">(</span><span class="n">tile_pos</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tile_pos</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">center_tile_position</span> <span class="o">==</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">center_tile</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="n">center_slice</span> <span class="o">=</span> <span class="n">slice_ids</span><span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">slice_ids</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">];</span> 
    <span class="n">center_position</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">center_slice</span><span class="p">,</span> <span class="n">center_tile</span><span class="p">];</span>
    
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">tile_ids</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_slices</span><span class="p">):</span>
        <span class="n">positions</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="n">center_position</span> <span class="o">-</span> <span class="n">positions</span><span class="p">[</span><span class="n">s</span><span class="p">,</span><span class="n">center_tile</span><span class="p">]</span>
  
  <span class="k">return</span> <span class="n">positions</span><span class="p">;</span>

    
<div class="viewcode-block" id="smooth_binary"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.smooth_binary">[docs]</a><span class="k">def</span> <span class="nf">smooth_binary</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Remove displacements smaller than a certain width.&quot;&quot;&quot;</span>
  <span class="n">width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">#width -&gt; range</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">width</span><span class="p">:</span>
    <span class="n">width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
  
  <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
  <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
  
  <span class="c1">#smooth open border</span>
  <span class="n">x</span><span class="p">[:</span><span class="n">width</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">[:</span><span class="n">width</span><span class="p">]);</span>
  <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="n">width</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="n">width</span><span class="p">:]);</span>       
         
  <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>         
    <span class="n">starts</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="n">w</span><span class="p">);</span>
    <span class="n">ends</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span>
        <span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">s</span><span class="p">];</span>
            
  <span class="k">return</span> <span class="n">x</span><span class="p">;</span></div>
  

<div class="viewcode-block" id="smooth_window"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.smooth_window">[docs]</a><span class="k">def</span> <span class="nf">smooth_window</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">window_length</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">window</span> <span class="o">=</span> <span class="s1">&#39;bartlett&#39;</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Convolutional smoothing filter&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">window_length</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">window_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="n">window</span><span class="p">:</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span> <span class="s1">&#39;hanning&#39;</span><span class="p">,</span> <span class="s1">&#39;hamming&#39;</span><span class="p">,</span> <span class="s1">&#39;bartlett&#39;</span><span class="p">,</span> <span class="s1">&#39;blackman&#39;</span><span class="p">];</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Window not in </span><span class="si">%r</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">windows</span><span class="p">);</span>
    <span class="k">if</span> <span class="n">window</span> <span class="o">==</span> <span class="s1">&#39;flat&#39;</span><span class="p">:</span> <span class="c1">#moving average</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_length</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">w</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">window</span><span class="p">)(</span><span class="n">window_length</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">/=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">();</span>
              
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="n">window_length</span><span class="p">,</span> <span class="n">window_length</span><span class="p">),</span> <span class="s1">&#39;edge&#39;</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)[</span><span class="n">window_length</span><span class="p">:</span><span class="o">-</span><span class="n">window_length</span><span class="p">];</span>
  
    <span class="n">y</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>                 
  
  <span class="k">if</span> <span class="n">binary</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">smooth_binary</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">binary</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="n">y</span><span class="p">;</span>                     </div>


<div class="viewcode-block" id="smooth_positions"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.smooth_positions">[docs]</a><span class="k">def</span> <span class="nf">smooth_positions</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Smooth positions in valid regions.&quot;&quot;&quot;</span>
  <span class="k">return</span> <span class="n">smooth_displacements</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">valids</span><span class="o">=</span><span class="n">valids</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">);</span></div>


<div class="viewcode-block" id="smooth_displacements"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.smooth_displacements">[docs]</a><span class="k">def</span> <span class="nf">smooth_displacements</span><span class="p">(</span><span class="n">displacements</span><span class="p">,</span> <span class="n">valids</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>   
  <span class="sd">&quot;&quot;&quot;Smooth displacements in valid regions.&quot;&quot;&quot;</span>
  <span class="n">displacements_smooth</span> <span class="o">=</span> <span class="n">displacements</span><span class="o">.</span><span class="n">copy</span><span class="p">();</span>
  <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">displacements_smooth</span><span class="p">;</span>
  
  <span class="c1">#find valid slices  </span>
  <span class="n">valids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">valids</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>
  <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">valids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">ends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">valids</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>   
                   
  <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;window&#39;</span><span class="p">:</span>
    <span class="n">smooth</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">smooth_window</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Smoothing method </span><span class="si">%r</span><span class="s1"> not valid!&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">);</span>
  
  <span class="c1">#smooth each interval</span>
  <span class="n">ndim</span> <span class="o">=</span> <span class="n">displacements</span><span class="o">.</span><span class="n">ndim</span><span class="p">;</span>
  <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
      <span class="n">smooth_displacements</span> <span class="o">=</span> <span class="n">smooth</span><span class="p">(</span><span class="n">displacements</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">,</span><span class="n">d</span><span class="p">]);</span>
      <span class="n">displacements_smooth</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">,</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">smooth_displacements</span><span class="p">;</span>
                   
  <span class="k">return</span> <span class="n">displacements_smooth</span><span class="p">;</span></div>



<div class="viewcode-block" id="fix_unaligned"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.fix_unaligned">[docs]</a><span class="k">def</span> <span class="nf">fix_unaligned</span><span class="p">(</span><span class="n">displacements</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">qualities</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Linearly interpolate between unaligned coordinates&quot;&quot;&quot;</span>
  <span class="n">n_status</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
  <span class="n">unaligned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">UNALIGNED</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  <span class="n">unaligned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">unaligned</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">);</span>                  
  <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">unaligned</span><span class="p">);</span>
  <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">ends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>                     
  
  <span class="c1">#whole stack is aligned</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">displacements</span><span class="p">,</span> <span class="n">status</span>           
  
  <span class="c1">#whole stack is unalinged</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">starts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ends</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ends</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_status</span><span class="p">:</span>
    <span class="n">status</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">INVALID</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">displacements</span><span class="p">,</span> <span class="n">status</span>           
                 
  <span class="c1">#find left and right bounds for isolated stretches</span>
  <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">):</span>
    <span class="c1">#find next valid  in each direction</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">VALID</span><span class="p">:</span>
      <span class="n">left</span> <span class="o">=</span> <span class="n">displacements</span><span class="p">[[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]];</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">left</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>                     
    <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">n_status</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">VALID</span><span class="p">:</span>                      
      <span class="n">right</span> <span class="o">=</span> <span class="n">displacements</span><span class="p">[[</span><span class="n">e</span><span class="p">]];</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">right</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">INVALID</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">displacements</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
        <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">qualities</span><span class="p">[</span><span class="n">e</span><span class="p">];</span>
      <span class="k">elif</span> <span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">displacements</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
        <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">else</span><span class="p">:</span> <span class="c1"># linearly interpolate</span>
        <span class="n">displacements</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">left</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>   
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">qe</span> <span class="o">=</span> <span class="n">qualities</span><span class="p">[</span><span class="n">e</span><span class="p">];</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">qe</span><span class="p">):</span>                       
          <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">qe</span> <span class="o">-</span> <span class="n">qs</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">qs</span><span class="p">;</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">qe</span><span class="p">):</span>
          <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">qe</span><span class="p">;</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">qualities</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">qs</span><span class="p">;</span>
      <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">FIXED</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">displacements</span><span class="p">,</span> <span class="n">status</span></div>

<span class="c1">#TODO: fix this clean up placement in total including status info</span>
<div class="viewcode-block" id="fix_isolated"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.fix_isolated">[docs]</a><span class="k">def</span> <span class="nf">fix_isolated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude_borders</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Fix the positons of isolated slices.&quot;&quot;&quot;</span>
  <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">;</span>
  <span class="n">wobble</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wobble</span><span class="p">;</span>
  <span class="n">n_status</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
  <span class="n">isolated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ISOLATED</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  <span class="n">isolated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">isolated</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;constant&#39;</span><span class="p">);</span>
  <span class="n">delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">isolated</span><span class="p">);</span>
  <span class="n">starts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">ends</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  
  <span class="c1">#whole stack has no isolated slices</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span>  
                 
  <span class="c1">#if whole stack is isolated</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">starts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">starts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ends</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">ends</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">n_status</span><span class="p">:</span>
    <span class="n">status</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ISOLATED</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>             
                 
  <span class="c1">#find left and right bounds for isolated stretches</span>
  <span class="k">for</span> <span class="n">s</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">starts</span><span class="p">,</span> <span class="n">ends</span><span class="p">):</span>
    <span class="c1">#exclude borders</span>
    <span class="k">if</span> <span class="n">exclude_borders</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">e</span> <span class="o">==</span> <span class="n">n_status</span><span class="p">:</span>
         <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ISOLATED</span><span class="p">;</span>
         <span class="k">continue</span><span class="p">;</span>
    
    <span class="c1">#find next valid  in each direction</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">:</span>
      <span class="n">left</span> <span class="o">=</span> <span class="n">wobble</span><span class="p">[[</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span><span class="p">]];</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">left</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>                     
    <span class="k">if</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">n_status</span> <span class="ow">and</span> <span class="n">status</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">VALID</span><span class="p">:</span>                      
      <span class="n">right</span> <span class="o">=</span> <span class="n">wobble</span><span class="p">[[</span><span class="n">e</span><span class="p">]];</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">right</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span>
    <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ISOLATED</span><span class="p">;</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wobble</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
      <span class="k">elif</span> <span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">wobble</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
      <span class="k">else</span><span class="p">:</span> <span class="c1"># linearly interpolate</span>
        <span class="n">wobble</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="o">-</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">left</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">int</span><span class="p">);</span>
      <span class="n">status</span><span class="p">[</span><span class="n">s</span><span class="p">:</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FIXED</span><span class="p">;</span></div>



<span class="c1">###############################################################################</span>
<span class="c1">### Stitching</span>
<span class="c1">###############################################################################</span>


<div class="viewcode-block" id="stitch_layout"><a class="viewcode-back" href="../../../../Api/ClearMap.Alignment.Stitching.StitchingWobbly.html#ClearMap.Alignment.Stitching.StitchingWobbly.stitch_layout">[docs]</a><span class="k">def</span> <span class="nf">stitch_layout</span><span class="p">(</span><span class="n">layout</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;interpolation&#39;</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Stitches the wobbly sources in a wobbly layout.</span>
<span class="sd">  </span>
<span class="sd">  Arguments</span>
<span class="sd">  ---------</span>
<span class="sd">  layout: WobblyLayout class</span>
<span class="sd">    The layout of the stacks to stitch.</span>
<span class="sd">  method : &#39;interpolation&#39;, &#39;max&#39;, &#39;min&#39;, &#39;mean&#39;</span>
<span class="sd">    The method to use to stitch the sources.  </span>
<span class="sd">  processes : int or &#39;serial&#39; </span>
<span class="sd">    Number of processor to use for parallel processing, if &#39;serial&#39; process in serial.</span>
<span class="sd">  verbose : bool </span>
<span class="sd">    If True, print progress information.</span>
<span class="sd">  </span>
<span class="sd">  Returns</span>
<span class="sd">  -------</span>
<span class="sd">  layout : Layout </span>
<span class="sd">    The layout with updated z-alignments.  </span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1">#if not isinstance(layout, WobblyLayout):</span>
  <span class="c1">#  raise ValueError(&#39;Expecting a WobblyLayout instance as first argument!&#39;);</span>
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stitching: stitching wobbly layout.&#39;</span><span class="p">);</span>
  
  <span class="c1">#overall shape</span>
  <span class="n">axis</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">axis</span><span class="p">;</span>
  <span class="n">origin</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">origin_wobbly</span><span class="p">;</span>
  <span class="n">shape</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">shape_wobbly</span><span class="p">;</span>
  <span class="c1">#print axis, origin, shape</span>
  
  <span class="c1"># create sink</span>
  <span class="c1">#TODO: make layout a sink ! use io.create</span>
  <span class="n">io</span><span class="o">.</span><span class="n">mmp</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">layout</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">layout</span><span class="o">.</span><span class="n">order</span><span class="p">);</span>
  <span class="c1">#print shape</span>
  
  <span class="c1">#create slices</span>
  <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="n">axis</span><span class="p">],</span> <span class="n">origin</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]);</span>
  <span class="n">layout_slices</span> <span class="o">=</span> <span class="n">layout</span><span class="o">.</span><span class="n">layouts_along_axis_wobbly</span><span class="p">(</span><span class="n">coordinates</span><span class="p">);</span>
  <span class="n">n_slices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">layout_slices</span><span class="p">);</span>
  <span class="c1">#print n_slices </span>
                
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span> <span class="o">=</span> <span class="n">tmr</span><span class="o">.</span><span class="n">Timer</span><span class="p">();</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stitching: stitching </span><span class="si">%d</span><span class="s1"> sliced layouts.&#39;</span> <span class="o">%</span> <span class="n">n_slices</span><span class="p">);</span>                
  
  <span class="c1">#sliced origin and shape</span>
  <span class="n">full_region</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">Region</span><span class="p">(</span><span class="n">position</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">origin</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:],</span> <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="o">+</span><span class="mi">1</span><span class="p">:])</span>                   
  
  <span class="n">_stitch</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_stitch_slice</span><span class="p">,</span> <span class="n">n_slices</span><span class="o">=</span><span class="n">n_slices</span><span class="p">,</span> <span class="n">sink</span><span class="o">=</span><span class="n">sink</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> 
                       <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">full_region</span><span class="o">=</span><span class="n">full_region</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">);</span>
               
  <span class="c1">#stitch the data</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processes</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">processes</span> <span class="o">!=</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="n">processes</span> <span class="o">=</span> <span class="n">mp</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">();</span>
  
  <span class="k">if</span> <span class="n">processes</span> <span class="o">==</span> <span class="s1">&#39;serial&#39;</span><span class="p">:</span>
    <span class="p">[</span><span class="n">_stitch</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layout_slices</span><span class="p">)];</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1">#for l in layout_slices:</span>
    <span class="c1">#  l.sources_as_virtual();</span>
    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
      <span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_stitch</span><span class="p">,</span> <span class="n">layout_slices</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_slices</span><span class="p">));</span>
    
  
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="n">timer</span><span class="o">.</span><span class="n">print_elapsed_time</span><span class="p">(</span><span class="s1">&#39;Stitching: stitching wobbly layout done!&#39;</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">sink</span><span class="p">;</span></div>


<span class="nd">@ptb</span><span class="o">.</span><span class="n">parallel_traceback</span>
<span class="k">def</span> <span class="nf">_stitch_slice</span><span class="p">(</span><span class="n">slice_layout</span><span class="p">,</span> <span class="n">slice_id</span><span class="p">,</span> <span class="n">n_slices</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="n">full_region</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stitching: stitching wobbly slice </span><span class="si">%d</span><span class="s1">/</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">slice_id</span><span class="p">,</span> <span class="n">n_slices</span><span class="p">));</span>
  
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">slice_layout</span><span class="o">.</span><span class="n">sources</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">return</span><span class="p">;</span>
  
  <span class="c1">#sliicings</span>
  <span class="n">slice_region</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">Region</span><span class="p">(</span><span class="n">lower</span> <span class="o">=</span> <span class="n">slice_layout</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">slice_layout</span><span class="o">.</span><span class="n">upper</span><span class="p">);</span>
  <span class="c1">#print slice_region, full_region                          </span>
                          
  <span class="n">overlap</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">_overlap</span><span class="p">(</span><span class="n">slice_region</span><span class="p">,</span> <span class="n">full_region</span><span class="p">);</span>
  <span class="k">if</span> <span class="n">overlap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="c1">#print overlap</span>
  
  <span class="n">overlap</span><span class="o">.</span><span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="n">slice_region</span><span class="p">,</span> <span class="n">full_region</span><span class="p">];</span>
  <span class="n">slice_slicing</span><span class="p">,</span> <span class="n">full_slicing</span> <span class="o">=</span> <span class="n">overlap</span><span class="o">.</span><span class="n">source_slicings</span><span class="p">();</span>
  <span class="n">full_slicing</span> <span class="o">=</span> <span class="n">full_slicing</span><span class="p">[:</span><span class="n">axis</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">slice_id</span><span class="p">,)</span> <span class="o">+</span> <span class="n">full_slicing</span><span class="p">[</span><span class="n">axis</span><span class="p">:];</span>
  <span class="c1">#print slice_slicing, full_slicing</span>
                             
  <span class="c1">#stitch</span>
  <span class="n">stitched</span> <span class="o">=</span> <span class="n">strg</span><span class="o">.</span><span class="n">stitch_layout</span><span class="p">(</span><span class="n">slice_layout</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">);</span>
  
  <span class="c1">#write to sink</span>
  <span class="n">io</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">stitched</span><span class="p">[</span><span class="n">slice_slicing</span><span class="p">],</span> <span class="n">slicing</span> <span class="o">=</span> <span class="n">full_slicing</span><span class="p">);</span>
  

<span class="c1">#############################################################################################################</span>
<span class="c1">### Tests</span>
<span class="c1">#############################################################################################################</span>

<span class="k">def</span> <span class="nf">_test</span><span class="p">():</span>
  <span class="kn">import</span> <span class="nn">ClearMap.Alignment.Stitching.StitchingWobbly</span> <span class="k">as</span> <span class="nn">stw</span>
  
  <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="p">);</span>
  
  <span class="c1">#create some wobbly tiles</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="kn">import</span> <span class="nn">ClearMap.Tests.Files</span> <span class="k">as</span> <span class="nn">tfs</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tfs</span><span class="o">.</span><span class="n">vasculature_pre</span><span class="p">)[:,:</span><span class="mi">100</span><span class="p">,:</span><span class="mi">100</span><span class="p">];</span>
  
  <span class="c1">#linear wobble</span>
  <span class="n">nz</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="n">data1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">120</span><span class="p">,:,:</span><span class="n">nz</span><span class="p">]</span>
  <span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">);</span>
  <span class="n">wobble</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">s</span><span class="p">;</span>
    <span class="n">data2</span><span class="p">[:,:,</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">100</span><span class="o">+</span><span class="n">x</span><span class="p">:</span><span class="mi">200</span><span class="o">+</span><span class="n">x</span><span class="p">,:,</span><span class="n">s</span><span class="p">]</span>
    <span class="n">wobble</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
  <span class="n">wobble</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wobble</span><span class="p">);</span>
  
  <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
  
  <span class="n">l</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">WobblyLayout</span><span class="p">([</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">],</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="mi">20</span><span class="p">);</span>
  <span class="n">stw</span><span class="o">.</span><span class="n">align_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;serial&#39;</span><span class="p">,</span> <span class="n">validate</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">find_shifts</span> <span class="o">=</span> <span class="s1">&#39;tracing&#39;</span><span class="p">)</span>
  
  <span class="n">a</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">a</span><span class="o">.</span><span class="n">plot_overlay_wobbly</span><span class="p">()</span>                  
  
  <span class="n">stw</span><span class="o">.</span><span class="n">place_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;!optimization&#39;</span><span class="p">,</span> <span class="n">smooth</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">lower_to_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;serial&#39;</span><span class="p">)</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">stitch_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="s1">&#39;test.npy&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;serial&#39;</span><span class="p">)</span>
  
  <span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  
  <span class="c1">#true if not optimized</span>
  <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">stw</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">as_source</span><span class="p">(</span><span class="n">s</span><span class="p">)[:</span><span class="mi">190</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[:</span><span class="mi">190</span><span class="p">,:,:</span><span class="n">nz</span><span class="p">])</span>
  
  
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
  
  <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">100</span> <span class="o">==</span> <span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
  
  <span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="o">.</span><span class="n">p3d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  
  
  <span class="c1">#Sin wobble</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="kn">import</span> <span class="nn">ClearMap.Tests.Files</span> <span class="k">as</span> <span class="nn">tfs</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tfs</span><span class="o">.</span><span class="n">vasculature_pre</span><span class="p">)[:,:</span><span class="mi">100</span><span class="p">,:</span><span class="mi">100</span><span class="p">];</span>
  
  <span class="n">nz</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
  <span class="n">data1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">120</span><span class="p">,:,:</span><span class="n">nz</span><span class="p">]</span>
  <span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">);</span>
  <span class="n">wobble</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">30</span><span class="p">));</span>
    <span class="n">data2</span><span class="p">[:,:,</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">100</span><span class="o">+</span><span class="n">x</span><span class="p">:</span><span class="mi">200</span><span class="o">+</span><span class="n">x</span><span class="p">,:,</span><span class="n">s</span><span class="p">]</span>
    <span class="n">wobble</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
  <span class="n">wobble</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wobble</span><span class="p">);</span>
  
  <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>

  
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="p">)</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="p">)</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">WobblyLayout</span><span class="p">([</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">],</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="mi">20</span><span class="p">);</span>
  <span class="n">stw</span><span class="o">.</span><span class="n">align_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;serial&#39;</span><span class="p">,</span> <span class="n">validate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
  
  <span class="n">stw</span><span class="o">.</span><span class="n">place_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;!optimization&#39;</span><span class="p">,</span>  <span class="n">lower_to_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">smooth</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;serial&#39;</span><span class="p">)</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">stitch_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="s1">&#39;test.npy&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;serial&#39;</span><span class="p">)</span>
  
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
  
  
  <span class="c1">#True for non-optimized plaements</span>
  <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">stw</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">as_source</span><span class="p">(</span><span class="n">s</span><span class="p">)[:</span><span class="mi">190</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[:</span><span class="mi">190</span><span class="p">,:,:</span><span class="n">nz</span><span class="p">])</span>
  
  
  <span class="c1"># wobble + axis alignment</span>
  <span class="kn">import</span> <span class="nn">ClearMap.Alignment.StitchingWobbly</span> <span class="k">as</span> <span class="nn">stw</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="p">)</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="p">)</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="kn">import</span> <span class="nn">ClearMap.Tests.Files</span> <span class="k">as</span> <span class="nn">tfs</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tfs</span><span class="o">.</span><span class="n">vasculature_pre</span><span class="p">)[:,:</span><span class="mi">100</span><span class="p">,:</span><span class="mi">100</span><span class="p">];</span>
  
  <span class="n">nz</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span> <span class="n">sh</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="n">data1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">120</span><span class="p">,:,:</span><span class="n">nz</span><span class="p">]</span>
  <span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">);</span>
  <span class="n">wobble</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">30</span><span class="p">));</span>
    <span class="n">data2</span><span class="p">[:,:,</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">100</span><span class="o">+</span><span class="n">x</span><span class="p">:</span><span class="mi">200</span><span class="o">+</span><span class="n">x</span><span class="p">,:,</span><span class="n">s</span><span class="o">+</span><span class="n">sh</span><span class="p">]</span>
    <span class="n">wobble</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
  <span class="n">wobble</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wobble</span><span class="p">);</span>
  
  <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
  
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="p">)</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="p">)</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">WobblyLayout</span><span class="p">([</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">],</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="mi">20</span><span class="p">);</span>

  <span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="o">.</span><span class="n">align_layout_axis</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">max_shifts</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">l</span><span class="o">.</span><span class="n">alignments</span>
 
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
  <span class="n">l</span><span class="o">.</span><span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_mip</span><span class="p">(</span><span class="n">depth</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">),(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">),(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">)])</span>
  
  <span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="o">.</span><span class="n">place_layout_axis</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;optimization&#39;</span><span class="p">,</span> <span class="n">min_quality</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">lower_to_origin</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
  <span class="n">l</span><span class="o">.</span><span class="n">sources</span>

  <span class="n">stw</span><span class="o">.</span><span class="n">align_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;!serial&#39;</span><span class="p">,</span> <span class="n">validate</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">axis_range</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="n">a</span><span class="o">.</span><span class="n">plot_overlay_wobbly</span><span class="p">()</span>                  
  
  
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">displacements</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            
  <span class="n">stw</span><span class="o">.</span><span class="n">place_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;optimization&#39;</span><span class="p">,</span>  <span class="n">lower_to_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">smooth</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">min_quality</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;!serial&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">stitch_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="s1">&#39;test.npy&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;serial&#39;</span><span class="p">)</span>
  
  <span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="o">.</span><span class="n">dv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  
  <span class="c1">#True for non-optimized plaements</span>
  <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">stw</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">as_source</span><span class="p">(</span><span class="n">s</span><span class="p">)[:</span><span class="mi">190</span><span class="p">,:,</span><span class="n">sh</span><span class="p">:</span><span class="n">nz</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[:</span><span class="mi">190</span><span class="p">,:,</span><span class="n">sh</span><span class="p">:</span><span class="n">nz</span><span class="p">])</span>
    
  
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
  
  
  
  <span class="c1"># wobble + axis alignment + status</span>
  <span class="kn">import</span> <span class="nn">ClearMap.Alignment.StitchingWobbly</span> <span class="k">as</span> <span class="nn">stw</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="p">)</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="p">)</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="kn">import</span> <span class="nn">ClearMap.Tests.Files</span> <span class="k">as</span> <span class="nn">tfs</span>
  <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">tfs</span><span class="o">.</span><span class="n">vasculature_pre</span><span class="p">)[:,:</span><span class="mi">100</span><span class="p">,:</span><span class="mi">100</span><span class="p">];</span>
  
  <span class="n">nz</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="n">sh</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="n">data1</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="mi">120</span><span class="p">,:,:</span><span class="n">nz</span><span class="p">]</span>
  <span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="n">nz</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="p">);</span>
  <span class="n">wobble</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="o">+</span><span class="n">sh</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">);</span>
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nz</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">40</span><span class="p">));</span>
    <span class="n">data2</span><span class="p">[:,:,</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">100</span><span class="o">+</span><span class="n">x</span><span class="p">:</span><span class="mi">200</span><span class="o">+</span><span class="n">x</span><span class="p">,:,</span><span class="n">s</span><span class="o">+</span><span class="n">sh</span><span class="p">]</span>
    <span class="n">wobble</span><span class="p">[</span><span class="n">s</span><span class="o">+</span><span class="n">sh</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
  
  <span class="n">invalid</span> <span class="o">=</span> <span class="p">[</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">47</span><span class="p">,</span><span class="mi">48</span><span class="p">,</span><span class="mi">49</span><span class="p">];</span>                   
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">invalid</span><span class="p">:</span>
    <span class="n">data2</span><span class="p">[:,:,</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                  
                   
                   
  <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">invalid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">invalid</span><span class="p">)),</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
  
  
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="p">)</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="p">)</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">WobblyLayout</span><span class="p">([</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">],</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="mi">20</span><span class="p">);</span> <span class="n">l</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">sh</span><span class="p">);</span>
  
  <span class="k">def</span> <span class="nf">plot_status</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">smooth_displacements</span><span class="p">(</span><span class="n">min_quality</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s1">&#39;bartlett&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> 
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">fig</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>               
    <span class="n">ax</span> <span class="o">=</span>  <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>        
    <span class="n">arange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">lower_coordinate</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">upper_coordinate</span><span class="p">);</span>                     
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(([</span><span class="n">a</span><span class="o">.</span><span class="n">status</span><span class="p">],</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">qualities</span><span class="p">],</span> <span class="p">[</span><span class="n">wobble</span><span class="p">[</span><span class="n">arange</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="o">.</span><span class="n">shifts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sm</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">wobble</span><span class="p">[</span><span class="n">arange</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="o">.</span><span class="n">shifts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">sm</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])):</span>
      <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span> <span class="o">=</span> <span class="n">ax</span><span class="p">);</span>
      <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>             
        <span class="c1">#plt.plot(arange, dd)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>                 
                      
                      
  <span class="n">stw</span><span class="o">.</span><span class="n">_validate</span><span class="p">(</span><span class="n">data2</span><span class="p">[:,:,</span><span class="mi">13</span><span class="p">],</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;foreground&#39;</span><span class="p">,</span> <span class="n">valid_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="p">)</span>           
   
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="p">)</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="p">)</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">WobblyLayout</span><span class="p">([</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">],</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="mi">20</span><span class="p">);</span> <span class="n">l</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">sh</span><span class="p">);</span>
  
  <span class="n">stw</span><span class="o">.</span><span class="n">align_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>  <span class="n">axis_range</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis_mip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                   <span class="n">validate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">prepare</span> <span class="o">=</span> <span class="s1">&#39;normalization&#39;</span><span class="p">,</span>
                   <span class="n">validate_slice</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;foreground&#39;</span><span class="p">,</span> <span class="n">valid_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">),</span>
                   <span class="n">find_shifts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;tracing&#39;</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">3</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span><span class="p">),</span>
                   <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;serial&#39;</span><span class="p">)</span>

  <span class="n">a</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>          
  <span class="n">plot_status</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
  <span class="n">a</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">WobblyAlignment</span><span class="o">.</span><span class="n">UNALIGNED</span>
  <span class="n">a</span><span class="o">.</span><span class="n">fix_unaligned</span><span class="p">()</span>               
  <span class="n">plot_status</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

  
  <span class="n">a</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>     
  <span class="n">results</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">align_wobbly_axis</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">pre</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">post</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>  <span class="n">axis_range</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis_mip</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">validate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="n">prepare</span> <span class="o">=</span> <span class="s1">&#39;normalization&#39;</span><span class="p">,</span>
                                  <span class="n">validate_slice</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;foreground&#39;</span><span class="p">,</span> <span class="n">valid_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">),</span>
                                  <span class="n">find_shifts</span> <span class="o">=</span> <span class="s1">&#39;minimization&#39;</span><span class="p">,</span>
                                  <span class="n">with_errors</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">with_overlaps</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
  <span class="n">shifts</span><span class="p">,</span> <span class="n">qualities</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">ovlps</span> <span class="o">=</span> <span class="n">results</span><span class="p">;</span>
  <span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="o">.</span><span class="n">dv</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">errors</span><span class="o">.</span><span class="n">transpose</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]),)</span> <span class="o">+</span> <span class="n">ovlps</span><span class="p">)</span>
           
  <span class="n">a</span><span class="o">.</span><span class="n">plot_overlay_wobbly</span><span class="p">()</span>                  
  
           
  <span class="n">stw</span><span class="o">.</span><span class="n">place_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;!optimization&#39;</span><span class="p">,</span>  <span class="n">lower_to_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_quality</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> 
                   <span class="n">smooth</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">smooth_optimized</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;!serial&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

  <span class="c1">#plot the positions of the stacks</span>
  <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>   <span class="c1">#analysis:ignore</span>
  <span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span> <span class="c1">#analysis:ignore</span>
  <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
  <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
  <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span> 
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">coordinate</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span><span class="p">))</span>    
  <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Source positions&#39;</span><span class="p">)</span>


  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>            
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">sources</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


  <span class="c1">#non alignable planes</span>
  <span class="n">flat</span> <span class="o">=</span> <span class="p">[</span><span class="mi">28</span><span class="p">,</span><span class="mi">29</span><span class="p">,</span><span class="mi">30</span><span class="p">];</span>                   
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">flat</span><span class="p">:</span>
    <span class="n">data1</span><span class="p">[:,:,</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">data2</span><span class="p">[:,:,</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>                  
                   
  <span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="o">.</span><span class="n">dv</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">data1</span><span class="p">[:,:,</span><span class="n">sh</span><span class="p">:],</span> <span class="n">data2</span><span class="p">[:,:,:</span><span class="o">-</span><span class="n">sh</span><span class="p">]])</span>
  
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="p">)</span>
  <span class="n">reload</span><span class="p">(</span><span class="n">stw</span><span class="p">)</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">WobblyLayout</span><span class="p">([</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">],</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="mi">20</span><span class="p">);</span> <span class="n">l</span><span class="o">.</span><span class="n">sources</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">sh</span><span class="p">);</span>
  
  <span class="n">stw</span><span class="o">.</span><span class="n">align_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">max_shifts</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>  <span class="n">axis_range</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                   <span class="n">validate</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">prepare</span> <span class="o">=</span> <span class="s1">&#39;normalization&#39;</span><span class="p">,</span>
                   <span class="n">validate_slice</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;foreground&#39;</span><span class="p">,</span> <span class="n">valid_range</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="kc">None</span><span class="p">),</span>
                   <span class="n">find_shifts</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;tracing&#39;</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">3</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span><span class="p">),</span>
                   <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;serial&#39;</span><span class="p">)</span>
  <span class="n">stw</span><span class="o">.</span><span class="n">place_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;!optimization&#39;</span><span class="p">,</span>  <span class="n">lower_to_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_quality</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> 
                   <span class="n">smooth</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">smooth_optimized</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">binary</span> <span class="o">=</span> <span class="mi">2</span><span class="p">),</span>
                   <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;!serial&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

  <span class="n">s</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">stitch_layout</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="s1">&#39;test.npy&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="s1">&#39;serial&#39;</span><span class="p">)</span>
  
  <span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="o">.</span><span class="n">dv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  
  <span class="c1">#True for non-optimized plaements</span>
  <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">stw</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">as_source</span><span class="p">(</span><span class="n">s</span><span class="p">)[:</span><span class="mi">190</span><span class="p">,:,</span><span class="n">sh</span><span class="p">:</span><span class="n">nz</span><span class="p">]</span> <span class="o">==</span> <span class="n">data</span><span class="p">[:</span><span class="mi">190</span><span class="p">,:,</span><span class="n">sh</span><span class="p">:</span><span class="n">nz</span><span class="p">])</span>
    
  
  <span class="n">s</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">slice_along_axis_wobbly</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
  <span class="n">t</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="o">.</span><span class="n">stitch_layout</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sink</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span><span class="p">)</span>
  <span class="n">stw</span><span class="o">.</span><span class="n">strg</span><span class="o">.</span><span class="n">dv</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span>  
  
  <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">();</span>
  <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">sources</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">coordinate</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">coordinate</span> <span class="o">+</span> <span class="n">s</span><span class="o">.</span><span class="n">height</span><span class="p">),</span> <span class="n">s</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
  <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">wobble</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
  
  
  
  <span class="c1">#TODO: min_overlap parameter in alignment to avoid boundary effects</span>
  <span class="c1">#TODO: option to reduce the shape of the overlaps used for alingment to speed things up</span>
  
  
  <span class="c1">### Test on real data</span>
  <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
  <span class="kn">import</span> <span class="nn">ClearMap.IO.IO</span> <span class="k">as</span> <span class="nn">io</span>
  <span class="kn">import</span> <span class="nn">ClearMap.Alignment.Stitching.StitchingRigid</span> <span class="k">as</span> <span class="nn">stg</span>
  <span class="kn">import</span> <span class="nn">ClearMap.Alignment.Stitching.StitchingWobbly</span> <span class="k">as</span> <span class="nn">stw</span>
  <span class="kn">import</span> <span class="nn">ClearMap.IO.Workspace</span> <span class="k">as</span> <span class="nn">wsp</span>
  
  <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;/home/ckirst/Science/Projects/WholeBrainClearing/Vasculature/Experiment/Stitching_2018_06&#39;</span>
  <span class="n">expression</span> <span class="o">=</span> <span class="s1">&#39;tiny_[&lt;Y,2&gt; x &lt;X,2&gt;]_C00.ome.npy&#39;</span>
  <span class="n">ws</span> <span class="o">=</span> <span class="n">wsp</span><span class="o">.</span><span class="n">Workspace</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span><span class="p">,</span> <span class="n">expression</span><span class="o">=</span><span class="n">expression</span><span class="p">);</span> 
  <span class="n">io</span><span class="o">.</span><span class="n">file_list</span><span class="p">(</span><span class="n">ws</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="s1">&#39;expression&#39;</span><span class="p">))</span>
  
  <span class="n">l</span> <span class="o">=</span> <span class="n">stw</span><span class="o">.</span><span class="n">WobblyLayout</span><span class="p">(</span><span class="n">expression</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="s1">&#39;expression&#39;</span><span class="p">),</span> <span class="n">tile_axes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">155</span><span class="p">));</span>  
  
  <span class="c1"># rigid alignment</span>
  <span class="n">lr</span> <span class="o">=</span> <span class="n">stg</span><span class="o">.</span><span class="n">TiledLayout</span><span class="p">(</span><span class="n">expression</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">filename</span><span class="p">(</span><span class="s1">&#39;expression&#39;</span><span class="p">),</span> <span class="n">tile_axes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">],</span> <span class="n">overlaps</span> <span class="o">=</span> <span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="mi">155</span><span class="p">));</span>  
  <span class="n">lr</span><span class="o">.</span><span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_overlap</span><span class="p">()</span>
  
  <span class="n">stg</span><span class="o">.</span><span class="n">align_layout_rigid_mip</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="p">[</span><span class="mi">55</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">max_shifts</span><span class="o">=</span><span class="p">[(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">),(</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">30</span><span class="p">),(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">)],</span>
                             <span class="n">ranges</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">],</span> <span class="n">background</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">clip</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span> 
                             <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="s1">&#39;!serial&#39;</span><span class="p">)</span>
  <span class="n">lr</span><span class="o">.</span><span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_overlay</span><span class="p">()</span>
  
  <span class="n">stg</span><span class="o">.</span><span class="n">place_layout</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;optimization&#39;</span><span class="p">,</span> <span class="n">min_quality</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">lower_to_origin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
  <span class="n">lr</span><span class="o">.</span><span class="n">alignments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot_overlay</span><span class="p">()</span>
  <span class="c1"># plot result</span>
  
  <span class="n">lr</span><span class="o">.</span><span class="n">plot_alignments</span><span class="p">();</span>
</pre></div>
 <!-- body -->
    </div> <!-- body -->
    </div> <!-- bodywrapper -->
    

     
  <!-- mainrow --></div>
<!-- document --></div>
<div class="document" style="background-color: #ffffff; text-align: left; padding: 5px 0px 5px 0px">
<p align="center">
<a href="../../../../overview.html"><img src="../../../../_static/ClearMap_banner.jpg" height=150px width=150% border="0" alt="ClearMap"/></a>
</p>
</div>

    <div class="footer" role="contentinfo">
        &#169; Copyright Copyright Â© 2020 by Christoph Kirst.
    </div>
  </body>
</html>